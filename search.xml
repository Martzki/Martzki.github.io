<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hello World</title>
    <url>/2022/01/31/Hello-World/</url>
    <content><![CDATA[<h1 id="About-Hello-World"><a href="#About-Hello-World" class="headerlink" title="About Hello World"></a>About Hello World</h1><ul>
<li>Hello Worldå¾€å¾€ä½œä¸ºå¾ˆå¤šé¡¹ç›®çš„åˆå§‹ç¤ºä¾‹ç¨‹åºï¼Œæˆ‘ä¸ªäººæŠŠHello Worldè§†ä¸ºç¨‹åºå‘˜å¯¹å¾…â€œæœ€åˆâ€çš„å“²å­¦ï¼Œæ‰€ä»¥æŠŠå®ƒä½œä¸ºè¿™ä¸ªåšå®¢çš„ç¬¬ä¸€ç¯‡åšæ–‡çš„æ ‡é¢˜ï¼Œç”¨äºç»™è¿™ä¸ªåšå®¢å¼€ä¸ªå¤´ï¼ˆç»ˆäºèµ¶åœ¨è¿‡å¹´å‰å†™å‡ºæ¥äº†ï¼‰ã€‚<span id="more"></span></li>
</ul>
<h1 id="About-Lost-Stars"><a href="#About-Lost-Stars" class="headerlink" title="About Lost Stars"></a>About Lost Stars</h1><ul>
<li>Lost Starsæ˜¯æˆ‘ä¸ªäººæœ€å–œæ¬¢çš„Maroon 5çš„ä¸€é¦–æ­Œï¼Œæ­Œè¯ä¸­è¡¨ç°äº†å’Œâ€œå¯„èœ‰è£äºå¤©åœ°ï¼Œæ¸ºæ²§æµ·ä¹‹ä¸€ç²Ÿâ€æœ‰ç€å¼‚æ›²åŒå·¥ä¹‹å¦™çš„å¯¹ä¸ªä½“çš„æ¸ºå°ä¹‹æ„Ÿå¹ï¼Œå’Œæˆ‘ä¸ªäººç›®å‰çš„äººç”ŸçŠ¶æ€è¾ƒä¸ºå¥‘åˆï¼Œæ‰€ä»¥æŠŠå®ƒä½œä¸ºè¿™ä¸ªåšå®¢çš„æ ‡é¢˜ï¼›</li>
<li>åç»­åº”è¯¥ä¸»è¦ä¼šå‘å¸ƒä¸€äº›æŠ€æœ¯ç›¸å…³çš„ä¸»é¢˜ï¼Œä¸»è¦æ˜¯ä½œä¸ºè‡ªå·±çš„æŠ€æœ¯ç§¯ç´¯å’Œæ€»ç»“ï¼Œæ­¤å¤–åº”è¯¥ä¹Ÿä¼šæ›´æ–°ä¸€äº›ä¸ªäººçš„æ¸¸è®°ï¼›</li>
<li>ä½ å¯èƒ½æ˜¯ä»æˆ‘çš„ç®€å†æˆ–è€…æˆ‘çš„Githubä¸»é¡µæ¥åˆ°è¿™ä¸ªåšå®¢ï¼Œè¯·ä¸»è¦å…³æ³¨æŠ€æœ¯ç›¸å…³çš„å†…å®¹ğŸ™ƒï¼›</li>
<li>ä¸»é¡µå›¾ç‰‡ä½¿ç”¨äº†ä¹‹å‰ä»Bingé¦–é¡µä¿å­˜ä¸‹æ¥çš„ä¸œäº¬å¡”çš„ç…§ç‰‡ï¼Œæˆ‘ä¸ªäººå¾ˆå–œæ¬¢ï¼Œå¦‚æœ‰ä¾µæƒè¿˜è¯·è”ç³»æˆ‘ï¼›</li>
<li>åšå®¢åŸºäº<a href="https://hexo.io/zh-cn/">hexo</a>æ„å»ºï¼Œä½¿ç”¨äº†<a href="https://github.com/Shen-Yu/hexo-theme-ayer">ayerä¸»é¢˜</a>ï¼Œæ„Ÿè°¢è¿™ä¸¤ä¸ªå¼€æºé¡¹ç›®ï¼›</li>
<li>äººç”Ÿä¸æ˜“ï¼Œéšç¼˜æ›´æ–°ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>Other</category>
      </categories>
      <tags>
        <tag>Other</tag>
      </tags>
  </entry>
  <entry>
    <title>Record of learning AF_XDP</title>
    <url>/2023/01/21/Record-of-learning-AF-XDP/</url>
    <content><![CDATA[<h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p>è¿‘å¹´eBPFæŠ€æœ¯å¤§ç«ï¼Œåœ¨ç½‘ç»œæ–¹å‘ä¸Šæœ€ç«çš„å¤§æ¦‚å°±æ˜¯ciliumå’ŒXDPäº†ï¼Œå‰è€…æ˜¯ä¸€ä¸ªå‰æ™¯éå¸¸å¹¿é˜”çš„CNIï¼Œåè€…æ˜¯å†…æ ¸é‡ŒåŸºäºeBPFçš„ä¸€ä¸ªåŒ…å¤„ç†æ¡†æ¶ã€‚</p>
<p>å…³äºeBPFæˆ–XDPï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šä»‹ç»æ–‡ç« ï¼Œè¿™é‡Œä¸ä¼šå»è¯¦ç»†ä»‹ç»å…¶åŸºç¡€åŸç†ï¼Œåªè®°å½•ä¸‹å­¦ä¹ è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä»¥åŠå¯¹åº”ä»£ç ã€‚</p>
<p><code>AF_XDP</code>æ˜¯å†…æ ¸åŸºäºXDPçš„ä¸€å±‚socketå°è£…ï¼Œå’Œ<code>AF_INET</code>ã€<code>AF_PACKET</code>ä¸€æ ·ï¼Œæ˜¯ä¸€ç§åè®®æ—ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡socketç›¸å…³è°ƒç”¨å»ä½¿ç”¨ã€‚</p>
<p>XDPç›¸å…³å®ç°çš„å°è£…å±‚æ¬¡ä»ä½åˆ°é«˜ä¸ºï¼š<code>eBPF</code>-&gt;<code>XDP</code>-&gt;<code>AF_XDP</code>-&gt;<code>libbpf</code>-&gt;<code>APP</code>ã€‚</p>
<p><code>AF_XDP</code>ç›¸å…³çš„ä»£ç ä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p>
<ul>
<li>å†…æ ¸ï¼šå†…æ ¸ä»£ç ä¸­çš„å¯¹åº”å®ç°ï¼Œå¯¹åº”ä»£ç è·¯å¾„ä¸º<code>kernel/net/xdp</code>ã€‚</li>
<li>libbpfï¼šeBPFæ¥å£çš„å°è£…åº“ï¼ŒeBPFç¼–ç¨‹åŸºæœ¬éƒ½ä¾èµ–è¿™ä¸ªåº“ï¼Œä¸€äº›å…³é”®ç‰¹æ€§ï¼Œå¦‚CO-REéƒ½æ˜¯åŸºäºlibbpfå®ç°çš„ï¼Œå¯¹åº”ä»£ç è·¯å¾„ä¸º<code>kernel/tools/lib/bpf/xdp.c</code>ã€‚</li>
<li>ç”¨æˆ·æ€åº”ç”¨ä»£ç ï¼šä½¿ç”¨<code>AF_XDP</code>çš„ç”¨æˆ·æ€åº”ç”¨ä»£ç ï¼Œå†…æ ¸ç¤ºä¾‹ä¸º<code>kernel/samples/bpf/xsock_user.c</code>ï¼Œä½œä¸ºDPDKå¼€å‘è€…ï¼Œæˆ‘ä¸»è¦å…³æ³¨DPDKä»£ç ä¸­çš„<code>PMD_AF_XDP</code>ç›¸å…³ä»£ç ï¼Œä»£ç è·¯å¾„ä¸º<code>dpdk/drivers/net/af_xdp</code>ã€‚</li>
</ul>
<p>å…³äº<code>AF_XDP</code>å¯ä»¥å‚è€ƒ<a href="https://www.kernel.org/doc/html/latest/networking/af_xdp.html">å†…æ ¸æ–‡æ¡£</a>å’Œ<a href="https://rexrock.github.io/post/af_xdp1/">AF_XDPæŠ€æœ¯è¯¦è§£</a>ã€‚</p>
<p>æœ¬æ–‡çš„ä»£ç åˆ†æåŸºäºDPDK 19.11ï¼Œå†…æ ¸ç‰ˆæœ¬4.18ä»¥åŠå†…æ ¸ç‰ˆæœ¬å¯¹åº”çš„libbpfã€‚</p>
<h1 id="PMD-AF-XDP"><a href="#PMD-AF-XDP" class="headerlink" title="PMD_AF_XDP"></a>PMD_AF_XDP</h1><p><code>PMD_AF_XDP</code>ä¹Ÿæ˜¯ä¸€ç§DPDKæä¾›çš„PMDï¼Œä¸»è¦ç”¨é€”å’Œ<code>PMD_AF_PACKET</code>ç›¸åŒï¼Œä»å†…æ ¸é©±åŠ¨ç®¡ç†çš„ç½‘å¡è®¾å¤‡è·å–æŠ¥æ–‡ã€‚ç”±äºä¸¤è€…éƒ½æ˜¯åˆ©ç”¨å†…æ ¸socketæä¾›çš„æœºåˆ¶ï¼Œæ‰€ä»¥å®ç°ä¸Šä¹Ÿæ¯”è¾ƒç›¸ä¼¼ï¼ŒåŸºæœ¬å°±æ˜¯å…ˆåˆ›å»ºå¯¹åº”åè®®æ—çš„socketï¼Œç„¶åbindåˆ°å¯¹åº”çš„ç½‘å£ä¸Šï¼Œå†é€šè¿‡<code>send</code>/<code>recv</code>ç­‰è°ƒç”¨å»è¿›è¡ŒæŠ¥æ–‡æ”¶å‘ï¼ˆ<code>AF_XDP</code>åœ¨æ”¶åŒ…æ—¶ä¸éœ€è¦è°ƒç”¨<code>recv</code>ï¼‰ã€‚</p>
<p><code>PMD_AF_XDP</code>å¯¹åº”çš„<code>rte_vdev_driver</code>å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">rte_vdev_driver</span> <span class="title">pmd_af_xdp_drv</span> =</span> &#123;</span><br><span class="line">	.probe = rte_pmd_af_xdp_probe,</span><br><span class="line">	.remove = rte_pmd_af_xdp_remove,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Probe"><a href="#Probe" class="headerlink" title="Probe"></a>Probe</h2><p>æ‰€æœ‰PMDçš„åˆå§‹åŒ–æµç¨‹éƒ½ä¸€æ ·ï¼Œè°ƒç”¨PMDå¯¹åº”çš„probeå‡½æ•°ï¼Œè¿™é‡Œæ˜¯<code>rte_pmd_af_xdp_probe</code>ã€‚</p>
<p>å‚æ•°è§£æã€åˆæ³•æ€§æ£€æŸ¥ç­‰é€šç”¨æµç¨‹å°±ç›´æ¥è·³è¿‡äº†ï¼Œçœ‹å®Œæ•´ä¸ªprobeå‡½æ•°ï¼Œå‘ç°åŸºæœ¬ä¸Šå°±æ˜¯èµ‹å€¼pmdç›¸å…³çš„é€šç”¨æˆå‘˜ï¼Œ<code>dev_ops</code>ã€<code>rx_pkt_burst</code>å’Œ<code>tx_pkt_burst</code>ç­‰ã€‚</p>
<p>probeæµç¨‹ä¸­ï¼Œå€¼å¾—æ³¨æ„çš„ç‚¹ä¸ºæ”¶å‘åŒ…é˜Ÿåˆ—æ•°æ®ç»“æ„åˆå§‹åŒ–å®Œä¹‹åï¼Œè®¾ç½®äº†æ”¶å‘åŒ…é˜Ÿåˆ—äº’ä¸ºpairï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; queue_cnt; i++) &#123;</span><br><span class="line">	internals-&gt;tx_queues[i].<span class="built_in">pair</span> = &amp;internals-&gt;rx_queues[i];</span><br><span class="line">	internals-&gt;rx_queues[i].<span class="built_in">pair</span> = &amp;internals-&gt;tx_queues[i];</span><br><span class="line">	internals-&gt;rx_queues[i].xsk_queue_idx = start_queue_idx + i;</span><br><span class="line">	internals-&gt;tx_queues[i].xsk_queue_idx = start_queue_idx + i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é™¤æ­¤ä¹‹å¤–ï¼Œå…¶ä»–éƒ½æ˜¯é€šç”¨æµç¨‹ï¼Œè¿™é‡Œå°±æœ‰ä¸€ä¸ªç–‘æƒ‘ï¼šsocketåœ¨å“ªåˆ›å»ºçš„ï¼Ÿ</p>
<p>æ—¢ç„¶probeæµç¨‹æ²¡æœ‰ï¼Œé‚£å°±æ¥ç€çœ‹åˆå§‹åŒ–æµç¨‹ï¼Œ<code>probe</code>å®Œæˆåï¼Œé€šå¸¸å°±æ˜¯<code>configure</code>ã€<code>queue setup</code>ï¼Œå†æ¥ç€å°±æ˜¯<code>start</code>ã€‚</p>
<p>ç„¶è€Œ<code>configure</code>æµç¨‹å’Œ<code>start</code>å®ç°éƒ½å¾ˆç®€å•ï¼Œä¸æ¶‰åŠsocketåˆ›å»ºï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">eth_dev_start</span><span class="params">(struct rte_eth_dev *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	dev-&gt;data-&gt;dev_link.link_status = ETH_LINK_UP;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">eth_dev_configure</span><span class="params">(struct rte_eth_dev *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* rx/tx must be paired */</span></span><br><span class="line">	<span class="keyword">if</span> (dev-&gt;data-&gt;nb_rx_queues != dev-&gt;data-&gt;nb_tx_queues)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆå”¯ä¸€å¯èƒ½å°±æ˜¯åœ¨<code>queue setup</code>ä¸­ã€‚</p>
<h2 id="RX-queue-setup"><a href="#RX-queue-setup" class="headerlink" title="RX queue setup"></a>RX queue setup</h2><p>å…ˆçœ‹æ”¶åŒ…é˜Ÿåˆ—<code>eth_rx_queue_setup</code>ï¼Œå…¶ä¸­å®ç°å¾ˆç®€å•ï¼Œæ£€æŸ¥äº†MBUFç©ºé—´å’ŒXDPå¸§å¤§å°æ˜¯å¦åŒ¹é…åè°ƒç”¨äº†<code>xsk_configure</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">xsk_configure</span><span class="params">(struct pmd_internals *internals, struct pkt_rx_queue *rxq,</span></span></span><br><span class="line"><span class="params"><span class="function">	      <span class="keyword">int</span> ring_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">	<span class="comment">/* Init umem. */</span></span><br><span class="line">	rxq-&gt;umem = xdp_umem_configure(internals, rxq);</span><br><span class="line">	<span class="keyword">if</span> (rxq-&gt;umem == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	txq-&gt;umem = rxq-&gt;umem;</span><br><span class="line">......</span><br><span class="line">	<span class="comment">/* Create xsk. */</span></span><br><span class="line">	ret = xsk_socket__create(&amp;rxq-&gt;xsk, internals-&gt;if_name,</span><br><span class="line">			rxq-&gt;xsk_queue_idx, rxq-&gt;umem-&gt;umem, &amp;rxq-&gt;rx,</span><br><span class="line">			&amp;txq-&gt;tx, &amp;cfg);</span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		AF_XDP_LOG(ERR, <span class="string">&quot;Failed to create xsk socket.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line">	&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦æµç¨‹åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆå§‹åŒ–<code>umem</code>ã€åˆ›å»º<code>xsk</code>ï¼ˆAF_XDP socketï¼‰ã€‚</p>
<h3 id="UMEM"><a href="#UMEM" class="headerlink" title="UMEM"></a>UMEM</h3><p>å…³äº<code>umem</code>å®˜æ–¹è¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>UMEM is a region of virtual contiguous memory, divided into equal-sized frames. An UMEM is associated to a netdev and a specific queue id of that netdev. It is created and configured (chunk size, headroom, start address and size) by using the XDP_UMEM_REG setsockopt system call. A UMEM is bound to a netdev and queue id, via the bind() system call.</p>
<p>An AF_XDP is socket linked to a single UMEM, but one UMEM can have multiple AF_XDP sockets. To share an UMEM created via one socket A, the next socket B can do this by setting the XDP_SHARED_UMEM flag in struct sockaddr_xdp member sxdp_flags, and passing the file descriptor of A to struct sockaddr_xdp member sxdp_shared_umem_fd.</p>
<p>The UMEM has two single-producer/single-consumer rings that are used to transfer ownership of UMEM frames between the kernel and the user-space application.</p>
</blockquote>
<p><code>AF_XDP</code>å¯ä»¥é€šè¿‡mmapåœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´ä¼ é€’æ•°æ®ï¼Œè¿™å—å…±äº«å†…å­˜å°±æ˜¯<code>umem</code>ã€‚åœ¨ç”¨æˆ·æ€åº”ç”¨ä¸­å…ˆåˆå§‹åŒ–å¥½<code>umem</code>ï¼Œå†ä½œä¸º<code>xsk_socket__create</code>çš„å‚æ•°ä¼ å…¥ï¼Œåœ¨å†…éƒ¨å®Œæˆå†…æ ¸æ€å†…å­˜å’Œç”¨æˆ·æ€å†…å­˜çš„mapã€‚</p>
<p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œ<code>umem</code>åˆå§‹åŒ–æµç¨‹ä¸­ï¼Œæ”¶å‘åŒ…é˜Ÿåˆ—çš„<code>umem</code>æŒ‡å‘çš„æ˜¯åŒæ ·çš„å†…å­˜ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯åœ¨æ”¶å‘åŒ…é˜Ÿåˆ—ä¹‹é—´è½¬æ¢æ—¶ä¸éœ€è¦æ‹·è´ï¼š</p>
<blockquote>
<p>RX and TX can share the same UMEM so that a packet does not have to be copied between RX and TX. Moreover, if a packet needs to be kept for a while due to a possible retransmit, the descriptor that points to that packet can be changed to point to another and reused right away. This again avoids copying data.</p>
</blockquote>
<p>åœ¨<code>PMD_AF_XDP</code>çš„å®ç°ä¸­ï¼Œæ¯ä¸ª<code>umem</code>å¯¹åº”äº†ä¸€ä¸ª<code>buf_ring</code>ï¼Œç”¨äºç¼“å­˜å…·ä½“çš„<code>umem</code>å’Œæ‰¹é‡æ“ä½œï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct</span></span><br><span class="line"><span class="function">xsk_umem_info *<span class="title">xdp_umem_configure</span><span class="params">(struct pmd_internals *internals,</span></span></span><br><span class="line"><span class="params"><span class="function">				  struct pkt_rx_queue *rxq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">	<span class="built_in">snprintf</span>(ring_name, <span class="keyword">sizeof</span>(ring_name), <span class="string">&quot;af_xdp_ring_%s_%u&quot;</span>,</span><br><span class="line">		       internals-&gt;if_name, rxq-&gt;xsk_queue_idx);</span><br><span class="line">	umem-&gt;buf_ring = rte_ring_create(ring_name,</span><br><span class="line">					 ETH_AF_XDP_NUM_BUFFERS,</span><br><span class="line">					 rte_socket_id(),</span><br><span class="line">					 <span class="number">0x0</span>);</span><br><span class="line">	<span class="keyword">if</span> (umem-&gt;buf_ring == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		AF_XDP_LOG(ERR, <span class="string">&quot;Failed to create rte_ring\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ETH_AF_XDP_NUM_BUFFERS; i++)</span><br><span class="line">		rte_ring_enqueue(umem-&gt;buf_ring,</span><br><span class="line">				 (<span class="keyword">void</span> *)(i * ETH_AF_XDP_FRAME_SIZE));</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°<code>buf_ring</code>çš„å…ƒç´ ä¸ªæ•°ä¸º<code>ETH_AF_XDP_NUM_BUFFERS</code>ï¼Œå’Œ<code>umem</code>çš„å…ƒç´ ä¸ªæ•°æ˜¯ç›¸åŒçš„ï¼Œä¸”åˆå§‹åŒ–ä¸º<code>umem</code>å…ƒç´ çš„åç§»ï¼Œè¿™ä¹Ÿæ˜¯<code>umem</code>çš„ä¿å­˜å½¢å¼ï¼Œéœ€è¦è®¿é—®æ—¶å†é€šè¿‡<code>xsk_umem__get_data</code>è·å–çœŸæ­£çš„<code>umem</code>åœ°å€ã€‚</p>
<h3 id="XSK"><a href="#XSK" class="headerlink" title="XSK"></a>XSK</h3><p><code>umem</code>åˆå§‹åŒ–å®Œæˆåï¼Œå°±æ¥ç€è°ƒç”¨<code>xsk_socket__create</code>åˆ›å»º<code>xsk</code>ï¼Œæ‰€æœ‰<code>xsk_socket__</code>å¼€å¤´çš„ä»£ç ï¼Œå‡ä¸º<code>libbpf</code>çš„å°è£…ï¼Œå£°æ˜åœ¨<code>xsk.h</code>ã€‚ä½¿ç”¨<code>libbpf</code>å°è£…çš„APIå¤§å¤§å‡å°‘äº†<code>XDP</code>/<code>eBPF</code>ç¼–ç çš„å¤æ‚åº¦ã€‚</p>
<p>ä»è¿™ä¸ªå‡½æ•°å¯ä»¥çœ‹å‡ºï¼Œå’Œ<code>AF_PACKET</code>åªåˆ›å»ºä¸€ä¸ªsocketä¸åŒï¼Œå¯¹<code>AF_XDP</code>è€Œè¨€ï¼Œæ¯ä¸€ä¸ªæ”¶åŒ…é˜Ÿåˆ—åˆå§‹åŒ–æµç¨‹ä¸­ï¼ˆå®é™…æ˜¯æ”¶å‘åŒ…é˜Ÿåˆ—å…±ç”¨ï¼‰éƒ½ä¼šåˆ›å»ºä¸€ä¸ª<code>xsk</code>ï¼Œå¹¶ä¸”è¿™é‡Œéœ€è¦ä¼ å…¥queue idï¼Œå’Œ<code>AF_PACKET</code>ä¸åŒï¼Œè¿™ä¸ªqueue idå¯¹åº”å…·ä½“çš„ç¡¬ä»¶é˜Ÿåˆ—idï¼Œè¿™é‡ŒæŒ‡å®šqueue idåº”è¯¥å°±æ˜¯å°†å…·ä½“çš„<code>XDP</code>/<code>eBPF</code>ç¨‹åºattachåˆ°å¯¹åº”é˜Ÿåˆ—ä¸Šçš„æ„æ€ã€‚</p>
<p>åŒæ—¶ä½œä¸ºå‚æ•°ä¼ å…¥çš„ä¸ä»…æœ‰rxqï¼Œä¹Ÿæœ‰rxqï¼Œè¯´æ˜æ”¶å‘åŒ…é˜Ÿåˆ—ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªxskï¼Œå¹¶ä¸”åŒæ—¶åˆå§‹åŒ–ã€‚</p>
<h2 id="TX-queue-setup"><a href="#TX-queue-setup" class="headerlink" title="TX queue setup"></a>TX queue setup</h2><p>å‘åŒ…é˜Ÿåˆ—çš„åˆå§‹åŒ–éå¸¸ç®€å•ï¼Œåœ¨ä¸Šé¢ä¹Ÿè¯´äº†ï¼Œæ”¶å‘åŒ…é˜Ÿåˆ—å…±ç”¨umemå’Œxskï¼Œåœ¨æ”¶åŒ…é˜Ÿåˆ—åˆå§‹åŒ–æ—¶ï¼Œå·²ç»å®Œæˆäº†åˆå§‹åŒ–ï¼Œæ‰€ä»¥å‘åŒ…é˜Ÿåˆ—çš„åˆå§‹åŒ–æ²¡æœ‰ä»»ä½•åŠ¨ä½œï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">eth_tx_queue_setup</span><span class="params">(struct rte_eth_dev *dev,</span></span></span><br><span class="line"><span class="params"><span class="function">		   <span class="keyword">uint16_t</span> tx_queue_id,</span></span></span><br><span class="line"><span class="params"><span class="function">		   <span class="keyword">uint16_t</span> nb_tx_desc __rte_unused,</span></span></span><br><span class="line"><span class="params"><span class="function">		   <span class="keyword">unsigned</span> <span class="keyword">int</span> socket_id __rte_unused,</span></span></span><br><span class="line"><span class="params"><span class="function">		   <span class="keyword">const</span> struct rte_eth_txconf *tx_conf __rte_unused)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pmd_internals</span> *<span class="title">internals</span> =</span> dev-&gt;data-&gt;dev_private;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pkt_tx_queue</span> *<span class="title">txq</span>;</span></span><br><span class="line"></span><br><span class="line">	txq = &amp;internals-&gt;tx_queues[tx_queue_id];</span><br><span class="line"></span><br><span class="line">	dev-&gt;data-&gt;tx_queues[tx_queue_id] = txq;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Queue-change"><a href="#Queue-change" class="headerlink" title="Queue change?"></a>Queue change?</h2><p>ä»<code>xsk</code>çš„åˆå§‹åŒ–æµç¨‹å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ª<code>xsk</code>å¯¹åº”äº†ä¸€ä¸ªç½‘å¡çš„ç¡¬ä»¶é˜Ÿåˆ—ï¼Œé‚£ä¹ˆå½“<code>XDP</code>ç¨‹åºå·²ç»attachåˆ°å¯¹åº”ç½‘å¡é˜Ÿåˆ—åï¼Œå†è°ƒæ•´ç½‘å¡é˜Ÿåˆ—æ•°ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>ä»¥<code>ethtool</code>è°ƒæ•´é˜Ÿåˆ—æ•°çš„ä»£ç <code>ethtool_set_channels</code>ä¸ºä¾‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> noinline_for_stack <span class="keyword">int</span> <span class="title">ethtool_set_channels</span><span class="params">(struct net_device *dev,</span></span></span><br><span class="line"><span class="params"><span class="function">						   <span class="keyword">void</span> __user *useraddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">	<span class="comment">/* Disabling channels, query zero-copy AF_XDP sockets */</span></span><br><span class="line">	from_channel = channels.combined_count +</span><br><span class="line">		min(channels.rx_count, channels.tx_count);</span><br><span class="line">	to_channel = curr.combined_count + max(curr.rx_count, curr.tx_count);</span><br><span class="line">	<span class="keyword">for</span> (i = from_channel; i &lt; to_channel; i++)</span><br><span class="line">		<span class="keyword">if</span> (xdp_get_umem_from_qid(dev, i))</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> dev-&gt;ethtool_ops-&gt;set_channels(dev, &amp;channels);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°é’ˆå¯¹å¾…è°ƒæ•´çš„é˜Ÿåˆ—ï¼Œè°ƒç”¨äº†<code>xdp_get_umem_from_qid</code>è¿›è¡Œæ£€æŸ¥ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">struct xdp_umem *<span class="title">xdp_get_umem_from_qid</span><span class="params">(struct net_device *dev,</span></span></span><br><span class="line"><span class="params"><span class="function">				       u16 queue_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (queue_id &lt; dev-&gt;real_num_rx_queues)</span><br><span class="line">		<span class="keyword">return</span> dev-&gt;_rx[queue_id].umem;</span><br><span class="line">	<span class="keyword">if</span> (queue_id &lt; dev-&gt;real_num_tx_queues)</span><br><span class="line">		<span class="keyword">return</span> dev-&gt;_tx[queue_id].umem;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(xdp_get_umem_from_qid);</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ä¸Šè¿°å‰ç½®æ£€æŸ¥ä¸­ï¼Œå¦‚æœé˜Ÿåˆ—ä¸Šæœ‰å¯¹åº”çš„<code>umem</code>åˆ™è¿”å›<code>-EINVAL</code>ï¼Œå³å¦‚æœç½‘å¡é˜Ÿåˆ—å·²ç»attachäº†<code>XDP</code>ç¨‹åºï¼Œåˆ™ä¸å…è®¸ç¦ç”¨å½“å‰é˜Ÿåˆ—ã€‚</p>
<p><code>AF_XDP</code>çš„åº”ç”¨åœºæ™¯å’Œ<code>AF_PACKET</code>ç›¸ä¼¼ï¼Œéƒ½æ˜¯åœ¨å†…æ ¸é©±åŠ¨æ­£å¸¸ä½¿ç”¨çš„å‰æä¸‹ï¼Œåœ¨ç”¨æˆ·æ€æ•è·ç½‘å¡æŠ¥æ–‡çš„æœºåˆ¶ï¼Œåœ¨æ¦‚å¿µç†è§£çš„å¾ˆå¤šæ—¶å€™ä¼šè¿›è¡Œç±»æ¯”ï¼Œå…¶ä¸­é˜Ÿåˆ—è¿™ä¸€å—å°±æ˜¯ä¸€ä¸ªæ˜æ˜¾å·®å¼‚äº†ï¼Œ<code>AF_XDP</code>çš„é˜Ÿåˆ—å°±æ˜¯ç½‘å¡çš„ç¡¬ä»¶é˜Ÿåˆ—ï¼Œè€Œ<code>AF_PACKET</code>çš„é˜Ÿåˆ—æ˜¯å…¶è‡ªèº«çš„æŠ½è±¡è½¯ä»¶é˜Ÿåˆ—ï¼Œå’Œç½‘å¡ç¡¬ä»¶é˜Ÿåˆ—å¹¶ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚</p>
<h2 id="XDP-mode"><a href="#XDP-mode" class="headerlink" title="XDP mode"></a>XDP mode</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> XDP_FLAGS_SKB_MODE		(1U &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> XDP_FLAGS_DRV_MODE		(1U &lt;&lt; 2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> XDP_FLAGS_HW_MODE		(1U &lt;&lt; 3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> XDP_FLAGS_MODES			(XDP_FLAGS_SKB_MODE | \</span></span><br><span class="line"><span class="meta">					 XDP_FLAGS_DRV_MODE | \</span></span><br><span class="line"><span class="meta">					 XDP_FLAGS_HW_MODE)</span></span><br></pre></td></tr></table></figure>

<p><code>XDP</code>æ”¯æŒä¸‰ç§æ¨¡å¼ï¼Œåˆ†åˆ«å¯¹åº”äº†ä¸åŒä½ç½®çš„<code>eBPF</code> hookç‚¹ï¼Œè‡ªåº•å‘ä¸Šåˆ†åˆ«ä¸ºï¼š<code>XDP_HW</code>ã€<code>XDP_DRV</code>å’Œ<code>XDP_SKB</code>ã€‚</p>
<p>åœ¨<code>AF_XDP</code>åˆå§‹åŒ–æ—¶ï¼Œé€šè¿‡<code>xsk_socket__create</code>-&gt;<code>xsk_setup_xdp_prog</code>-&gt;<code>xsk_load_xdp_prog</code>-&gt;<code>bpf_set_link_xdp_fd</code>-&gt;<code>rtnl_setlink</code>-&gt;<code>do_setlink</code>-&gt;<code>dev_change_xdp_fd</code>è®¾ç½®<code>XDP mode</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *	dev_change_xdp_fd - set or clear a bpf program for a device rx path</span></span><br><span class="line"><span class="comment"> *	@dev: device</span></span><br><span class="line"><span class="comment"> *	@extack: netlink extended ack</span></span><br><span class="line"><span class="comment"> *	@fd: new program fd or negative value to clear</span></span><br><span class="line"><span class="comment"> *	@flags: xdp-related flags</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *	Set or clear a bpf program for a device</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dev_change_xdp_fd</span><span class="params">(struct net_device *dev, struct netlink_ext_ack *extack,</span></span></span><br><span class="line"><span class="params"><span class="function">		      <span class="keyword">int</span> fd, u32 flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_device_ops</span> *<span class="title">ops</span> =</span> dev-&gt;netdev_ops;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">bpf_netdev_command</span> <span class="title">query</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_prog</span> *<span class="title">prog</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">bpf_op_t</span> bpf_op, bpf_chk;</span><br><span class="line">	<span class="keyword">bool</span> offload;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	ASSERT_RTNL();</span><br><span class="line"></span><br><span class="line">	rh_mark_used_feature(<span class="string">&quot;eBPF/xdp&quot;</span>);</span><br><span class="line"></span><br><span class="line">	offload = flags &amp; XDP_FLAGS_HW_MODE;</span><br><span class="line">	query = offload ? XDP_QUERY_PROG_HW : XDP_QUERY_PROG;</span><br><span class="line"></span><br><span class="line">	bpf_op = bpf_chk = ops-&gt;ndo_bpf;</span><br><span class="line">	<span class="keyword">if</span> (!bpf_op &amp;&amp; (flags &amp; (XDP_FLAGS_DRV_MODE | XDP_FLAGS_HW_MODE))) &#123;</span><br><span class="line">		NL_SET_ERR_MSG(extack, <span class="string">&quot;underlying driver does not support XDP in native mode&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!bpf_op || (flags &amp; XDP_FLAGS_SKB_MODE))</span><br><span class="line">		bpf_op = generic_xdp_install;</span><br><span class="line">	<span class="keyword">if</span> (bpf_op == bpf_chk)</span><br><span class="line">		bpf_chk = generic_xdp_install;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!offload &amp;&amp; __dev_xdp_query(dev, bpf_chk, XDP_QUERY_PROG)) &#123;</span><br><span class="line">			NL_SET_ERR_MSG(extack, <span class="string">&quot;native and generic XDP can&#x27;t be active at the same time&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> -EEXIST;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ((flags &amp; XDP_FLAGS_UPDATE_IF_NOEXIST) &amp;&amp;</span><br><span class="line">		    __dev_xdp_query(dev, bpf_op, query)) &#123;</span><br><span class="line">			NL_SET_ERR_MSG(extack, <span class="string">&quot;XDP program already attached&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> -EBUSY;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		prog = bpf_prog_get_type_dev(fd, BPF_PROG_TYPE_XDP,</span><br><span class="line">					     bpf_op == ops-&gt;ndo_bpf);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(prog))</span><br><span class="line">			<span class="keyword">return</span> PTR_ERR(prog);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!offload &amp;&amp; bpf_prog_is_dev_bound(prog-&gt;aux)) &#123;</span><br><span class="line">			NL_SET_ERR_MSG(extack, <span class="string">&quot;using device-bound program without HW_MODE flag is not supported&quot;</span>);</span><br><span class="line">			bpf_prog_put(prog);</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = dev_xdp_install(dev, bpf_op, extack, flags, prog);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span> &amp;&amp; prog)</span><br><span class="line">		bpf_prog_put(prog);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè°ƒç”¨<code>xsk_socket__create</code>æ—¶<code>usr_config</code>æ²¡æœ‰æŒ‡å®š<code>xdp_flags</code>çš„è¯ï¼Œé»˜è®¤ä¸º<code>0</code>ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¼˜å…ˆé€šè¿‡<code>dev-&gt;netdev_ops-&gt;ndo_bpf</code>åˆ¤æ–­å¯¹åº”çš„è®¾å¤‡æ˜¯å¦æ”¯æŒ<code>XDP_HW</code>æˆ–<code>XDP_DRV</code>ï¼Œå¯¹<code>bpf_op</code>èµ‹å€¼åé€šè¿‡<code>dev_xdp_install</code>è°ƒç”¨ã€‚</p>
<p>æ‰€ä»¥ï¼Œå¯¹äº<code>XDP_SKB</code>æ¨¡å¼è€Œè¨€ï¼Œ<code>bpf_op</code>å¯¹åº”çš„å‡½æ•°ä¸º<code>generic_xdp_install</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">generic_xdp_install</span><span class="params">(struct net_device *dev, struct netdev_bpf *xdp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_prog</span> *<span class="title">old</span> =</span> rtnl_dereference(dev-&gt;xdp_prog);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_prog</span> *<span class="title">new</span> =</span> xdp-&gt;prog;</span><br><span class="line">	<span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (xdp-&gt;command) &#123;</span><br><span class="line">	<span class="keyword">case</span> XDP_SETUP_PROG:</span><br><span class="line">		rcu_assign_pointer(dev-&gt;xdp_prog, <span class="keyword">new</span>);</span><br><span class="line">		<span class="keyword">if</span> (old)</span><br><span class="line">			bpf_prog_put(old);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (old &amp;&amp; !<span class="keyword">new</span>) &#123;</span><br><span class="line">			static_branch_dec(&amp;generic_xdp_needed_key);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">new</span> &amp;&amp; !old) &#123;</span><br><span class="line">			static_branch_inc(&amp;generic_xdp_needed_key);</span><br><span class="line">			dev_disable_lro(dev);</span><br><span class="line">			dev_disable_gro_hw(dev);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> XDP_QUERY_PROG:</span><br><span class="line">		xdp-&gt;prog_id = old ? old-&gt;aux-&gt;id : <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		ret = -EINVAL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°é€»è¾‘éå¸¸ç®€å•ï¼Œå°±æ˜¯è®¾ç½®<code>dev-&gt;xdp_prog</code>ï¼Œè°ƒæ•´<code>generic_xdp_needed_key</code>ï¼Œå¦‚æœæ˜¯åˆå§‹åŒ–çš„è¯ï¼Œå†å…³é—­è®¾å¤‡çš„<code>lro</code>å’Œ<code>gro</code>ã€‚</p>
<p>å¯¹<code>PMD_AF_XDP</code>è€Œè¨€ï¼Œåªç½®ä½äº†<code>XDP_FLAGS_UPDATE_IF_NOEXIST</code>ï¼Œæ‰€ä»¥å’Œé»˜è®¤è¡Œä¸ºä¸€æ ·ï¼ŒæŒ‰ç…§ä¼˜å…ˆé¡ºåºä½¿ç”¨<code>XDP_HW</code>ã€<code>XDP_DRV</code>å’Œ<code>XDP_SKB</code>ã€‚</p>
<h2 id="Where-is-the-XDP-eBPF-program"><a href="#Where-is-the-XDP-eBPF-program" class="headerlink" title="Where is the XDP/eBPF program?"></a>Where is the XDP/eBPF program?</h2><p>è‡³æ­¤ï¼Œ<code>PMD_AF_XDP</code>çš„åˆå§‹åŒ–æµç¨‹å·²ç»ç»“æŸï¼Œä¸Šé¢ä¹Ÿåˆ†æè¿‡äº†ï¼Œ<code>configure</code>å’Œ<code>start</code>ä¸­éƒ½æ²¡æœ‰å¤æ‚æ“ä½œï¼Œ<code>start</code>å®Œæˆåï¼ŒPMDå°±å¯ä»¥æ­£å¸¸å·¥ä½œè¿›è¡Œæ”¶å‘åŒ…äº†ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ<code>XDP</code>/<code>eBPF</code>ç¨‹åºæ˜¯åœ¨å“ªé‡Œè¢«attachä¸Šå»çš„å‘¢ï¼Ÿè¿™é‡Œä»<code>xsk_socket__create</code>çœ‹èµ·ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">xsk_socket__create</span><span class="params">(struct xsk_socket **xsk_ptr, <span class="keyword">const</span> <span class="keyword">char</span> *ifname,</span></span></span><br><span class="line"><span class="params"><span class="function">		       __u32 queue_id, struct xsk_umem *umem,</span></span></span><br><span class="line"><span class="params"><span class="function">		       struct xsk_ring_cons *rx, struct xsk_ring_prod *tx,</span></span></span><br><span class="line"><span class="params"><span class="function">		       <span class="keyword">const</span> struct xsk_socket_config *usr_config)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">	<span class="keyword">if</span> (!(xsk-&gt;config.libbpf_flags &amp; XSK_LIBBPF_FLAGS__INHIBIT_PROG_LOAD)) &#123;</span><br><span class="line">		err = xsk_setup_xdp_prog(xsk);</span><br><span class="line">		<span class="keyword">if</span> (err)</span><br><span class="line">			<span class="keyword">goto</span> out_mmap_tx;</span><br><span class="line">	&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">xsk_setup_xdp_prog</span><span class="params">(struct xsk_socket *xsk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">	<span class="keyword">if</span> (!prog_id) &#123;</span><br><span class="line">		err = xsk_create_bpf_maps(xsk);</span><br><span class="line">		<span class="keyword">if</span> (err)</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">		err = xsk_load_xdp_prog(xsk);</span><br><span class="line">		<span class="keyword">if</span> (err) &#123;</span><br><span class="line">			xsk_delete_bpf_maps(xsk);</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		xsk-&gt;prog_fd = bpf_prog_get_fd_by_id(prog_id);</span><br><span class="line">		<span class="keyword">if</span> (xsk-&gt;prog_fd &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> -errno;</span><br><span class="line">		err = xsk_lookup_bpf_maps(xsk);</span><br><span class="line">		<span class="keyword">if</span> (err) &#123;</span><br><span class="line">			close(xsk-&gt;prog_fd);</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">.....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">xsk_load_xdp_prog</span><span class="params">(struct xsk_socket *xsk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> log_buf_size = <span class="number">16</span> * <span class="number">1024</span>;</span><br><span class="line">	<span class="keyword">char</span> log_buf[log_buf_size];</span><br><span class="line">	<span class="keyword">int</span> err, prog_fd;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* This is the C-program:</span></span><br><span class="line"><span class="comment">	 * SEC(&quot;xdp_sock&quot;) int xdp_sock_prog(struct xdp_md *ctx)</span></span><br><span class="line"><span class="comment">	 * &#123;</span></span><br><span class="line"><span class="comment">	 *     int ret, index = ctx-&gt;rx_queue_index;</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *     // A set entry here means that the correspnding queue_id</span></span><br><span class="line"><span class="comment">	 *     // has an active AF_XDP socket bound to it.</span></span><br><span class="line"><span class="comment">	 *     ret = bpf_redirect_map(&amp;xsks_map, index, XDP_PASS);</span></span><br><span class="line"><span class="comment">	 *     if (ret &gt; 0)</span></span><br><span class="line"><span class="comment">	 *         return ret;</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *     // Fallback for pre-5.3 kernels, not supporting default</span></span><br><span class="line"><span class="comment">	 *     // action in the flags parameter.</span></span><br><span class="line"><span class="comment">	 *     if (bpf_map_lookup_elem(&amp;xsks_map, &amp;index))</span></span><br><span class="line"><span class="comment">	 *         return bpf_redirect_map(&amp;xsks_map, index, 0);</span></span><br><span class="line"><span class="comment">	 *     return XDP_PASS;</span></span><br><span class="line"><span class="comment">	 * &#125;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">prog</span>[] =</span> &#123;</span><br><span class="line">		<span class="comment">/* r2 = *(u32 *)(r1 + 16) */</span></span><br><span class="line">		BPF_LDX_MEM(BPF_W, BPF_REG_2, BPF_REG_1, <span class="number">16</span>),</span><br><span class="line">		<span class="comment">/* *(u32 *)(r10 - 4) = r2 */</span></span><br><span class="line">		BPF_STX_MEM(BPF_W, BPF_REG_10, BPF_REG_2, <span class="number">-4</span>),</span><br><span class="line">		<span class="comment">/* r1 = xskmap[] */</span></span><br><span class="line">		BPF_LD_MAP_FD(BPF_REG_1, xsk-&gt;xsks_map_fd),</span><br><span class="line">		<span class="comment">/* r3 = XDP_PASS */</span></span><br><span class="line">		BPF_MOV64_IMM(BPF_REG_3, <span class="number">2</span>),</span><br><span class="line">		<span class="comment">/* call bpf_redirect_map */</span></span><br><span class="line">		BPF_EMIT_CALL(BPF_FUNC_redirect_map),</span><br><span class="line">		<span class="comment">/* if w0 != 0 goto pc+13 */</span></span><br><span class="line">		BPF_JMP32_IMM(BPF_JSGT, BPF_REG_0, <span class="number">0</span>, <span class="number">13</span>),</span><br><span class="line">		<span class="comment">/* r2 = r10 */</span></span><br><span class="line">		BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),</span><br><span class="line">		<span class="comment">/* r2 += -4 */</span></span><br><span class="line">		BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, <span class="number">-4</span>),</span><br><span class="line">		<span class="comment">/* r1 = xskmap[] */</span></span><br><span class="line">		BPF_LD_MAP_FD(BPF_REG_1, xsk-&gt;xsks_map_fd),</span><br><span class="line">		<span class="comment">/* call bpf_map_lookup_elem */</span></span><br><span class="line">		BPF_EMIT_CALL(BPF_FUNC_map_lookup_elem),</span><br><span class="line">		<span class="comment">/* r1 = r0 */</span></span><br><span class="line">		BPF_MOV64_REG(BPF_REG_1, BPF_REG_0),</span><br><span class="line">		<span class="comment">/* r0 = XDP_PASS */</span></span><br><span class="line">		BPF_MOV64_IMM(BPF_REG_0, <span class="number">2</span>),</span><br><span class="line">		<span class="comment">/* if r1 == 0 goto pc+5 */</span></span><br><span class="line">		BPF_JMP_IMM(BPF_JEQ, BPF_REG_1, <span class="number">0</span>, <span class="number">5</span>),</span><br><span class="line">		<span class="comment">/* r2 = *(u32 *)(r10 - 4) */</span></span><br><span class="line">		BPF_LDX_MEM(BPF_W, BPF_REG_2, BPF_REG_10, <span class="number">-4</span>),</span><br><span class="line">		<span class="comment">/* r1 = xskmap[] */</span></span><br><span class="line">		BPF_LD_MAP_FD(BPF_REG_1, xsk-&gt;xsks_map_fd),</span><br><span class="line">		<span class="comment">/* r3 = 0 */</span></span><br><span class="line">		BPF_MOV64_IMM(BPF_REG_3, <span class="number">0</span>),</span><br><span class="line">		<span class="comment">/* call bpf_redirect_map */</span></span><br><span class="line">		BPF_EMIT_CALL(BPF_FUNC_redirect_map),</span><br><span class="line">		<span class="comment">/* The jumps are to this instruction */</span></span><br><span class="line">		BPF_EXIT_INSN(),</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">size_t</span> insns_cnt = <span class="keyword">sizeof</span>(prog) / <span class="keyword">sizeof</span>(struct bpf_insn);</span><br><span class="line"></span><br><span class="line">	prog_fd = bpf_load_program(BPF_PROG_TYPE_XDP, prog, insns_cnt,</span><br><span class="line">				   <span class="string">&quot;LGPL-2.1 or BSD-2-Clause&quot;</span>, <span class="number">0</span>, log_buf,</span><br><span class="line">				   log_buf_size);</span><br><span class="line">	<span class="keyword">if</span> (prog_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		pr_warn(<span class="string">&quot;BPF log buffer:\n%s&quot;</span>, log_buf);</span><br><span class="line">		<span class="keyword">return</span> prog_fd;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = bpf_set_link_xdp_fd(xsk-&gt;ifindex, prog_fd, xsk-&gt;config.xdp_flags);</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">		close(prog_fd);</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	xsk-&gt;prog_fd = prog_fd;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ˜¯é€šè¿‡è°ƒç”¨é“¾<code>xsk_socket__create</code>-&gt;<code>xsk_setup_xdp_prog</code>-&gt;<code>xsk_load_xdp_prog</code>-&gt;<code>bpf_load_program</code>å®Œæˆçš„ï¼Œå…¶ä¸­å¯¹åº”çš„<code>eBPF</code>ç¨‹åºç›´æ¥ç¡¬ç¼–ç åˆ°äº†<code>xsk_load_xdp_prog</code>ä¸­ï¼Œå½“ç„¶ä¹Ÿæ˜¯ç”±äº<code>AF_XDP</code>çš„åŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œå¦‚æœæ˜¯å…¶ä»–åŠŸèƒ½çš„<code>XDP</code>/<code>eBPF</code>ç¨‹åºï¼Œåˆ™ä¼šé‡‡ç”¨å…¶ä»–æ–¹å¼ä¿å­˜æºç ã€‚</p>
<p>æ³¨æ„<code>xsk_setup_xdp_prog</code>ä¸­æ ¹æ®<code>prog_id</code>æ˜¯å¦åˆæ³•ï¼Œæœ‰ä¸åŒçš„å¤„ç†é€»è¾‘ï¼š</p>
<ul>
<li>å½“å‰è®¾å¤‡ä¸Šæœªattach <code>XDP</code>ç¨‹åºï¼šå‡½æ•°å°†åˆ›å»º<code>BPF_MAP</code>å¹¶è¿›è¡Œ<code>XDP</code>ç¨‹åºçš„attach</li>
<li>å½“å‰è®¾å¤‡ä¸Šå·²attach <code>XDP</code>ç¨‹åºï¼šå‡½æ•°æŸ¥æ‰¾è®¾å¤‡å¯¹åº”çš„<code>XDP</code>ç¨‹åºidä»¥åŠå¯¹åº”çš„<code>BPF_MAP</code>ï¼Œå°†å…¶èµ‹å€¼ç»™<code>xsk</code>ç›¸åº”æˆå‘˜</li>
</ul>
<p>ç”±æ­¤å¯è§ï¼Œ<code>XDP</code>ç¨‹åºå’Œ<code>BPF_MAP</code>æ˜¯è®¾å¤‡çº§åˆ«çš„ï¼ŒåŒä¸€ä¸ªè®¾å¤‡åªèƒ½æœ‰ä¸€ä¸ª<code>XDP</code>ç¨‹åºï¼ˆä¸æ”¯æŒ<code>XDP_ATTACHED_MULTI</code>çš„åœºæ™¯ï¼‰å’Œ<code>BPF_MAP</code>ã€‚è¿™ç‚¹åœ¨<code>net_device</code>çš„å®šä¹‰ä¸­ä¹Ÿæœ‰ä½“ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> &#123;</span></span><br><span class="line">......</span><br><span class="line">    <span class="comment">/* RHEL: while xdp_prog is explicitly removed from the kABI</span></span><br><span class="line"><span class="comment">	 * whitelist, one semantics must be preserved: comparison of</span></span><br><span class="line"><span class="comment">	 * xdp_prog to NULL denotes whether a XDP program is loaded or not.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	RH_KABI_EXCLUDE(struct bpf_prog __rcu	*xdp_prog)</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>xdp_prog</code>åªæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå¹¶éä¸€ä¸ªæ•°ç»„ã€‚</p>
<h2 id="RX-amp-TX"><a href="#RX-amp-TX" class="headerlink" title="RX &amp; TX"></a>RX &amp; TX</h2><p>æŠ¥æ–‡æ”¶å‘æ˜¯PMDçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹æ”¶å‘æ˜¯æ€ä¹ˆå®ç°çš„ã€‚ä¹‹å‰å·²ç»æåˆ°äº†ï¼Œå†…æ ¸æ€<code>XDP</code>å’Œç”¨æˆ·æ€åº”ç”¨ä¹‹é—´é€šè¿‡<code>umem</code>è¿›è¡ŒæŠ¥æ–‡æ”¶å‘ï¼Œé‚£å…·ä½“æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ</p>
<h3 id="XDP-ring"><a href="#XDP-ring" class="headerlink" title="XDP ring"></a>XDP ring</h3><blockquote>
<p>The UMEM consists of a number of equally sized chunks. A descriptor in one of the rings references a frame by referencing its addr. The addr is simply an offset within the entire UMEM region. The user space allocates memory for this UMEM using whatever means it feels is most appropriate (malloc, mmap, huge pages, etc). This memory area is then registered with the kernel using the new setsockopt XDP_UMEM_REG. The UMEM also has two rings: the FILL ring and the COMPLETION ring. The FILL ring is used by the application to send down addr for the kernel to fill in with RX packet data. References to these frames will then appear in the RX ring once each packet has been received. The COMPLETION ring, on the other hand, contains frame addr that the kernel has transmitted completely and can now be used again by user space, for either TX or RX. Thus, the frame addrs appearing in the COMPLETION ring are addrs that were previously transmitted using the TX ring. In summary, the RX and FILL rings are used for the RX path and the TX and COMPLETION rings are used for the TX path.</p>
</blockquote>
<p>å®é™…ä¸Šï¼Œé™¤äº†<code>umem</code>å¤–ï¼ŒæŠ¥æ–‡æ”¶å‘è¿˜ç”¨åˆ°äº†4ç§ä¸åŒçš„æ•°æ®ç»“æ„ï¼Œåˆ†åˆ«ä¸ºï¼š</p>
<ul>
<li><code>fill ring</code>ï¼šæ¯ä¸€ä¸ª<code>umem</code>åªæœ‰ä¸€ä¸ªï¼Œç”¨äºå‘å†…æ ¸æä¾›<code>umem</code>ã€‚</li>
<li><code>completion ring</code>ï¼šæ¯ä¸€ä¸ª<code>umem</code>åªæœ‰ä¸€ä¸ªï¼Œç”¨äºä»å†…æ ¸è·å–<code>umem</code>ã€‚</li>
<li><code>rx ring</code>ï¼šç”¨æˆ·æ€åº”ç”¨ä»<code>rx ring</code>æ”¶å–æŠ¥æ–‡ï¼Œæ¯ä¸ª<code>xsk</code>å¯ä»¥æœ‰å¤šä¸ª<code>rx ring</code>ï¼Œåº”è¯¥æ˜¯å¯¹åº”<code>XDP_SHARED_UMEM </code>çš„åœºæ™¯ã€‚</li>
<li><code>tx ring</code>ï¼šç”¨æˆ·æ€åº”ç”¨å‘<code>tx ring</code>å‘é€æŠ¥æ–‡ï¼Œæ¯ä¸ª<code>xsk</code>å¯ä»¥æœ‰å¤šä¸ª<code>tx ring</code>ï¼Œåº”è¯¥æ˜¯å¯¹åº”<code>XDP_SHARED_UMEM </code>çš„åœºæ™¯ã€‚</li>
</ul>
<h3 id="RX-procedure"><a href="#RX-procedure" class="headerlink" title="RX procedure"></a>RX procedure</h3><p>æ”¶åŒ…æµç¨‹ä½¿ç”¨<code>fill ring</code>å’Œ<code>rx ring</code>ï¼Œç”¨æˆ·æ€åº”ç”¨é¦–å…ˆéœ€è¦å‘å†…æ ¸æä¾›<code>umem</code>ç”¨äºæ¥æ”¶æŠ¥æ–‡ï¼Œæ‰€ä»¥å…ˆä½œä¸ºproducerå‘<code>fill ring</code>å¡«å…¥<code>umem</code>ï¼Œå†…æ ¸<code>XDP</code>ä½œä¸ºconsumerä»<code>fill ring</code>è·å–åˆ°å¯ç”¨<code>umem</code>åå°†æŠ¥æ–‡å¡«å…¥ï¼Œå†ä½œä¸ºproducerå°†è¿™éƒ¨åˆ†<code>umem</code>æ·»åŠ åˆ°<code>rx ring</code>ï¼Œæœ€åç”¨æˆ·æ€åº”ç”¨ä½œä¸ºconsumerä»<code>rx ring</code>è·å–æ¥æ”¶åˆ°çš„æŠ¥æ–‡ã€‚</p>
<p>åœ¨<code>xsk</code>åˆå§‹åŒ–æµç¨‹ä¸­å°±å·²ç»å¯¹åˆå§‹åŒ–å¥½çš„<code>fill ring</code>å¡«å…¥<code>umem</code>äº†ï¼Œè¿™æ ·å½“<code>XDP</code>/<code>eBPF</code>attachå®Œæˆåå°±å¯ä»¥ç«‹å³ç”¨è¿™éƒ¨åˆ†<code>umem</code>æ”¶åŒ…äº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETH_AF_XDP_DFLT_NUM_DESCS	XSK_RING_CONS__DEFAULT_NUM_DESCS</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">xsk_configure</span><span class="params">(struct pmd_internals *internals, struct pkt_rx_queue *rxq,</span></span></span><br><span class="line"><span class="params"><span class="function">	      <span class="keyword">int</span> ring_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">	<span class="keyword">int</span> reserve_size = ETH_AF_XDP_DFLT_NUM_DESCS / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">	ret = reserve_fill_queue(rxq-&gt;umem, reserve_size, fq_bufs);</span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		xsk_socket__delete(rxq-&gt;xsk);</span><br><span class="line">		AF_XDP_LOG(ERR, <span class="string">&quot;Failed to reserve fill queue.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line">	&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„è¿™é‡Œé¢„ç•™çš„ä¸ªæ•°å®é™…ä¸Šæ˜¯<code>XSK_RING_CONS__DEFAULT_NUM_DESCS / 2</code>ï¼Œé»˜è®¤æƒ…å†µä¸‹<code>ETH_AF_XDP_NUM_BUFFERS = XSK_RING_CONS__DEFAULT_NUM_DESCS * 2 </code>ï¼Œå³è¿™é‡Œåˆå§‹åŒ–äº†<code>umem</code>æ€»é‡çš„å››åˆ†ä¹‹ä¸€ï¼Œå¡«å…¥äº†<code>fill ring</code>ã€‚</p>
<p>ä»¥<code>af_xdp_rx_cp</code>ä¸ºä¾‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint16_t</span></span></span><br><span class="line"><span class="function"><span class="title">af_xdp_rx_cp</span><span class="params">(<span class="keyword">void</span> *<span class="built_in">queue</span>, struct rte_mbuf **bufs, <span class="keyword">uint16_t</span> nb_pkts)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">    <span class="comment">/* Step 1: Get recv num. */</span></span><br><span class="line">	rcvd = xsk_ring_cons__peek(rx, nb_pkts, &amp;idx_rx);</span><br><span class="line">	<span class="keyword">if</span> (rcvd == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(XDP_USE_NEED_WAKEUP)</span></span><br><span class="line">		<span class="keyword">if</span> (xsk_ring_prod__needs_wakeup(fq))</span><br><span class="line">			(<span class="keyword">void</span>)poll(rxq-&gt;fds, <span class="number">1</span>, <span class="number">1000</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Step 2: Reserve some umem to fill ring if necessary. */</span></span><br><span class="line">	<span class="keyword">if</span> (xsk_prod_nb_free(fq, free_thresh) &gt;= free_thresh)</span><br><span class="line">		(<span class="keyword">void</span>)reserve_fill_queue(umem, ETH_AF_XDP_RX_BATCH_SIZE, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; rcvd; i++) &#123;</span><br><span class="line">		<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">xdp_desc</span> *<span class="title">desc</span>;</span></span><br><span class="line">		<span class="keyword">uint64_t</span> addr;</span><br><span class="line">		<span class="keyword">uint32_t</span> len;</span><br><span class="line">		<span class="keyword">void</span> *pkt;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Step 3: Recieve every packets from rx ring. */</span></span><br><span class="line">		desc = xsk_ring_cons__rx_desc(rx, idx_rx++);</span><br><span class="line">		addr = desc-&gt;addr;</span><br><span class="line">		len = desc-&gt;len;</span><br><span class="line">		pkt = xsk_umem__get_data(rxq-&gt;umem-&gt;mz-&gt;addr, addr);</span><br><span class="line"></span><br><span class="line">		rte_memcpy(rte_pktmbuf_mtod(mbufs[i], <span class="keyword">void</span> *), pkt, len);</span><br><span class="line">        <span class="comment">/* Step 4: Enqueue addr to buf_ring after packet recieved. */</span></span><br><span class="line">		rte_ring_enqueue(umem-&gt;buf_ring, (<span class="keyword">void</span> *)addr);</span><br><span class="line">		rte_pktmbuf_pkt_len(mbufs[i]) = len;</span><br><span class="line">		rte_pktmbuf_data_len(mbufs[i]) = len;</span><br><span class="line">		rx_bytes += len;</span><br><span class="line">		bufs[i] = mbufs[i];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Step 5: Update rx ring consumer index. */</span></span><br><span class="line">	xsk_ring_cons__release(rx, rcvd);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ”¶åŒ…æµç¨‹ä¸­å„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>Step 1ï¼šä¾æ®<code>rx ring</code>çš„producerå’Œconsumerå·®å€¼ï¼Œè·å–å½“å‰å¯æ”¶å–çš„æŠ¥æ–‡æ•°é‡ã€‚</li>
<li>Step 2ï¼šå¦‚æœ<code>fill ring</code>ä¸­å‰©ä½™<code>umem</code>å°äºé˜ˆå€¼çš„è¯ï¼Œåˆ™æ·»åŠ ä¸€éƒ¨åˆ†è¿›å»ã€‚</li>
<li>Step 3ï¼šä»<code>rx ring</code>è·å–æŠ¥æ–‡å¯¹åº”çš„<code>umem</code>å¹¶æ‹·è´åˆ°<code>mbuf</code>å®Œæˆæ¯ä¸ªæŠ¥æ–‡çš„æ”¶å–ã€‚</li>
<li>Step 4ï¼šæ¯ä¸ª<code>umem</code>å¤„ç†å®Œåå…¥é˜Ÿ<code>buf_ring</code>ä¾›ä¸‹æ¬¡æ”¶åŒ…/å‘åŒ…ä½¿ç”¨ã€‚</li>
<li>Step 5ï¼šæ›´æ–°<code>rx ring</code>ä¸­çš„consumerã€‚</li>
</ul>
<h3 id="TX-procedure"><a href="#TX-procedure" class="headerlink" title="TX procedure"></a>TX procedure</h3><p>çœ‹å®Œæ”¶åŒ…æµç¨‹åï¼Œæˆ‘åŸä»¥ä¸ºä»¥ä¸ºå†…æ ¸<code>XDP</code>è¦ç›¸å¯¹åœ°æå‰åˆå§‹åŒ–ä¸€éƒ¨åˆ†<code>umem</code>ï¼Œç„¶åç”¨æˆ·æ€å‘å¯¹åº”<code>umem</code>å¡«å…¥æŠ¥æ–‡å®Œæˆå‘åŒ…ï¼Œä½†äº‹å®ä¸Šä¸æ˜¯è¿™æ ·çš„ã€‚</p>
<p>å‘åŒ…æµç¨‹ä¸­ï¼Œä½¿ç”¨<code>completion ring</code>å’Œ<code>tx ring</code>ï¼Œç”¨æˆ·æ€åº”ç”¨é¦–å…ˆå°†æŠ¥æ–‡å¡«å…¥<code>umem</code>ï¼Œå¹¶ä½œä¸ºproducerå°†<code>umem</code>å¡«å…¥<code>tx ring</code>ï¼Œå†…æ ¸<code>XDP</code>ä½œä¸ºconsumerä»<code>tx ring</code>è·å–æŠ¥æ–‡å¹¶å‘é€ã€‚å‘é€å®Œæˆåï¼Œä½œä¸ºproducerå°†å‘é€å®Œæˆçš„<code>umem</code>å¡«å…¥<code>completion ring</code>ï¼Œç”¨æˆ·æ€åº”ç”¨å†ä½œä¸ºconsumerä»<code>completion ring</code>ä¸­å›æ”¶å·²ç»å‘é€å®Œæ¯•çš„<code>umem</code>ä¾›ä¸‹ä¸€æ¬¡å‘åŒ…/æ”¶åŒ…ä½¿ç”¨ã€‚</p>
<p>ä»¥<code>af_xdp_tx_cp</code>ä¸ºä¾‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint16_t</span></span></span><br><span class="line"><span class="function"><span class="title">af_xdp_tx_cp</span><span class="params">(<span class="keyword">void</span> *<span class="built_in">queue</span>, struct rte_mbuf **bufs, <span class="keyword">uint16_t</span> nb_pkts)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">	<span class="comment">/* Step 1: Get free umem in completion ring and enqueue to buf_ring. */</span></span><br><span class="line">	pull_umem_cq(umem, nb_pkts);</span><br><span class="line"></span><br><span class="line">	nb_pkts = rte_ring_dequeue_bulk(umem-&gt;buf_ring, addrs,</span><br><span class="line">					nb_pkts, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (nb_pkts == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Step 2: Reserve tx ring. */</span></span><br><span class="line">	<span class="keyword">if</span> (xsk_ring_prod__reserve(&amp;txq-&gt;tx, nb_pkts, &amp;idx_tx) != nb_pkts) &#123;</span><br><span class="line">		kick_tx(txq);</span><br><span class="line">		rte_ring_enqueue_bulk(umem-&gt;buf_ring, addrs, nb_pkts, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nb_pkts; i++) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">xdp_desc</span> *<span class="title">desc</span>;</span></span><br><span class="line">		<span class="keyword">void</span> *pkt;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Step 3: Send every packet to umem from tx ring. */</span></span><br><span class="line">		desc = xsk_ring_prod__tx_desc(&amp;txq-&gt;tx, idx_tx + i);</span><br><span class="line">		mbuf = bufs[i];</span><br><span class="line">		desc-&gt;len = mbuf-&gt;pkt_len;</span><br><span class="line"></span><br><span class="line">		desc-&gt;addr = (<span class="keyword">uint64_t</span>)addrs[i];</span><br><span class="line">		pkt = xsk_umem__get_data(umem-&gt;mz-&gt;addr,</span><br><span class="line">					 desc-&gt;addr);</span><br><span class="line">		rte_memcpy(pkt, rte_pktmbuf_mtod(mbuf, <span class="keyword">void</span> *), desc-&gt;len);</span><br><span class="line">		tx_bytes += mbuf-&gt;pkt_len;</span><br><span class="line">		rte_pktmbuf_free(mbuf);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Step 4: Update tx ring producer index. */</span></span><br><span class="line">	xsk_ring_prod__submit(&amp;txq-&gt;tx, nb_pkts);</span><br><span class="line"></span><br><span class="line">   	<span class="comment">/* Step 5: Kick XDP. */</span></span><br><span class="line">	kick_tx(txq);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‘åŒ…æµç¨‹ä¸­å„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>Step 1ï¼šä»<code>completion ring</code>ä¸­æ£€æŸ¥æ˜¯å¦æœ‰å·²ç»å‘åŒ…å®Œæ¯•çš„<code>umem</code>ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å°†å…¶å…¥é˜Ÿ<code>buf_ring</code>ï¼Œä»¥ä¾›ä¸‹ä¸€æ¬¡å‘åŒ…/æ”¶åŒ…ä½¿ç”¨ã€‚</li>
<li>Step 2ï¼šæ£€æŸ¥<code>tx ring</code>ç©ºé—²å…ƒç´ æ•°é‡æ˜¯å¦æ»¡è¶³æœ¬æ¬¡å‘åŒ…ï¼Œå¦‚æœä¸è¶³çš„è¯ï¼Œé€šè¿‡<code>kick_tx</code>çš„æ–¹å¼è®©å†…æ ¸<code>XDP</code>å†å‘åŒ…ï¼Œä»¥é‡Šæ”¾ä¸€äº›å¯ç”¨<code>tx ring</code>ï¼ŒåŒæ—¶å°†ä¸Šä¸€æ­¥å‡ºé˜Ÿçš„<code>buf_ring</code>ä¸­çš„<code>umem</code>å†å…¥é˜Ÿã€‚</li>
<li>Step 3ï¼šå°†<code>mbuf</code>æ‹·è´åˆ°<code>tx ring</code>ä¸­å¯¹åº”çš„<code>umem</code>å®Œæˆå‘åŒ…ã€‚</li>
<li>Step 4ï¼šæ›´æ–°<code>tx ring</code>çš„producerã€‚</li>
<li>Step 5ï¼šè°ƒç”¨<code>kick_tx</code>é€šçŸ¥å†…æ ¸<code>XDP</code>æœ‰æŠ¥æ–‡å¾…å‘é€ã€‚ä¹‹å‰æåˆ°äº†<code>AF_XDP</code>çš„å‘åŒ…è¿‡ç¨‹è¿˜æ˜¯æœ‰<code>send</code>è°ƒç”¨çš„ï¼ŒåŸå› å°±åœ¨è¿™é‡Œï¼Œæ›´æ–°äº†<code>tx ring</code>åé€šè¿‡<code>send</code>é€šçŸ¥å†…æ ¸ã€‚æ”¶åŒ…æµç¨‹æ²¡æœ‰<code>recv</code>è°ƒç”¨ï¼Œå› ä¸ºæ”¶åŒ…æµç¨‹æ˜¯è½®è¯¢çš„ï¼Œä¸éœ€è¦æ”¶åˆ°æ¥è‡ªå†…æ ¸<code>XDP</code>çš„é€šçŸ¥ã€‚</li>
</ul>
<p>è¿™é‡Œçš„<code>kick_tx</code>å®é™…ä¸Šå°±æ˜¯è°ƒç”¨<code>xsk</code>å¯¹åº”çš„<code>sendmsg</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">kick_tx</span><span class="params">(struct pkt_tx_queue *txq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">xsk_umem_info</span> *<span class="title">umem</span> =</span> txq-&gt;umem;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(XDP_USE_NEED_WAKEUP)</span></span><br><span class="line">	<span class="keyword">if</span> (xsk_ring_prod__needs_wakeup(&amp;txq-&gt;tx))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		<span class="keyword">while</span> (send(xsk_socket__fd(txq-&gt;<span class="built_in">pair</span>-&gt;xsk), <span class="literal">NULL</span>,</span><br><span class="line">			    <span class="number">0</span>, MSG_DONTWAIT) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">/* some thing unexpected */</span></span><br><span class="line">			<span class="keyword">if</span> (errno != EBUSY &amp;&amp; errno != EAGAIN &amp;&amp; errno != EINTR)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* pull from completion queue to leave more space */</span></span><br><span class="line">			<span class="keyword">if</span> (errno == EAGAIN)</span><br><span class="line">				pull_umem_cq(umem, ETH_AF_XDP_TX_BATCH_SIZE);</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> XDP_UMEM_UNALIGNED_CHUNK_FLAG</span></span><br><span class="line">	pull_umem_cq(umem, ETH_AF_XDP_TX_BATCH_SIZE);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œåœ¨<code>xsk</code>çš„ä»£ç ä¸­ï¼Œä»¥<code>xsk_generic_xmit</code>ä¸ºä¾‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">xsk_generic_xmit</span><span class="params">(struct sock *sk, struct msghdr *m,</span></span></span><br><span class="line"><span class="params"><span class="function">			    <span class="keyword">size_t</span> total_len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">		skb = sock_alloc_send_skb(sk, len, <span class="number">1</span>, &amp;err);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!skb)) &#123;</span><br><span class="line">			err = -EAGAIN;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		skb_put(skb, len);</span><br><span class="line">		addr = desc.addr;</span><br><span class="line">		buffer = xdp_umem_get_data(xs-&gt;umem, addr);</span><br><span class="line">		err = skb_store_bits(skb, <span class="number">0</span>, buffer, len);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(err) || xskq_reserve_addr(xs-&gt;umem-&gt;cq)) &#123;</span><br><span class="line">			kfree_skb(skb);</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		skb-&gt;dev = xs-&gt;dev;</span><br><span class="line">		skb-&gt;priority = sk-&gt;sk_priority;</span><br><span class="line">		skb-&gt;mark = sk-&gt;sk_mark;</span><br><span class="line">		skb_shinfo(skb)-&gt;destructor_arg = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)addr;</span><br><span class="line">		skb-&gt;destructor = xsk_destruct_skb;</span><br><span class="line"></span><br><span class="line">		err = dev_direct_xmit(skb, xs-&gt;queue_id);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶é€»è¾‘å°±æ˜¯ä»<code>tx_ring</code>ä¸­è·å–æŠ¥æ–‡ï¼Œæ„é€ <code>skb</code>ï¼Œå†è°ƒç”¨<code>dev_direct_xmit</code>æœ€ç»ˆé€šè¿‡ç½‘å¡é©±åŠ¨çš„å‘åŒ…å‡½æ•°å‘é€å‡ºå»ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°æ•´ä¸ªå‘åŒ…æµç¨‹ï¼Œæ˜¯å’Œ<code>XDP</code>ç¨‹åºæ¯«æ— å…³ç³»çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¾ˆå¤šåœ°æ–¹ä¼šè¯´<code>XDP</code>åªå·¥ä½œäºæ”¶åŒ…è·¯å¾„ã€‚<code>AF_XDP</code>çš„å‘åŒ…èƒ½åŠ›æ˜¯åˆ©ç”¨äº†<code>umem</code>å®ç°çš„ï¼Œ<code>AF_XDP</code>å°†æ”¶å‘åŒ…åŠŸèƒ½å°è£…æ•´åˆï¼Œæœ€ç»ˆå‘ä¸Šå±‚æä¾›äº†ä¸€ç§åè®®æ—ã€‚</p>
<h3 id="Comparison-with-virtio-ring"><a href="#Comparison-with-virtio-ring" class="headerlink" title="Comparison with virtio ring"></a>Comparison with virtio ring</h3><p>ringè¿™å—çš„è¯å’Œ<code>virtio</code>è¿˜æ˜¯æœ‰ä¸€å®šçš„ç›¸ä¼¼æ€§çš„ï¼Œç›¸åŒçš„åœ°æ–¹åœ¨äºå‰åç«¯éƒ½æ˜¯å„é€šè¿‡ä¸€ä¸ªringæ¥é€šçŸ¥å¯¹ç«¯æœ¬ç«¯çš„å¤„ç†è¿›åº¦ï¼Œä»¥åŠé€šè¿‡ç›¸å¯¹çš„ringæ¥è·å–å¯¹ç«¯çš„å¤„ç†è¿›åº¦ï¼Œringä¸­éƒ½æ˜¯å­˜æ”¾äº†çœŸå®æè¿°ç¬¦ï¼ˆ<code>umem</code>/<code>desc ring</code>ï¼‰çš„ç´¢å¼•ã€‚ä¸åŒçš„åœ°æ–¹åœ¨äº<code>virtio</code>å¯¹äºæ”¶å‘åŒ…é˜Ÿåˆ—ï¼Œå„æœ‰ä¸€ä¸ª<code>desc ring</code>ç”¨æ¥å­˜å‚¨<code>desc</code>ã€‚<code>desc ring</code>å¯¹åº”åˆ°<code>XDP</code>å°±æ˜¯<code>umem</code>ï¼Œç„¶è€Œæ‰€æœ‰çš„æ”¶å‘åŒ…é˜Ÿåˆ—ä½¿ç”¨åŒä¸€ä¸ª<code>umem</code>ã€‚</p>
<h2 id="eBPF-map-in-AF-XDP"><a href="#eBPF-map-in-AF-XDP" class="headerlink" title="eBPF map in AF_XDP"></a>eBPF map in AF_XDP</h2><p><code>eBPF</code>ç¨‹åºå¯ä»¥é€šè¿‡<code>BPF_MAP</code>å’Œç”¨æˆ·æ€ç¨‹åºè¿›è¡Œè¿è¡Œæ—¶çš„æ•°æ®äº¤æ¢ã€‚<code>BPF_MAP</code>æ”¯æŒçš„ç±»å‹å®šä¹‰åœ¨æšä¸¾ç±»å‹<code>bpf_map_type</code>ä¸­ã€‚å¯¹<code>XDP</code>è€Œè¨€ï¼Œæ¯ä¸€ä¸ª<code>xsk</code>åˆ›å»ºæ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ª<code>BPF_MAP_TYPE_XSKMAP</code>ç±»å‹çš„<code>BPF_MAP</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">xsk_create_bpf_maps</span><span class="params">(struct xsk_socket *xsk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> max_queues;</span><br><span class="line">	<span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line">	max_queues = xsk_get_max_queues(xsk);</span><br><span class="line">	<span class="keyword">if</span> (max_queues &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> max_queues;</span><br><span class="line"></span><br><span class="line">	fd = bpf_create_map_name(BPF_MAP_TYPE_XSKMAP, <span class="string">&quot;xsks_map&quot;</span>,</span><br><span class="line">				 <span class="keyword">sizeof</span>(<span class="keyword">int</span>), <span class="keyword">sizeof</span>(<span class="keyword">int</span>), max_queues, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> fd;</span><br><span class="line"></span><br><span class="line">	xsk-&gt;xsks_map_fd = fd;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€æœ‰çš„<code>BPF_MAP</code>åç§°éƒ½å›ºå®šä¸º<code>xsks_map</code>ï¼Œ<code>key_size</code>å’Œ<code>value_size</code>éƒ½ä¸º<code>sizeof(int)</code>ï¼Œå› ä¸ºè¿™é‡Œå®é™…é€»è¾‘ä¸Šçš„keyä¸º<code>queue_id</code>ï¼Œè€Œvalueä¸º<code>xsk-&gt;fd</code>ï¼Œå…¶æ•°æ®å¤§å°éƒ½æ˜¯<code>int</code>ã€‚è¯¥<code>BPF_MAP</code>çš„æ„ä¹‰åœ¨äºæŒ‡å¯¼<code>XDP</code>ç¨‹åºï¼Œåœ¨keyå¯¹åº”çš„queueä¸Šæ”¶åˆ°æŠ¥æ–‡åï¼Œå°†æŠ¥æ–‡é‡å®šå‘åˆ°valueå¯¹åº”çš„<code>xsk</code>ã€‚</p>
<p>è¿™é‡Œè¦ç¨å¾®è¯´ä¸€ä¸‹<code>BPF_MAP</code>çš„åˆ›å»ºï¼Œ<code>libbpf</code>å°è£…çš„æ¥å£<code>bpf_create_map_name</code>æœ€ç»ˆä½¿ç”¨<code>BPF_MAP_CREATE</code>ç³»ç»Ÿè°ƒç”¨æ¥åˆ›å»ºå¯¹åº”çš„<code>BPF_MAP</code>ï¼Œä»ä¸Šè¿°ä¼ å‚å¯ä»¥çœ‹åˆ°ï¼Œå¹¶æ²¡æœ‰è®¾å¤‡æˆ–<code>xsk</code>çš„ç›¸å…³ä¿¡æ¯ä¼ å…¥ï¼Œå¯ä»¥æƒ³åˆ°ï¼Œæ‰€æœ‰çš„<code>BPF_MAP</code>éƒ½å±äºä¸€ä¸ªç»Ÿä¸€çš„namespaceï¼Œåˆ›å»ºä½¿ç”¨éƒ½ä¾æ®æœ€ç»ˆè¿”å›çš„fdè¿›è¡Œï¼Œåªè¦èƒ½å¤Ÿè·å–fdï¼Œå°±å¯ä»¥è®¿é—®ã€‚æ‰€ä»¥<code>BPF_MAP</code>æœ¬èº«ä¸å’Œè®¾å¤‡ã€<code>xsk</code>æˆ–ç‰¹å®šèµ„æºç»‘å®šï¼Œè€Œæ˜¯ç”±åˆ›å»º<code>BPF_MAP</code>çš„è°ƒç”¨è€…ä¿å­˜åˆ›å»ºåçš„fdä»¥ä¾¿äºåç»­çš„è®¿é—®å’Œç®¡ç†ã€‚å¯¹<code>AF_XDP</code>è€Œè¨€ï¼Œä¿å­˜åœ¨äº†<code>xsk-&gt;xsks_map_fd</code>ã€‚</p>
<p>æ³¨æ„è¿™é‡Œæ‰€æœ‰çš„<code>xsk</code>å¯¹åº”çš„<code>BPF_MAP</code>çš„åå­—éƒ½ç›¸åŒï¼Œä½†æ˜¯æ¯ä¸€ä¸ª<code>xsk</code>å”¯ä¸€å¯¹åº”ä¸€ä¸ª<code>xsks_map_fd</code>ã€<code>xsk-&gt;fd</code>å’Œ<code>prog_fd</code>ï¼Œå¹¶ä¸”éƒ½ä¿å­˜åœ¨<code>xsk</code>ç»“æ„ä½“ä¸­ã€‚è¿™é‡Œè¦å’Œ<code>XDP</code>ç¨‹åºattachçš„æµç¨‹ç»“åˆèµ·æ¥çœ‹ï¼Œä¸€ä¸ªè®¾å¤‡å¯¹åº”ä¸€ä¸ª<code>XDP</code>ç¨‹åºå’Œ<code>BPF_MAP</code>ï¼Œä½†ä¸€ä¸ª<code>XDP</code>ç¨‹åºå’Œ<code>BPF_MAP</code>å¯èƒ½å¯¹åº”å¤šä¸ª<code>xsk</code>ã€‚å½“å¯¹åŒä¸€ä¸ªè®¾å¤‡çš„ä¸åŒé˜Ÿåˆ—åˆ›å»ºå¤šä¸ª<code>xsk</code>æ—¶ï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡åœ¨<code>BPF_MAP</code>ä¸­å¢åŠ <code>queue_id</code>å’Œ<code>xsk-&gt;fd</code>çš„æ˜ å°„ã€‚</p>
<p>å¯¹<code>AF_XDP</code>è€Œè¨€ï¼Œåœ¨åç»­æ”¶åŒ…æµç¨‹ä¸­æ‰§è¡Œ<code>XDP</code>ç¨‹åºæ—¶ï¼Œä»<code>BPF_MAP</code>ä¸­æŸ¥æ‰¾åˆ°å¯¹åº”çš„<code>xsk</code>ï¼Œå¹¶å°†æŠ¥æ–‡æ‹·è´åˆ°<code>xsk</code>å¯¹åº”çš„<code>umem</code>ä¸­ã€‚æ‰€ä»¥<code>AF_XDP</code>çš„<code>BPF_MAP</code>å®ç°äº†<code>queue_id</code>å’Œ<code>xsk-&gt;fd</code>çš„æ˜ å°„ï¼Œç”¨äºæŒ‡å¯¼<code>XDP</code>ç¨‹åºè¿›è¡Œé‡å®šå‘ï¼Œè€Œå®ç°å†…æ ¸æ€ä¸ç”¨æˆ·æ€ä¹‹é—´è¿›è¡Œæ•°æ®äº¤äº’çš„æœºåˆ¶æ˜¯<code>umem</code>ã€‚</p>
<h2 id="Does-XDP-support-offload"><a href="#Does-XDP-support-offload" class="headerlink" title="Does XDP support offload?"></a>Does XDP support offload?</h2><p>å†…æ ¸åè®®æ ˆå®ç°äº†å¾ˆå¤šå¸è½½åŠŸèƒ½ï¼Œå¦‚<code>GRO</code>/<code>GSO</code>ï¼Œåœ¨åˆ†ç‰‡åœºæ™¯èƒ½æå¤§æå‡æ€§èƒ½ï¼Œé‚£<code>XDP</code>æ˜¯å¦æ”¯æŒè¿™äº›å¸è½½èƒ½åŠ›å‘¢ï¼Ÿ</p>
<h3 id="GRO-LRO-with-XDP"><a href="#GRO-LRO-with-XDP" class="headerlink" title="GRO/LRO with XDP?"></a>GRO/LRO with XDP?</h3><p>é¦–å…ˆçœ‹<code>GRO</code>ï¼Œä¹Ÿå°±æ˜¯æ¥æ”¶æ–¹å‘ï¼Œä»¥hookç‚¹æœ€æ™šçš„<code>SKB MODE</code>æ¥è¯´ï¼Œå…¶è°ƒç”¨è·¯å¾„ä¸ºï¼š<code>napi_gro_complete</code>-&gt;<code>netif_receive_skb_internal</code>-&gt;<code>__netif_receive_skb</code>-&gt;<code>__netif_receive_skb_core</code>-&gt;<code>do_xdp_generic</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __netif_receive_skb_core(struct sk_buff *skb, <span class="keyword">bool</span> pfmemalloc)</span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">	<span class="keyword">if</span> (static_branch_unlikely(&amp;generic_xdp_needed_key)) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret2;</span><br><span class="line"></span><br><span class="line">		preempt_disable();</span><br><span class="line">		ret2 = do_xdp_generic(rcu_dereference(skb-&gt;dev-&gt;xdp_prog), skb);</span><br><span class="line">		preempt_enable();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (ret2 != XDP_PASS)</span><br><span class="line">			<span class="keyword">return</span> NET_RX_DROP;</span><br><span class="line">		skb_reset_mac_len(skb);</span><br><span class="line">	&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»è°ƒç”¨è·¯å¾„å¯ä»¥çŸ¥é“ï¼Œåœ¨<code>skb</code>æ¥æ”¶çš„æ—©æœŸï¼Œ<code>GRO</code>å®Œæˆä¹‹å‰å°±å·²ç»æ‰§è¡Œ<code>XDP</code>ç¨‹åºäº†ã€‚æ‰€ä»¥ï¼Œé™¤é<code>XDP</code>ç¨‹åºä¸å¯¹è¯¥æŠ¥æ–‡è¿›è¡Œå¤„ç†ï¼Œä¹Ÿå°±æ˜¯<code>XDP</code>ç¨‹åºè¿”å›äº†<code>XDP_PASS</code>ï¼ŒæŠ¥æ–‡æ‰å¯èƒ½æ¥ç€è¿›å…¥<code>GRO</code>å¤„ç†æµç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>XDP</code>å¤„ç†çš„æŠ¥æ–‡ï¼Œæ˜¯æœªç»<code>GRO</code>å¤„ç†çš„ï¼Œå¯¹<code>AF_XDP</code>è€Œè¨€ï¼Œå°±æ„å‘³ç€ä¸æ”¯æŒ<code>GRO</code>ã€‚</p>
<p>é‚£æœ‰æ²¡æœ‰å¯èƒ½æ”¯æŒ<code>LRO</code>å‘¢ï¼Ÿæ¯•ç«Ÿ<code>LRO</code>ä¸éœ€è¦è¿›å…¥åè®®æ ˆå°±å¯ä»¥å®Œæˆã€‚å‡è®¾æ”¯æŒ<code>LRO</code>ï¼Œåˆ™<code>xsk</code>å°±éœ€è¦å¤„ç†å¯èƒ½å‡ºç°çš„å·¨å¸§ã€‚ä»ä¸Šé¢æ”¶å‘åŒ…æµç¨‹å¯ä»¥çŸ¥é“ï¼ŒæŠ¥æ–‡æ˜¯ç”±<code>umem</code>æ‰¿è½½çš„ï¼Œè€Œ<code>umem</code>æœ€å¤§æ”¯æŒ<code>PAGE_SIZE</code>çš„å¸§å¤§å°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">xdp_umem_reg</span><span class="params">(struct xdp_umem *umem, struct xdp_umem_reg *mr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">if</span> (chunk_size &lt; XDP_UMEM_MIN_CHUNK_SIZE || chunk_size &gt; PAGE_SIZE) &#123;</span><br><span class="line">		<span class="comment">/* Strictly speaking we could support this, if:</span></span><br><span class="line"><span class="comment">		 * - huge pages, or*</span></span><br><span class="line"><span class="comment">		 * - using an IOMMU, or</span></span><br><span class="line"><span class="comment">		 * - making sure the memory area is consecutive</span></span><br><span class="line"><span class="comment">		 * but for now, we simply say &quot;computer says no&quot;.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œæ™®é€šé¡µå¤§å°åœ¨X86æ¶æ„ä¸‹é€šå¸¸ä¸º4Kï¼Œä¹Ÿå°±æ˜¯é€šå¸¸<code>XDP</code>åªæ”¯æŒæœ€å¤§4Kçš„å¸§å¤§å°ï¼Œè¿™ä¸ªå¤§å°ä¸è¶³ä»¥ç”¨äº<code>LRO</code>ã€‚</p>
<p>å…³äº<code>LRO</code>ï¼Œä¹Ÿå¯ä»¥å‚è€ƒä¸‹<code>virtio_net</code>ä¸­çš„<code>virtnet_xdp_set</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">virtnet_xdp_set</span><span class="params">(struct net_device *dev, struct bpf_prog *prog,</span></span></span><br><span class="line"><span class="params"><span class="function">			   struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">	<span class="keyword">if</span> (!virtio_has_feature(vi-&gt;vdev, VIRTIO_NET_F_CTRL_GUEST_OFFLOADS)</span><br><span class="line">	    &amp;&amp; (virtio_has_feature(vi-&gt;vdev, VIRTIO_NET_F_GUEST_TSO4) ||</span><br><span class="line">	        virtio_has_feature(vi-&gt;vdev, VIRTIO_NET_F_GUEST_TSO6) ||</span><br><span class="line">	        virtio_has_feature(vi-&gt;vdev, VIRTIO_NET_F_GUEST_ECN) ||</span><br><span class="line">		virtio_has_feature(vi-&gt;vdev, VIRTIO_NET_F_GUEST_UFO))) &#123;</span><br><span class="line">		NL_SET_ERR_MSG_MOD(extack, <span class="string">&quot;Can&#x27;t set XDP while host is implementing LRO, disable LRO first&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">	&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨<code>virtio_net</code>å¼€å¯äº†<code>LRO</code>æ—¶ï¼Œä¹Ÿæ˜¯ä¸æ”¯æŒattachçš„ï¼ŒåŸå› ä¹Ÿæ˜¯ä¸Šé¢æçš„ï¼Œç›®å‰<code>XDP</code>å°šä¸æ”¯æŒ<code>LRO</code>ï¼Œåç»­ç†è®ºä¸Šå¯ä»¥æ”¯æŒã€‚</p>
<h3 id="GSO-TSO-with-XDP"><a href="#GSO-TSO-with-XDP" class="headerlink" title="GSO/TSO with XDP?"></a>GSO/TSO with XDP?</h3><p>å†çœ‹å‘åŒ…æ–¹å‘<code>GSO</code>ï¼Œåœ¨ä¸Šé¢å‘åŒ…æµç¨‹çš„åˆ†æä¸­å·²ç»æè¿°äº†<code>AF_XDP</code>çš„å‘åŒ…åŸç†ï¼šç›´æ¥å°†ä»<code>umem</code>è·å–åˆ°çš„åŸå§‹æŠ¥æ–‡ï¼Œè°ƒç”¨<code>dev_direct_xmit</code>ç›´æ¥é€šè¿‡ç½‘å¡é©±åŠ¨çš„å‘åŒ…å‡½æ•°å‘å‡ºï¼Œæ‰€ä»¥å¾ˆæ˜æ˜¾ï¼Œ<code>XDP</code>ä¹Ÿä¸æ”¯æŒ<code>GSO</code>ã€‚</p>
<p>é‚£æ˜¯å¦æ”¯æŒ<code>TSO</code>å‘¢ï¼Ÿå‘åŒ…æµç¨‹ä¸­è°ƒç”¨é©±åŠ¨çš„å‘åŒ…å‡½æ•°ï¼ŒæŠ¥æ–‡æ˜¯ç”±<code>skb</code>æ‰¿è½½çš„ï¼Œè€Œæ„é€ <code>skb</code>çš„æµç¨‹ä¸­ï¼Œå¹¶æ²¡æœ‰è®¾ç½®<code>skb-&gt;gso_size</code>ç­‰å¸è½½ç›¸å…³çš„å­—æ®µï¼ˆå‚è€ƒ<code>xsk_generic_xmit</code>ï¼‰ï¼Œæ‰€ä»¥<code>XDP</code>ç›®å‰å°šä¸æ”¯æŒ<code>TSO</code>ï¼Œåç»­ç†è®ºä¸Šå¯ä»¥æ”¯æŒã€‚</p>
<h1 id="libxdp-amp-libbpf"><a href="#libxdp-amp-libbpf" class="headerlink" title="libxdp &amp; libbpf"></a>libxdp &amp; libbpf</h1><p>ä¸Šé¢å·²ç»ä»‹ç»è¿‡<code>PMD_AF_XDP</code>ä½¿ç”¨äº†<code>libbpf</code><a href="https://github.com/libbpf/libbpf">^1</a>æä¾›çš„<code>xsk</code>ç›¸å…³æ¥å£äº†ï¼Œä½†ä¸Šè¿°ä»£ç åŸºäº4.18ç‰ˆæœ¬çš„å†…æ ¸ï¼Œåœ¨è¿™ä¹‹å<code>libbpf</code>è¿›è¡Œäº†å¾ˆå¤šæ”¹åŠ¨ï¼Œå…¶ä¸­åŒ…æ‹¬ä½¿ç”¨ä¸€ä¸ªæ–°çš„åº“<code>libxdp</code><a href="https://github.com/xdp-project/xdp-tools">^2</a>æ¥ç»´æŠ¤<code>XDP</code>ç›¸å…³çš„æ¥å£ã€‚</p>
<p><code>XDP</code>åº”ç”¨å¯¹ä¸åŒç‰ˆæœ¬çš„<code>libbpf</code>å¯ä»¥å‚è€ƒ<code>PMD_AF_XDP</code>çš„å¤„ç†ï¼Œæ ¹æ®ä¸åŒç‰ˆæœ¬å¼•ç”¨ä¸åŒçš„å¤´æ–‡ä»¶ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> RTE_NET_AF_XDP_LIBXDP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;xdp/xsk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bpf/xsk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>Technology</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>kernel</tag>
        <tag>network</tag>
        <tag>eBPF</tag>
        <tag>XDP</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux kernel checksum calculation and skb-&gt;ip_summed</title>
    <url>/2023/01/21/Linux-kernel-checksum-calculation-and-skb-ip-summed/</url>
    <content><![CDATA[<h1 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h1><p>æœ€è¿‘åœ¨çœ‹å†…æ ¸ç›¸å…³çš„checksumä»£ç ï¼Œèµ·å› æ˜¯å¾€è™šæ‹Ÿæœºvirtio-netå‘åŒ…æ—¶ï¼Œæƒ³é€šè¿‡<code>VIRTIO_NET_HDR_F_DATA_VALID</code>è¿™ä¸ªflagå‡å°‘GuestOSçš„æ ¡éªŒå’Œè®¡ç®—å¼€é”€ã€‚å…³äºè¿™ä¸ªflagï¼Œä»¥åŠ<code>virtio_net_hdr</code>è¿™ä¸ªç»“æ„ä½“ç›¸å…³çš„å†…å®¹ï¼Œå€¼å¾—å•ç‹¬è¯´æ˜ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œåªæ˜¯ç®€å•æä¸€ä¸‹ã€‚</p>
<p>æœ€åˆçš„ç–‘é—®æ˜¯<code>VIRTIO_NET_HDR_F_DATA_VALID</code>åˆ°åº•å¯¹åº”å‡ å±‚æ ¡éªŒå’Œï¼Ÿ</p>
<p>ä»å…¶å®šä¹‰ï¼ˆDPDK 19.11ï¼‰å¯ä»¥çœ‹åˆ°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is the first element of the scatter-gather list.  If you don&#x27;t</span></span><br><span class="line"><span class="comment"> * specify GSO or CSUM features, you can simply ignore the header.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtio_net_hdr</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VIRTIO_NET_HDR_F_NEEDS_CSUM 1    <span class="comment">/**&lt; Use csum_start,csum_offset*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VIRTIO_NET_HDR_F_DATA_VALID 2    <span class="comment">/**&lt; Checksum is valid */</span></span></span><br><span class="line">	<span class="keyword">uint8_t</span> flags;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VIRTIO_NET_HDR_GSO_NONE     0    <span class="comment">/**&lt; Not a GSO frame */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VIRTIO_NET_HDR_GSO_TCPV4    1    <span class="comment">/**&lt; GSO frame, IPv4 TCP (TSO) */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VIRTIO_NET_HDR_GSO_UDP      3    <span class="comment">/**&lt; GSO frame, IPv4 UDP (UFO) */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VIRTIO_NET_HDR_GSO_TCPV6    4    <span class="comment">/**&lt; GSO frame, IPv6 TCP */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VIRTIO_NET_HDR_GSO_ECN      0x80 <span class="comment">/**&lt; TCP has ECN set */</span></span></span><br><span class="line">	<span class="keyword">uint8_t</span> gso_type;</span><br><span class="line">	<span class="keyword">uint16_t</span> hdr_len;     <span class="comment">/**&lt; Ethernet + IP + tcp/udp hdrs */</span></span><br><span class="line">	<span class="keyword">uint16_t</span> gso_size;    <span class="comment">/**&lt; Bytes to append to hdr_len per frame */</span></span><br><span class="line">	<span class="keyword">uint16_t</span> csum_start;  <span class="comment">/**&lt; Position to start checksumming from */</span></span><br><span class="line">	<span class="keyword">uint16_t</span> csum_offset; <span class="comment">/**&lt; Offset after that to place checksum */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>virtio_net_hdr</code>åŒ…å«äº†æŠ¥æ–‡çš„<code>csum_start</code>å’Œ<code>csum_offset</code>ï¼Œä¸”åŒ…å«äº†gsoç›¸å…³å­—æ®µï¼Œä»è¿™é‡Œå¯ä»¥çŒœæµ‹ï¼Œå®ƒå°±æ˜¯æè¿°L4çš„å¸è½½ç›¸å…³å±æ€§çš„ã€‚</p>
<p>ä¸ºæ­¤å†æ¥ç€çœ‹<code>VIRTIO_NET_HDR_F_DATA_VALID</code>ç›¸å…³çš„å¤„ç†é€»è¾‘ã€‚</p>
<p>é¦–å…ˆçœ‹å†…æ ¸ï¼ˆ4.18ï¼‰ç›¸å…³å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">virtio_net_hdr_from_skb</span><span class="params">(<span class="keyword">const</span> struct sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">					  struct virtio_net_hdr *hdr,</span></span></span><br><span class="line"><span class="params"><span class="function">					  <span class="keyword">bool</span> little_endian,</span></span></span><br><span class="line"><span class="params"><span class="function">					  <span class="keyword">bool</span> has_data_valid,</span></span></span><br><span class="line"><span class="params"><span class="function">					  <span class="keyword">int</span> vlan_hlen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">	<span class="keyword">if</span> (skb-&gt;ip_summed == CHECKSUM_PARTIAL) &#123;</span><br><span class="line">		hdr-&gt;flags = VIRTIO_NET_HDR_F_NEEDS_CSUM;</span><br><span class="line">		hdr-&gt;csum_start = __cpu_to_virtio16(little_endian,</span><br><span class="line">			skb_checksum_start_offset(skb) + vlan_hlen);</span><br><span class="line">		hdr-&gt;csum_offset = __cpu_to_virtio16(little_endian,</span><br><span class="line">				skb-&gt;csum_offset);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (has_data_valid &amp;&amp;</span><br><span class="line">		   skb-&gt;ip_summed == CHECKSUM_UNNECESSARY) &#123;</span><br><span class="line">		hdr-&gt;flags = VIRTIO_NET_HDR_F_DATA_VALID;</span><br><span class="line">	&#125; <span class="comment">/* else everything is zero */</span></span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">receive_buf</span><span class="params">(struct virtnet_info *vi, struct receive_queue *rq,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">void</span> *buf, <span class="keyword">unsigned</span> <span class="keyword">int</span> len, <span class="keyword">void</span> **ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">unsigned</span> <span class="keyword">int</span> *xdp_xmit, <span class="keyword">unsigned</span> <span class="keyword">int</span> *rbytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">	<span class="keyword">if</span> (hdr-&gt;hdr.flags &amp; VIRTIO_NET_HDR_F_DATA_VALID)</span><br><span class="line">		skb-&gt;ip_summed = CHECKSUM_UNNECESSARY;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†çœ‹DPDK pmd_virtioä¸­çš„ç›¸å…³å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Optionally fill offload information in structure */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">virtio_rx_offload</span><span class="params">(struct rte_mbuf *m, struct virtio_net_hdr *hdr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (hdr-&gt;flags &amp; VIRTIO_NET_HDR_F_DATA_VALID &amp;&amp; l4_supported) &#123;</span><br><span class="line">		m-&gt;ol_flags |= PKT_RX_L4_CKSUM_GOOD;</span><br><span class="line">	&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»DPDKçš„ä»£ç ä¸­å¯ä»¥ç›´è§‚åœ°ç¡®è®¤ï¼Œå½“PMDæ”¶åˆ°æœ‰<code>VIRTIO_NET_HDR_F_DATA_VALID</code>ç½®ä½çš„æŠ¥æ–‡æ—¶ï¼Œä¸ºmbufç½®ä¸Š<code>PKT_RX_L4_CKSUM_GOOD</code>ä»¥æ ‡è¯†L4æ ¡éªŒå’Œæ­£ç¡®ï¼›å†…æ ¸å¯¹åº”çš„æƒ…å†µæ˜¯<code>skb-&gt;ip_summed == CHECKSUM_UNNECESSARY</code>ã€‚</p>
<p>è¿™é‡Œå°±æ˜¯æ¯”è¾ƒç–‘æƒ‘çš„åœ°æ–¹äº†ï¼šæ—¢ç„¶ä»ç»“æ„ä½“æœ¬èº«æˆå‘˜ï¼Œä»¥åŠDPDKä»£ç ä¸­å¤§è‡´ç¡®è®¤ï¼Œ<code>VIRTIO_NET_HDR_F_DATA_VALID</code>æ˜¯æè¿°çš„L4æ ¡éªŒå’ŒçŠ¶æ€ï¼Œä¸ºä½•å†…æ ¸ä¸­çš„ä»£ç å¯¹åº”çš„æ˜¯<code>skb-&gt;ip_summed</code>è¿™ä¸ªæˆå‘˜å‘¢ï¼Ÿä»å…¶å‘½åä¸Šçœ‹åº”è¯¥æè¿°çš„æ˜¯L3/IPçš„æ ¡éªŒå’Œæ‰å¯¹å‘€ï¼Ÿ</p>
<h1 id="skb-gt-ip-summed"><a href="#skb-gt-ip-summed" class="headerlink" title="skb-&gt;ip_summed"></a>skb-&gt;ip_summed</h1><p>é¦–å…ˆå…³æ³¨è¿™ä¸ªä»¤äººç–‘æƒ‘çš„æˆå‘˜ï¼Œåœ¨<code>skbuff.h</code>ä¸­ï¼Œæœ‰å¤§æ®µçš„æ³¨é‡Šå¯¹å…¶è¿›è¡Œäº†è¯¦ç»†çš„æè¿°ã€‚</p>
<p>ä¸‹é¢å¯¹æ¥æ”¶æ–¹å‘è¿›è¡Œè¯´æ˜ï¼Œ<code>skb-&gt;ip_summed</code>å¯èƒ½çš„å–å€¼æœ‰<code>CHECKSUM_NONE</code>ã€<code>CHECKSUM_UNNECESSARY</code>ã€<code>CHECKSUM_COMPLETE</code>å’Œ<code>CHECKSUM_PARTIAL</code>ã€‚</p>
<h2 id="CHECKSUM-NONE"><a href="#CHECKSUM-NONE" class="headerlink" title="CHECKSUM_NONE"></a>CHECKSUM_NONE</h2><p>è¿™ç§æƒ…å†µå¾ˆå¥½ç†è§£ï¼Œæ³¨é‡Šä¸Šè§£é‡Šçš„ä¹Ÿæ¯”è¾ƒæ¸…æ¥šï¼Œå½“ç¡¬ä»¶æ²¡æœ‰å¯¹æŠ¥æ–‡è¿›è¡Œæ ¡éªŒï¼ˆå¦‚ç¡¬ä»¶ä¸æ”¯æŒæ ¡éªŒç‰¹æ€§ï¼‰æ—¶ï¼Œä¼šå°†<code>skb-&gt;ip_summed</code>ç½®ä¸º<code>CHECKSUM_NONE</code>ï¼Œå¹¶ä¸”æ­¤æ—¶çš„<code>skb-&gt;csum</code>ä¹Ÿæ˜¯æ— æ„ä¹‰çš„ã€‚è½¯ä»¶é’ˆå¯¹æ­¤ç§åœºæ™¯éœ€è¦å®Œæ•´è®¡ç®—æ ¡éªŒå’Œã€‚</p>
<h2 id="CHECKSUM-COMPLETE"><a href="#CHECKSUM-COMPLETE" class="headerlink" title="CHECKSUM_COMPLETE"></a>CHECKSUM_COMPLETE</h2><p>è¿™æ˜¯æœ€é€šç”¨çš„ä¸€ç§åœºæ™¯ï¼Œç¡¬ä»¶è®¡ç®—äº†æŠ¥æ–‡ä»L4å¤´éƒ¨å¼€å§‹çš„æ•°æ®çš„1çš„è¡¥ç å’Œå¹¶ä¸”ä¿å­˜åˆ°äº†<code>skb-&gt;csum</code>ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¡¬ä»¶ä¸éœ€è¦å¯¹L3/L4è¿›è¡Œåè®®è§£æå³å¯åšåˆ°è¿™ä¸€ç‚¹ã€‚å› ä¸ºæ•´ä¸ªIPåè®®æ—ï¼ˆIPv4ã€TCPã€UDPç­‰ï¼‰çš„æ ¡éªŒå’Œè®¡ç®—æ–¹å¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå³1çš„åç å’Œçš„16bit 1çš„è¡¥ç ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µä¸‹ç¡¬ä»¶åªéœ€ä»L4å¤´éƒ¨å¼€å§‹è®¡ç®—å‰©ä½™çš„1çš„è¡¥ç å’Œå³å¯ã€‚</p>
<p>åœ¨è½¯ä»¶è®¡ç®—ç‰¹å®šçš„L4æ ¡éªŒå’Œæ—¶ï¼Œå¯ä»¥é€šè¿‡ç¡¬ä»¶è®¡ç®—çš„å®Œæ•´ç»“æœ<code>skb-&gt;csum</code>ï¼Œè¿›è¡Œè¿›ä¸€æ­¥è®¡ç®—è·å¾—æœ€ç»ˆç»“æœã€‚å¦‚ï¼šTCPé€šè¿‡<code>skb-&gt;csum</code>åŠ ä¸Šä¼ªæ ¡éªŒå’Œæ¥è®¡ç®—TCPæ ¡éªŒå’Œã€‚</p>
<h2 id="CHECKSUM-UNNECESSARY"><a href="#CHECKSUM-UNNECESSARY" class="headerlink" title="CHECKSUM_UNNECESSARY"></a>CHECKSUM_UNNECESSARY</h2><p>è¿™ç§åœºæ™¯ä¸‹ï¼Œç¡¬ä»¶å·²ç»ç¡®è®¤äº†ç‰¹å®šç±»å‹ï¼ˆTCPã€UDPã€GREã€SCPå’ŒFCoEï¼‰çš„L4åè®®çš„æ ¡éªŒå’Œæ­£ç¡®ï¼Œè½¯ä»¶æ— éœ€å†è¿›è¡Œæ ¡éªŒå’Œçš„éªŒè¯ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå°½ç®¡å·²ç»ç¡®å®šäº†ç‰¹å®šç±»å‹çš„L4æ ¡éªŒå’Œæ­£ç¡®ï¼Œ<code>skb-&gt;csum</code>è¿˜æ˜¯æœªå®šä¹‰çš„ï¼Œä¸”åç»­æµç¨‹ä¹Ÿä¸åº”è¯¥ä¿®æ”¹<code>skb-&gt;csum</code>ã€‚</p>
<h2 id="CHECKSUM-PARTIAL"><a href="#CHECKSUM-PARTIAL" class="headerlink" title="CHECKSUM_PARTIAL"></a>CHECKSUM_PARTIAL</h2><p>è¿™ç§åœºæ™¯ç¡¬ä»¶è®¡ç®—ä»<code>skb-&gt;csum_start</code>å¼€å§‹çš„æ•°æ®çš„æ ¡éªŒå’Œï¼Œå¹¶ä¿å­˜åˆ°<code>skb-&gt;csum_start + skb-&gt;csum_offset</code>çš„ä½ç½®ä¸Šã€‚</p>
<h2 id="Why-is-it-named-as-ip-summed"><a href="#Why-is-it-named-as-ip-summed" class="headerlink" title="Why is it named as ip_summed?"></a>Why is it named as ip_summed?</h2><p>ä»ä¸Šé¢çš„å–å€¼åœºæ™¯å¯ä»¥å‘ç°ï¼Œ<code>skb-&gt;ip_summed</code>æè¿°çš„æ˜¯L4çš„æ ¡éªŒå’ŒçŠ¶æ€ï¼Œè¿™å’Œå¯¹DPDKä»£ç ï¼Œä»¥åŠ<code>virtio_net_hdr</code>çš„åˆ†æçš„ç»“è®ºæ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆç”¨äº†ä¸€ä¸ªè¿™ä¹ˆä»¤äººè´¹è§£çš„å‘½åå‘¢ï¼Ÿ</p>
<p>ä¸ºæ­¤æˆ‘å‘Linux netdevçš„mailing listå‘é€äº†ä¸€å°é‚®ä»¶è¯¢é—®è¿™ä»¶äº‹ï¼Œæœ‰å¹¸å¾—åˆ°äº†å¤§ä½¬çš„è§£ç­”ï¼Œå¤§æ„æ˜¯ï¼š<strong>è™½ç„¶å‘½åç¡®å®å¾ˆä»¤äººè´¹è§£ï¼Œä½†<code>skb-&gt;ip_summed</code>æè¿°çš„æ˜¯L4çš„æ ¡éªŒå’ŒçŠ¶æ€ã€‚</strong>ä¸»è¦åŸå› æ˜¯æ•´ä¸ªIPåè®®æ—çš„æ ¡éªŒå’Œè®¡ç®—æ–¹å¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å‘½åé‡Œçš„ipä¸æ˜¯ä¸“æŒ‡IPåè®®ï¼Œè€Œæ˜¯æŒ‡IPåè®®æ—ä½¿ç”¨çš„æ ¡éªŒå’Œè®¡ç®—æ–¹å¼ã€‚å…¶å®ä¸ä»…ä»…æ˜¯<code>ip_summed</code>ï¼Œå†…æ ¸é‡Œåº”è¯¥ä¹Ÿæœ‰ä¸€äº›åœ°æ–¹çš„ipå¹¶ä¸æ˜¯ç‰¹æŒ‡IPv4åè®®ï¼Œå¦‚<code>ip_compute_csum </code>ã€‚</p>
<p>åŒæ—¶å…³äºL3/IPæ ¡éªŒå’Œï¼Œç”±äºL3/IPæ ¡éªŒå’Œåªéœ€è¦è®¡ç®—é¦–éƒ¨ï¼Œè®¡ç®—é‡ä¸å¤§ï¼Œå¹¶ä¸”åœ¨æŠ¥æ–‡æ¥æ”¶ï¼Œè§£ææŠ¥æ–‡é¦–éƒ¨æ—¶ï¼Œé¦–éƒ¨çš„å†…å®¹å·²ç»è¢«ç¼“å­˜åˆ°cacheä¸­å»äº†ï¼Œæ‰€ä»¥è½¯ä»¶è®¡ç®—çš„å¼€é”€ä¼šå¾ˆå°ï¼Œç”±å†…æ ¸è¿›è¡ŒL3/IPçš„æ ¡éªŒå’Œè®¡ç®—ã€‚</p>
<p>å®Œæ•´é‚®ä»¶è§ï¼š<a href="https://www.spinics.net/lists/netdev/msg854092.html">Confused about ip_summed member in sk_buff</a>ã€‚</p>
<h1 id="How-does-kernel-calculate-the-checksum"><a href="#How-does-kernel-calculate-the-checksum" class="headerlink" title="How does kernel calculate the checksum?"></a>How does kernel calculate the checksum?</h1><h2 id="IPv4"><a href="#IPv4" class="headerlink" title="IPv4"></a>IPv4</h2><blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Header Checksum:  16 bits</span><br><span class="line"></span><br><span class="line">  A checksum on the header only.  Since some header fields change</span><br><span class="line">  (e.g., time to live), this is recomputed and verified at each point</span><br><span class="line">  that the internet header is processed.</span><br><span class="line"></span><br><span class="line">  The checksum algorithm is:</span><br><span class="line"></span><br><span class="line">    The checksum field is the 16 bit one&#x27;s complement of the one&#x27;s</span><br><span class="line">    complement sum of all 16 bit words in the header.  For purposes of</span><br><span class="line">    computing the checksum, the value of the checksum field is zero.</span><br><span class="line">														â€”â€”RFC791</span><br></pre></td></tr></table></figure>
</blockquote>
<p>ä»IPv4æ ¡éªŒå’Œçš„å®šä¹‰å¯ä»¥çŸ¥é“ï¼Œå®ƒçš„å€¼å°±æ˜¯é¦–éƒ¨æ‰€æœ‰16bitå­—çš„1çš„è¡¥ç å’Œçš„1çš„è¡¥ç ï¼Œè®¡ç®—æ—¶ï¼Œæ ¡éªŒå’Œå­—æ®µä»¥0è®¡ç®—ã€‚</p>
<p>ä»¥å¦‚ä¸‹æŠ¥æ–‡ä¸ºä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">16:31:34.953256 00:50:56:97:d1:f3 &gt; a8:0c:ca:5f:8c:5c, ethertype IPv4 (0x0800), length 32174: (tos 0x0, ttl 64, id 5604, offset 0, flags [DF], proto TCP (6), length 32160)</span><br><span class="line">    10.103.240.223.22 &gt; 172.23.9.13.12036: Flags [.], cksum 0x2dfe (incorrect -&gt; 0x18ca), seq 74390940:74423060, ack 4837, win 64512, length 32120</span><br><span class="line">        0x0000:  a80c ca5f 8c5c 0050 5697 d1f3 0800 4500  ..._.\.PV.....E.</span><br><span class="line">        0x0010:  7da0 15e4 4000 4006 f708 0a67 f0df ac17  &#125;...@.@....g....</span><br><span class="line">        0x0020:  090d 0016 2f04 fb22 4704 23c3 2b20 5010  ..../..&quot;G.#.+.P.</span><br><span class="line">        0x0030:  fc00 2dfe 0000 33cd 52ed 85f9 888f b0aa  ..-...3.R.......</span><br><span class="line">        0x0040:  7d4e 3cd0 db58 27eb bb87 a09e ea81 c61a  &#125;N&lt;..X&#x27;.........</span><br><span class="line">        0x0050:  9119 23bd 0fa0 dd44 cae2 e84f 4c31 0241  ..#....D...OL1.A</span><br><span class="line">        0x0060:  54ee 860e 3feb 6d4e 1bd1 2ef5 faeb e2e4  T...?.mN........</span><br><span class="line">        0x0070:  6421 7c4d 3ec6 1e5f 0bd9 88ea 4776 3a5d  d!|M&gt;.._....Gv:]</span><br><span class="line">        0x0080:  0a05 abf7 fbd4 69f6 c1d9 74c9 fefc 2fc7  ......i...t.../.</span><br><span class="line">        0x0090:  c8b0 b447 ccb9 6148 9480 d78a c3e9 8e95  ...G..aH........</span><br><span class="line">        0x00a0:  1d04 c8fd 66ab 993e ecf3 7ceb 5443 adfb  ....f..&gt;..|.TC..</span><br><span class="line">        0x00b0:  a6e9 1e55 49d2 b86e 238d bac6 24aa 1b27  ...UI..n#...$..&#x27;</span><br></pre></td></tr></table></figure>

<p>IPv4é¦–éƒ¨ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">4500 7da0 15e4 4000 4006 f708 0a67 f0df ac17 090d</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æ ¡éªŒå’Œä¸ºï¼š<code>f708</code>ã€‚</p>
<p>ä¸‹é¢æ¥å®é™…ç®—ä¸€éã€‚æ ¹æ®æ ¡éªŒå’Œå®šä¹‰ï¼Œå…ˆå°†æ ¡éªŒå’Œå­—æ®µç½®é›¶ï¼Œæ‰€ä»¥IPv4é¦–éƒ¨åœ¨æœªè®¡ç®—æ ¡éªŒå’Œæ—¶ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">4500 7da0 15e4 4000 4006 0000 0a67 f0df ac17 090d</span><br></pre></td></tr></table></figure>

<p>å…ˆå°†é¦–éƒ¨æ‰€æœ‰16bitå­—ç›¸åŠ ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sum(32bit integer) = 0x4500 + 0x7da0 + 0x15e4 + 0x4000 + 0x4006 + 0x0000 + 0x0a67 + 0xf0df + 0xac17 + 0x090d</span><br><span class="line">sum(32bit integer) = 0x308f4</span><br></pre></td></tr></table></figure>

<p>å†æ ¹æ®1çš„è¡¥ç çš„åŠ æ³•åŸåˆ™ï¼Œå°†è¿›ä½åŠ å›ç»“æœï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sum(one&#x27;s complement) = 0x08f4 + 0x3 (sum + carry)</span><br><span class="line">sum(one&#x27;s complement) = 0x08f7</span><br></pre></td></tr></table></figure>

<p>å†å¯¹å’Œæ±‚16bit 1çš„è¡¥ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">csum = 16bit oneâ€™s complement(0x08f7) = 0xf708</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œè®¡ç®—å‡ºçš„ç»“æœæ­£å¥½å°±å’ŒæŠ¥æ–‡å†…åŸå§‹çš„å€¼ç›¸åŒï¼Œè¯æ˜æŠ¥æ–‡å†…çš„æ ¡éªŒå’Œå­—æ®µæ˜¯æ­£ç¡®çš„ã€‚</p>
<p>å½“ç„¶è¿˜æœ‰å¦ä¸€ç§éªŒè¯æ–¹å¼ï¼Œåœ¨è®¡ç®—16bit 1çš„è¡¥ç å’Œæ—¶ï¼Œå°†æ ¡éªŒå’Œçš„å€¼ä¹ŸåŠ å…¥è®¡ç®—ï¼Œç„¶ååˆ¤æ–­æœ€ç»ˆå€¼æ˜¯å¦ä¸º0xffffï¼ˆ16bit 1çš„è¡¥ç ä¸­çš„-0ï¼‰ã€‚</p>
<p>å†çœ‹çœ‹å†…æ ¸ä¸­é€šç”¨çš„ã€éå†…è”æ±‡ç¼–ç‰ˆæœ¬çš„IPv4æ ¡éªŒå’Œå®ç°<code>ip_fast_csum</code>ï¼Œè°ƒç”¨è·¯å¾„ä¸º<code>ip_rcv</code>-&gt;<code>ip_fast_csum</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> __sum16 <span class="title">ip_fast_csum</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *iph, <span class="keyword">unsigned</span> <span class="keyword">int</span> ihl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> *word = iph;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> *stop = word + ihl;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> csum;</span><br><span class="line">	<span class="keyword">int</span> carry;</span><br><span class="line"></span><br><span class="line">	csum = word[<span class="number">0</span>];</span><br><span class="line">	csum += word[<span class="number">1</span>];</span><br><span class="line">	carry = (csum &lt; word[<span class="number">1</span>]);</span><br><span class="line">	csum += carry;</span><br><span class="line"></span><br><span class="line">	csum += word[<span class="number">2</span>];</span><br><span class="line">	carry = (csum &lt; word[<span class="number">2</span>]);</span><br><span class="line">	csum += carry;</span><br><span class="line"></span><br><span class="line">	csum += word[<span class="number">3</span>];</span><br><span class="line">	carry = (csum &lt; word[<span class="number">3</span>]);</span><br><span class="line">	csum += carry;</span><br><span class="line"></span><br><span class="line">	word += <span class="number">4</span>;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		csum += *word;</span><br><span class="line">		carry = (csum &lt; *word);</span><br><span class="line">		csum += carry;</span><br><span class="line">		word++;</span><br><span class="line">	&#125; <span class="keyword">while</span> (word != stop);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> csum_fold(csum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå‡½æ•°å†…ï¼Œå•æ¬¡è®¡ç®—æ•°æ®å•ä½ä¸º32bitï¼Œå¹¶æ²¡æœ‰å®Œå…¨æŒ‰ç…§RFCçš„å®šä¹‰è¿›è¡Œ16bitç´¯åŠ ï¼ŒåŸå› æ˜¯32bitç´¯åŠ æ€§èƒ½æ›´å¥½ã€‚</p>
<p>å¯ä»¥å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œ16bitç´¯åŠ çš„ç»“æœåœ¨32bitç´¯åŠ ä¸­æ˜¯ç­‰æ•ˆçš„ï¼Œå½“ä½16bitç´¯åŠ å‘ç”Ÿè¿›ä½åï¼Œä¼šåŠ åˆ°é«˜16bitä¸Šå»ï¼Œé«˜16bitå†å‘ç”Ÿè¿›ä½çš„è¯ï¼Œå†åŠ å›ä½16bitã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°ä»£ç é‡Œé€šè¿‡ç´¯åŠ å’Œä¸åŠ æ•°ä¹‹é—´çš„å¤§å°æ¯”è¾ƒï¼Œæ¥ç¡®å®šæ˜¯å¦å‘ç”Ÿäº†è¿›ä½ï¼Œå¦‚æœè¿›ä½åŠ å›ç´¯åŠ å’Œã€‚</p>
<p>è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒIPv4åè®®é¦–éƒ¨æ˜¯å¯å˜é•¿åº¦ï¼Œæœ€çŸ­20å­—èŠ‚ï¼Œä¸ºä»€ä¹ˆè¿™ä¸ªç‰ˆæœ¬çš„å®ç°ä¸­ï¼Œå…ˆè®¡ç®—äº†å‰16å­—èŠ‚ï¼Œè€Œä¸æ˜¯20å­—èŠ‚å‘¢ï¼Ÿè¿™ä¸€ç‚¹æˆ‘ä¸ªäººçš„ç†è§£æ˜¯16å­—èŠ‚æ˜¯2çš„å¹‚ï¼Œè€ƒè™‘æŒ‡ä»¤ã€cacheç­‰å› ç´ ä¸‹ï¼Œåº”è¯¥æ€§èƒ½ä¼šæ›´å¥½ã€‚</p>
<p>ç´¯åŠ å’Œè®¡ç®—å®Œæˆåï¼Œè°ƒç”¨<code>csum_fold</code>å¯¹ç»“æœè¿›è¡ŒæŠ˜å å–åï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> __sum16 <span class="title">csum_fold</span><span class="params">(__wsum csum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u32 sum = (__force u32)csum;</span><br><span class="line">	sum = (sum &amp; <span class="number">0xffff</span>) + (sum &gt;&gt; <span class="number">16</span>);</span><br><span class="line">	sum = (sum &amp; <span class="number">0xffff</span>) + (sum &gt;&gt; <span class="number">16</span>);</span><br><span class="line">	<span class="keyword">return</span> (__force __sum16)~sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºå‰é¢è®¡ç®—çš„ç´¯åŠ å’Œæ˜¯32bitçš„ï¼Œæ ¹æ®1çš„è¡¥ç åŠ æ³•å®šä¹‰ï¼Œé«˜ä½16bitéœ€è¦å†åŠ åœ¨ä¸€èµ·ï¼Œæ‰æ˜¯æœ€åçš„ç»“æœã€‚ä»å½¢å¼ä¸Šçœ‹ï¼Œå°±åƒå¯¹ç´¯åŠ å’Œè¿›è¡Œäº†æŠ˜å ï¼ˆfoldï¼‰ä¸€æ ·ã€‚æŠ˜å å®Œäº†ä»¥åï¼Œå°±æ˜¯å®Œæ•´äº†1çš„è¡¥ç å’Œäº†ï¼Œå†å¯¹ç»“æœæ±‚16bit 1çš„è¡¥ç ï¼ˆå–åï¼‰ï¼Œå°±å¾—åˆ°äº†æœ€ç»ˆçš„æ ¡éªŒå’Œã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¾ˆå¤šåœ°æ–¹æŠŠæ ¡éªŒå’Œè®¡ç®—çš„è¿‡ç¨‹æè¿°æˆâ€œç´¯åŠ å–åâ€ï¼Œä½†å…‰ä»è¿™ä¸ªæè¿°å¾ˆéš¾å’ŒåŸå§‹å®šä¹‰å¯¹åº”ä¸Šã€‚</p>
<h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Checksum:  16 bits</span><br><span class="line"></span><br><span class="line">  The checksum field is the 16 bit one&#x27;s complement of the one&#x27;s</span><br><span class="line">  complement sum of all 16 bit words in the header and text.  If a</span><br><span class="line">  segment contains an odd number of header and text octets to be</span><br><span class="line">  checksummed, the last octet is padded on the right with zeros to</span><br><span class="line">  form a 16 bit word for checksum purposes.  The pad is not</span><br><span class="line">  transmitted as part of the segment.  While computing the checksum,</span><br><span class="line">  the checksum field itself is replaced with zeros.</span><br><span class="line"></span><br><span class="line">  The checksum also covers a 96 bit pseudo header conceptually </span><br><span class="line">  prefixed to the TCP header.  This pseudo header contains the Source</span><br><span class="line">  Address, the Destination Address, the Protocol, and TCP length.</span><br><span class="line">  This gives the TCP protection against misrouted segments.  This</span><br><span class="line">  information is carried in the Internet Protocol and is transferred</span><br><span class="line">  across the TCP/Network interface in the arguments or results of</span><br><span class="line">  calls by the TCP on the IP.</span><br><span class="line"></span><br><span class="line">                   +--------+--------+--------+--------+</span><br><span class="line">                   |           Source Address          |</span><br><span class="line">                   +--------+--------+--------+--------+</span><br><span class="line">                   |         Destination Address       |</span><br><span class="line">                   +--------+--------+--------+--------+</span><br><span class="line">                   |  zero  |  PTCL  |    TCP Length   |</span><br><span class="line">                   +--------+--------+--------+--------+</span><br><span class="line"></span><br><span class="line">    The TCP Length is the TCP header length plus the data length in</span><br><span class="line">    octets (this is not an explicitly transmitted quantity, but is</span><br><span class="line">    computed), and it does not count the 12 octets of the pseudo</span><br><span class="line">    header.</span><br><span class="line">                                                           --RFC793</span><br></pre></td></tr></table></figure>
</blockquote>
<p>å’ŒIPv4ç›¸æ¯”ï¼ŒTCPæ ¡éªŒå’Œé™¤äº†è¿˜è¦è®¡ç®—payloadï¼ˆtextï¼‰ä»¥å¤–ï¼Œè¿˜åŠ ä¸Šäº†ä¼ªå¤´éƒ¨ï¼ˆpseudo headerï¼‰ï¼Œç”¨äºéªŒè¯IPv4çš„ä¿¡æ¯æ˜¯å¦åŒ¹é…ã€‚ä¼ªå¤´éƒ¨æ˜¯ä¸€ä¸ªæŠ½è±¡çš„å¤´éƒ¨ï¼Œåªæ˜¯ä¸ºäº†åœ¨å››å±‚å¤´éƒ¨é¢å¤–ä¿å­˜ä¸‰å±‚ä¿¡æ¯ï¼Œä¸€å®šç¨‹åº¦ä¸Šç”¨äºç¡®è®¤ä¸‰å±‚æ­£ç¡®æ€§ï¼Œå¹¶ä¸å­˜åœ¨äºå®é™…æŠ¥æ–‡ä¸­ã€‚åŒæ—¶ï¼Œè®¡ç®—æ ¡éªŒå’Œæ—¶å¦‚æœæ€»æ•°æ®ä¸èƒ½æ•´é™¤16bitï¼Œåˆ™åœ¨æœ«å°¾è¡¥0è®¡ç®—ï¼Œè¿™éƒ¨åˆ†0åŒæ ·åªç”¨æ¥è®¡ç®—ï¼Œä¹Ÿä¸å­˜åœ¨äºå®é™…æŠ¥æ–‡ä¸­ã€‚</p>
<p>ä»¥å¦‚ä¸‹æŠ¥æ–‡ä¸ºä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">14:12:51.140861 a8:0c:ca:5f:8c:5c &gt; 00:50:56:97:d1:f3, ethertype IPv4 (0x0800), length 106: (tos 0x0, ttl 125, id 4094, offset 0, flags [DF], proto TCP (6), length 92)</span><br><span class="line">    172.23.9.13.2774 &gt; 10.103.240.223.22: Flags [P.], cksum 0xccb7 (correct), seq 0:52, ack 46045, win 32544, length 52</span><br><span class="line">        0x0000:  0050 5697 d1f3 a80c ca5f 8c5c 0800 4500  .PV......_.\..E.</span><br><span class="line">        0x0010:  005c 0ffe 4000 7d06 3d33 ac17 090d 0a67  .\..@.&#125;.=3.....g</span><br><span class="line">        0x0020:  f0df 0ad6 0016 6749 d568 1ba4 a329 5018  ......gI.h...)P.</span><br><span class="line">        0x0030:  7f20 ccb7 0000 0000 0010 f43e bdd1 e11e  ...........&gt;....</span><br><span class="line">        0x0040:  e612 f35a d406 61c9 6ed5 5f47 a7e5 5d56  ...Z..a.n._G..]V</span><br><span class="line">        0x0050:  9906 ce6e 15ac af67 e2a6 ffc8 8724 cdff  ...n...g.....$..</span><br><span class="line">        0x0060:  3d3f b304 5838 1883 71f6                 =?..X8..q.</span><br></pre></td></tr></table></figure>

<p>ä¼ªå¤´éƒ¨ï¼ˆsrc addr + dst addr + zero + protocol + l4 lengthï¼‰ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ac17 090d 0a67 f0df 0000 0006 0000 0048</span><br></pre></td></tr></table></figure>

<p>TCPé¦–éƒ¨ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0ad6 0016 6749 d568 1ba4 a329 5018 7f20 ccb7 0000</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æ ¡éªŒå’Œä¸ºï¼š<code>ccb7</code>ï¼Œè®¡ç®—æ ¡éªŒå’Œæ—¶å°†å…¶ç½®0ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0ad6 0016 6749 d568 1ba4 a329 5018 7f20 0000 0000</span><br></pre></td></tr></table></figure>

<p>payloadä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0000 0010 f43e bdd1 e11e e612 f35a d406 61c9 6ed5 5f47 a7e5 5d56 9906 ce6e 15ac af67 e2a6 ffc8 8724 cdff 3d3f b304 5838 1883 71f6</span><br></pre></td></tr></table></figure>

<p>å°†æ‰€æœ‰16bitå­—ç›¸åŠ ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sum(32bit integer) = 0xac17 + 0x090d + 0x0a67 + 0xf0df + 0x0000 + 0x0006 + 0x0000 + 0x0048 + 0x0ad6 + 0x0016 + 0x6749 + 0xd568 + 0x1ba4 + 0xa329 + 0x5018 + 0x7f20 + 0x0000 + 0x0000 + 0x0000 + 0x0010 + 0xf43e + 0xbdd1 + 0xe11e + 0xe612 + 0xf35a + 0xd406 + 0x61c9 + 0x6ed5 + 0x5f47 + 0xa7e5 + 0x5d56 + 0x9906 + 0xce6e + 0x15ac + 0xaf67 + 0xe2a6 + 0xffc8 + 0x8724 + 0xcdff + 0x3d3f + 0xb304 + 0x5838 + 0x1883 + 0x71f6</span><br><span class="line">sum(32bit integer) = 0x133335</span><br></pre></td></tr></table></figure>

<p>å†æ ¹æ®1çš„è¡¥ç çš„åŠ æ³•åŸåˆ™ï¼Œå°†è¿›ä½åŠ å›ç»“æœï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sum(one&#x27;s complement) = 0x3335 + 0x13 (sum + carry)</span><br><span class="line">sum(one&#x27;s complement) = 0x3348</span><br></pre></td></tr></table></figure>

<p>å†å¯¹å’Œæ±‚16bit 1çš„è¡¥ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">csum = 16bit oneâ€™s complement(0x3348) = 0xccb7</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œè®¡ç®—å‡ºçš„ç»“æœæ­£å¥½å°±å’ŒTCPé¦–éƒ¨çš„å€¼ç›¸åŒã€‚</p>
<p>å†…æ ¸ä¸­ä½¿ç”¨<code>csum_tcpudp_nofold</code>è®¡ç®—TCPçš„ä¼ªå¤´éƒ¨å’Œï¼Œè°ƒç”¨è·¯å¾„ï¼š<code>tcp_v4_rcv</code>-&gt;<code>skb_checksum_init</code>-&gt;<code>__skb_checksum_validate</code>-&gt;<code>inet_compute_pseudo</code>-&gt;<code>csum_tcpudp_nofold</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> u32 <span class="title">from64to32</span><span class="params">(u64 x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* add up 32-bit and 32-bit for 32+c bit */</span></span><br><span class="line">	x = (x &amp; <span class="number">0xffffffff</span>) + (x &gt;&gt; <span class="number">32</span>);</span><br><span class="line">	<span class="comment">/* add up carry.. */</span></span><br><span class="line">	x = (x &amp; <span class="number">0xffffffff</span>) + (x &gt;&gt; <span class="number">32</span>);</span><br><span class="line">	<span class="keyword">return</span> (u32)x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__wsum <span class="title">csum_tcpudp_nofold</span><span class="params">(__be32 saddr, __be32 daddr,</span></span></span><br><span class="line"><span class="params"><span class="function">			  __u32 len, __u8 proto, __wsum sum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> s = (__force u32)sum;</span><br><span class="line"></span><br><span class="line">	s += (__force u32)saddr;</span><br><span class="line">	s += (__force u32)daddr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __BIG_ENDIAN</span></span><br><span class="line">	s += proto + len;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	s += (proto + len) &lt;&lt; <span class="number">8</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> (__force __wsum)from64to32(s);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(csum_tcpudp_nofold);</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°é™¤äº†ä¹Ÿæ˜¯ç”¨32bitç›¸åŠ çš„æ–¹å¼ä»¥å¤–ï¼Œæ•´ä½“æµç¨‹ç¬¦åˆä¼ªå¤´éƒ¨å’Œè®¡ç®—çš„å®šä¹‰ã€‚è¿˜éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œä¸Šè¿°è°ƒç”¨é“¾ä¸­ï¼Œ<code>csum_tcpudp_nofold</code>çš„å‚æ•°ä¸­<code>len</code>çš„å€¼ä¸º<code>skb-&gt;len</code>ï¼Œ<code>skb-&gt;len</code>ä»£è¡¨å½“å‰åè®®å±‚æ¬¡çš„æ•°æ®é•¿åº¦ï¼Œå½“å‰ä¸ºTCPåè®®å¤„ç†æµç¨‹ï¼Œæ‰€ä»¥å¯¹åº”äº†TCPé¦–éƒ¨åŠ TCP payloadçš„æ€»é•¿ï¼›<code>sum</code>çš„å€¼ä¸º0ã€‚</p>
<p>å†çœ‹<code>skb_checksum_init</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Perform checksum validate (init). Note that this is a macro since we only</span></span><br><span class="line"><span class="comment"> * want to calculate the pseudo header which is an input function if necessary.</span></span><br><span class="line"><span class="comment"> * First we try to validate without any computation (checksum unnecessary) and</span></span><br><span class="line"><span class="comment"> * then calculate based on checksum complete calling the function to compute</span></span><br><span class="line"><span class="comment"> * pseudo header.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return values:</span></span><br><span class="line"><span class="comment"> *   0: checksum is validated or try to in skb_checksum_complete</span></span><br><span class="line"><span class="comment"> *   non-zero: value of invalid checksum</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __skb_checksum_validate(skb, proto, complete,			\</span></span><br><span class="line"><span class="meta">				zero_okay, check, compute_pseudo)	\</span></span><br><span class="line"><span class="meta">(&#123;									\</span></span><br><span class="line"><span class="meta">	__sum16 __ret = 0;						\</span></span><br><span class="line"><span class="meta">	skb-&gt;csum_valid = 0;						\</span></span><br><span class="line"><span class="meta">	<span class="meta-keyword">if</span> (__skb_checksum_validate_needed(skb, zero_okay, check))	\</span></span><br><span class="line"><span class="meta">		__ret = __skb_checksum_validate_complete(skb,		\</span></span><br><span class="line"><span class="meta">				complete, compute_pseudo(skb, proto));	\</span></span><br><span class="line"><span class="meta">	__ret;								\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> skb_checksum_init(skb, proto, compute_pseudo)			\</span></span><br><span class="line"><span class="meta">	__skb_checksum_validate(skb, proto, false, false, 0, compute_pseudo)</span></span><br></pre></td></tr></table></figure>

<p><code>skb_checksum_init</code>ç›´æ¥è°ƒç”¨äº†<code>__skb_checksum_validate</code>ï¼Œå¯ä»¥çœ‹åˆ°é‡Œé¢é€»è¾‘å…ˆå°†<code>skb-&gt;csum_valid</code>åˆå§‹åŒ–ï¼Œå†è°ƒç”¨<code>__skb_checksum_validate_needed</code>åˆ¤æ–­æ˜¯å¦éœ€è¦è®¡ç®—æ ¡éªŒå’Œï¼Œå¦‚æœéœ€è¦çš„è¯ï¼Œå†è°ƒç”¨<code>__skb_checksum_validate_complete</code>è¿›è¡Œå…·ä½“è®¡ç®—ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">skb_csum_unnecessary</span><span class="params">(<span class="keyword">const</span> struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ((skb-&gt;ip_summed == CHECKSUM_UNNECESSARY) ||</span><br><span class="line">		skb-&gt;csum_valid ||</span><br><span class="line">		(skb-&gt;ip_summed == CHECKSUM_PARTIAL &amp;&amp;</span><br><span class="line">		 skb_checksum_start_offset(skb) &gt;= <span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Check if we need to perform checksum complete validation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns true if checksum complete is needed, false otherwise</span></span><br><span class="line"><span class="comment"> * (either checksum is unnecessary or zero checksum is allowed).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> __skb_checksum_validate_needed(struct sk_buff *skb,</span><br><span class="line">						  <span class="keyword">bool</span> zero_okay,</span><br><span class="line">						  __sum16 check)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (skb_csum_unnecessary(skb) || (zero_okay &amp;&amp; !check)) &#123;</span><br><span class="line">		skb-&gt;csum_valid = <span class="number">1</span>;</span><br><span class="line">		__skb_decr_checksum_unnecessary(skb);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>__skb_checksum_validate_needed</code>ä¸­é€»è¾‘è¾ƒä¸ºç®€å•ï¼Œå½“<code>skb_csum_unnecessary</code>è¿”å›<code>true</code>æˆ–å½“å‰æ ¡éªŒå’Œ<code>check</code>ä¸º<code>0</code>å¹¶ä¸”ä¸º0çš„æ ¡éªŒå’Œæ˜¯åˆæ³•å€¼æ—¶ï¼Œå°†<code>skb-&gt;csum_valid</code>ç½®1ï¼Œå¹¶ä¸”è°ƒæ•´skbä¸­<code>CHECKSUM_UNNECESSARY</code>ç›¸å…³æˆå‘˜çš„å€¼ï¼Œè¿”å›<code>false</code>ï¼Œå¦åˆ™è¿”å›<code>true</code>ã€‚</p>
<p><code>skb_csum_unnecessary</code>ä¸­åˆ™æ˜¯æ ¹æ®<code>skb-&gt;ip_summed</code>ä»¥åŠå…¶ä»–skbçš„ä¿¡æ¯åˆ¤æ–­æ˜¯å¦æœ‰å¿…è¦è®¡ç®—æ ¡éªŒå’Œï¼š</p>
<ul>
<li><code>skb-&gt;ip_summed == CHECKSUM_UNNECESSARY</code>ï¼šæ— éœ€è®¡ç®—ï¼Œå’Œä¸Šé¢å¯¹<code>CHECKSUM_UNNECESSARY</code>çš„åˆ†æä¸€è‡´ï¼Œè¿™ç§æƒ…å†µä¸‹ç¡¬ä»¶å·²ç»ç¡®è®¤æ ¡éªŒå’Œæ­£ç¡®ï¼Œåè®®æ ˆä¸éœ€è¦ä»»ä½•è®¡ç®—ã€‚</li>
<li><code>skb-&gt;csum_valid == 1</code>ï¼šæ— éœ€è®¡ç®—ï¼Œå½“å‰åè®®å±‚æ¬¡çš„æ ¡éªŒå’Œå·²è¢«ç¡®è®¤ä¸ºåˆæ³•å€¼ã€‚</li>
<li><code>skb-&gt;ip_summed == CHECKSUM_PARTIAL &amp;&amp; skb_checksum_start_offset(skb) &gt;= 0</code>ï¼šæ— éœ€è®¡ç®—ï¼Œ<code>CHECKSUM_PARTIAL</code>ä»£è¡¨éƒ¨åˆ†æ ¡éªŒå’Œå·²è¢«ç¡¬ä»¶è®¡ç®—ï¼Œ<code>skb_checksum_start_offset(skb)</code>ä»£è¡¨<code>skb-&gt;csum_start</code>åˆæ³•ï¼Œå³å·²è¢«è®¡ç®—çš„é‚£éƒ¨åˆ†æ ¡éªŒå’Œæ˜¯åˆæ³•çš„ã€‚</li>
<li>å…¶ä»–æƒ…å†µï¼šéœ€è¦è®¡ç®—ã€‚</li>
</ul>
<p>éœ€è¦è®¡ç®—æ ¡éªŒå’Œçš„åœºæ™¯ï¼Œè°ƒç”¨<code>__skb_checksum_validate_complete</code>è¿›è¡Œè®¡ç®—ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Validate (init) checksum based on checksum complete.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return values:</span></span><br><span class="line"><span class="comment"> *   0: checksum is validated or try to in skb_checksum_complete. In the latter</span></span><br><span class="line"><span class="comment"> *	case the ip_summed will not be CHECKSUM_UNNECESSARY and the pseudo</span></span><br><span class="line"><span class="comment"> *	checksum is stored in skb-&gt;csum for use in __skb_checksum_complete</span></span><br><span class="line"><span class="comment"> *   non-zero: value of invalid checksum</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> __sum16 __skb_checksum_validate_complete(struct sk_buff *skb,</span><br><span class="line">						       <span class="keyword">bool</span> complete,</span><br><span class="line">						       __wsum psum)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (skb-&gt;ip_summed == CHECKSUM_COMPLETE) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!csum_fold(csum_add(psum, skb-&gt;csum))) &#123;</span><br><span class="line">			skb-&gt;csum_valid = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	skb-&gt;csum = psum;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (complete || skb-&gt;len &lt;= CHECKSUM_BREAK) &#123;</span><br><span class="line">		__sum16 csum;</span><br><span class="line"></span><br><span class="line">		csum = __skb_checksum_complete(skb);</span><br><span class="line">		skb-&gt;csum_valid = !csum;</span><br><span class="line">		<span class="keyword">return</span> csum;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡†ç¡®æ¥è¯´ï¼Œ<code>__skb_checksum_validate_complete</code>åªå¤„ç†<code>CHECKSUM_COMPLETE</code>ç›¸å…³çš„åœºæ™¯ã€‚</p>
<p>ç‰¹åˆ«åœ°ï¼Œå½“<code>skb-&gt;ip_summed == CHECKSUM_COMPLETE</code>æ—¶ï¼Œæ ¹æ®å‰é¢å¯¹<code>CHECKSUM_COMPLETE</code>åœºæ™¯çš„åˆ†æï¼Œæ­¤æ—¶<code>skb-&gt;csum</code>ä¿å­˜çš„æ˜¯L4å¼€å§‹çš„1çš„è¡¥ç å’Œï¼Œç›´æ¥å°†<code>skb-&gt;csum</code>å’Œ<code>psum</code>ç´¯åŠ å–åå³å¯å¾—åˆ°TCPæ ¡éªŒå’Œã€‚</p>
<p>å¯¹äºç‰¹æ®Šåœºæ™¯ï¼Œå¦‚ä¸‹é¢çš„åˆ†æ”¯ä¸­ï¼Œä¼šç›´æ¥è°ƒç”¨<code>__skb_checksum_complete</code>è¿›è¡Œå®Œæ•´è®¡ç®—ï¼Œå¦åˆ™åªä¿å­˜ä¼ªå¤´éƒ¨å’Œï¼Œåœ¨åç»­æµç¨‹ä¸­ï¼ˆå¦‚<code>tcp_v4_rcv</code>-&gt;<code>tcp_v4_do_rcv</code>-&gt;<code>tcp_checksum_complete</code>ï¼‰å†è¿›è¡Œå®Œæ•´è®¡ç®—ã€‚</p>
<p><code>tcp_checksum_complete</code>æœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨<code>__skb_checksum_complete</code>è¿›è¡Œè®¡ç®—ï¼Œå…¶ä¸­é€»è¾‘å¤§æ¦‚ä¹Ÿæ˜¯æ±‚è¡¥ç å’Œï¼Œç„¶åå–åã€‚æ±‚è¡¥ç å’Œçš„åœ°æ–¹ç›¸å¯¹æ¯”è¾ƒå¤æ‚ï¼Œæ¶‰åŠskbé“¾çš„åœºæ™¯ï¼Œå°±ä¸ç»†è¯´äº†ã€‚</p>
<h2 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h2><blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Checksum is the 16-bit one&#x27;s complement of the one&#x27;s complement sum of a</span><br><span class="line">pseudo header of information from the IP header, the UDP header, and the</span><br><span class="line">data,  padded  with zero octets  at the end (if  necessary)  to  make  a</span><br><span class="line">multiple of two octets.</span><br><span class="line">                                                               --RFC 768</span><br></pre></td></tr></table></figure>
</blockquote>
<p>UDPé¦–éƒ¨æ ¡éªŒå’Œä¸TCPæ ¡éªŒå’Œçš„è®¡ç®—æ–¹å¼åŸºæœ¬ä¸€è‡´ï¼Œä¹Ÿéœ€è¦è®¡ç®—ä¼ªå¤´éƒ¨ï¼Œä½†ä¸éœ€è¦è®¡ç®—payloadï¼Œå…·ä½“æµç¨‹å°±ä¸å±•å¼€ç»†è¯´äº†ã€‚</p>
<p>ä¸€ä¸ªå…¸å‹çš„è°ƒç”¨é“¾ï¼š<code>udp_rcv</code>-&gt;<code>__udp4_lib_rcv</code>-&gt;<code>udp4_csum_init</code>-&gt;<code>skb_checksum_init_zero_check</code>ã€‚</p>
]]></content>
      <categories>
        <category>Technology</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>kernel</tag>
        <tag>network</tag>
      </tags>
  </entry>
  <entry>
    <title>Record of using kprobe</title>
    <url>/2023/01/21/Record-of-using-kprobe/</url>
    <content><![CDATA[<h1 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h1><p>ä¹‹å‰åœ¨ç”Ÿäº§ç¯å¢ƒæ’æŸ¥äº†ä¸€ä¸ªTCPçš„ACKæ— æ³•è¢«æ­£ç¡®æ¥æ”¶ï¼Œå¯¼è‡´å‘é€ç«¯ä¸€ç›´é‡ä¼ ï¼Œæœ€ç»ˆæ¥æ”¶ç«¯keepaliveè¶…æ—¶åå…³é—­è¿æ¥çš„é—®é¢˜ï¼ˆ<a href="https://patchwork.ozlabs.org/project/netfilter-devel/patch/20220818224231.11583-1-fw@strlen.de/">[nf] netfilter: conntrack: work around exceeded receive window</a>ï¼‰ã€‚æ’æŸ¥è¿‡ç¨‹ä¸­ä¸»è¦ç”¨åˆ°äº†kprobeè¿™ä¸ªåŠ¨æ€è°ƒè¯•æ‰‹æ®µå»åˆ†æå†…æ ¸ä»£ç æ‰§è¡Œçš„æƒ…å†µï¼Œè¿™é‡Œç®€å•è®°å½•ä¸‹ã€‚</p>
<h1 id="Kprobe"><a href="#Kprobe" class="headerlink" title="Kprobe"></a>Kprobe</h1><p>kprobeæ˜¯ä¸€ç§å†…æ ¸çš„åŠ¨æ€è°ƒè¯•æœºåˆ¶ï¼Œå¯ä»¥åœ¨å‡ ä¹æ‰€æœ‰å†…æ ¸ä»£ç ä¸Šè¿›è¡Œæ’æ¡©ï¼Œå½“æ‰§è¡Œåˆ°å¯¹åº”çš„ä»£ç æ—¶ï¼Œå…ˆæ‰§è¡Œæ’æ¡©å‡½æ•°ï¼Œæ‰§è¡Œå®Œæ¯•åï¼Œåœ¨ç»§ç»­è¿è¡Œåç»­é€»è¾‘ã€‚å®ƒçš„å®ç°é€»è¾‘åŸºæœ¬ä¸Šå°±æ˜¯æŒ‡ä»¤æ›¿æ¢ï¼Œå°†è¿è¡ŒæŒ‡ä»¤è·³è½¬åˆ°ç”¨æˆ·å®šä¹‰å¥½çš„kprobe handlerã€‚</p>
<p>ä¸Šé¢è¯´äº†æ˜¯å‡ ä¹æ‰€æœ‰å†…æ ¸ä»£ç ï¼Œæœ‰å‡ ç§åœºæ™¯æ— æ³•æ­£å¸¸kprobeï¼š</p>
<ul>
<li>kprobeè‡ªèº«ç›¸å…³çš„ä»£ç ï¼šæ²¡æ³•åµŒå¥—kprobeè‡ªèº«</li>
<li>å†…è”å‡½æ•°ï¼šå†…è”å‡½æ•°åœ¨ç¼–è¯‘æ—¶ä¼šè¢«å±•å¼€åˆ°æ‰€æœ‰çš„è°ƒç”¨å¤„ï¼Œkprobeå®é™…ä¸Šæ˜¯æ ¹æ®ç¬¦å·å¯¹åº”çš„åœ°å€è¿›è¡Œçš„ï¼Œä¸èƒ½ç¡®è®¤æ‰€æœ‰å†…è”å‡½æ•°å±•å¼€åçš„åœ°å€ï¼Œè¿™ç§æƒ…å†µéœ€è¦è®¡ç®—å†…è”å‡½æ•°çš„è°ƒç”¨åœ°å€æ¥è¿›è¡Œkprobe</li>
<li>ä¸€äº›è¢«ä¼˜åŒ–åçš„é™æ€å‡½æ•°</li>
</ul>
<p>åŒæ—¶kprobeæœ‰ä¸¤ç§å®ç°å½¢å¼ï¼š</p>
<ul>
<li>åŸºäºdebugfs/ftraceçš„ç®€æ˜“å®ç°ï¼šå¯¹äºä¸€äº›ç®€å•åœºæ™¯ï¼Œå¦‚è·å–å‡½æ•°å‚æ•°ï¼Œæˆ–è€…å‡½æ•°è¿”å›å€¼çš„åœºæ™¯ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨</li>
<li>åŸºäºå†…æ ¸æ¨¡å—çš„å®ç°ï¼šå¯ä»¥å®ç°ä¸€äº›å¤æ‚åŠŸèƒ½å’Œé€»è¾‘ï¼Œé€‚ç”¨äºå¤æ‚çš„åœºæ™¯</li>
</ul>
<h2 id="kprobe-based-on-ftrace"><a href="#kprobe-based-on-ftrace" class="headerlink" title="kprobe based on ftrace"></a>kprobe based on ftrace</h2><p>ç”¨æˆ·å¯ä»¥ç›´æ¥é€šè¿‡<code>/sys/kernel/debug/tracing/kprobe_events</code>æ·»åŠ kprobeï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> p[:[GRP/][EVENT]] [MOD:]SYM[+offs]|MEMADDR [FETCHARGS]        : Set a probe</span><br><span class="line"> r[MAXACTIVE][:[GRP/][EVENT]] [MOD:]SYM[+0] [FETCHARGS]        : Set a return probe</span><br><span class="line"> p[:[GRP/][EVENT]] [MOD:]SYM[+0]%return [FETCHARGS]    : Set a return probe</span><br><span class="line"> -:[GRP/][EVENT]                                               : Clear a probe</span><br><span class="line"></span><br><span class="line">GRP            : Group name. If omitted, use &quot;kprobes&quot; for it.</span><br><span class="line">EVENT          : Event name. If omitted, the event name is generated</span><br><span class="line">                 based on SYM+offs or MEMADDR.</span><br><span class="line">MOD            : Module name which has given SYM.</span><br><span class="line">SYM[+offs]     : Symbol+offset where the probe is inserted.</span><br><span class="line">SYM%return     : Return address of the symbol</span><br><span class="line">MEMADDR        : Address where the probe is inserted.</span><br><span class="line">MAXACTIVE      : Maximum number of instances of the specified function that</span><br><span class="line">                 can be probed simultaneously, or 0 for the default value</span><br><span class="line">                 as defined in Documentation/trace/kprobes.rst section 1.3.1.</span><br><span class="line"></span><br><span class="line">FETCHARGS      : Arguments. Each probe can have up to 128 args.</span><br><span class="line"> %REG          : Fetch register REG</span><br><span class="line"> @ADDR         : Fetch memory at ADDR (ADDR should be in kernel)</span><br><span class="line"> @SYM[+|-offs] : Fetch memory at SYM +|- offs (SYM should be a data symbol)</span><br><span class="line"> $stackN       : Fetch Nth entry of stack (N &gt;= 0)</span><br><span class="line"> $stack        : Fetch stack address.</span><br><span class="line"> $argN         : Fetch the Nth function argument. (N &gt;= 1) (\*1)</span><br><span class="line"> $retval       : Fetch return value.(\*2)</span><br><span class="line"> $comm         : Fetch current task comm.</span><br><span class="line"> +|-[u]OFFS(FETCHARG) : Fetch memory at FETCHARG +|- OFFS address.(\*3)(\*4)</span><br><span class="line"> \IMM          : Store an immediate value to the argument.</span><br><span class="line"> NAME=FETCHARG : Set NAME as the argument name of FETCHARG.</span><br><span class="line"> FETCHARG:TYPE : Set TYPE as the type of FETCHARG. Currently, basic types</span><br><span class="line">                 (u8/u16/u32/u64/s8/s16/s32/s64), hexadecimal types</span><br><span class="line">                 (x8/x16/x32/x64), &quot;string&quot;, &quot;ustring&quot; and bitfield</span><br><span class="line">                 are supported.</span><br><span class="line"></span><br><span class="line"> (\*1) only for the probe on function entry (offs == 0).</span><br><span class="line"> (\*2) only for return probe.</span><br><span class="line"> (\*3) this is useful for fetching a field of data structures.</span><br><span class="line"> (\*4) &quot;u&quot; means user-space dereference. See :ref:`user_mem_access`.</span><br></pre></td></tr></table></figure>
</blockquote>
<p>å½“kprobeæ·»åŠ å®Œæˆåï¼Œä¼šç”Ÿæˆå¯¹åº”çš„kprobeç›®å½•ï¼š<code>/sys/kernel/debug/tracing/events/kprobes/&lt;EVENT&gt;</code>ï¼Œå¯ä»¥é€šè¿‡<code>/sys/kernel/debug/tracing/events/kprobes/&lt;EVENT&gt;/enable</code>å»æ§åˆ¶å¯¹åº”kprobeçš„å¯ç”¨ç¦ç”¨ã€‚</p>
<p>å®˜æ–¹ç¤ºä¾‹ï¼ˆåº”è¯¥æ˜¯32ä½çš„x86ï¼‰ï¼Œå¯¹<code>do_sys_open</code>ï¼Œå¯é€šè¿‡å¦‚ä¸‹kprobeè·å–å…¶å‚æ•°ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;p:myprobe do_sys_open dfd=%ax filename=%dx flags=%cx mode=+4($stack)&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br></pre></td></tr></table></figure>

<p>å„ä¸ªå‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>p</code>ï¼škprobeç±»å‹ä¸ºkprobe</li>
<li><code>myprobe</code>ï¼ševentåç§°</li>
<li><code>do_sys_open</code>ï¼šè¿›è¡Œkprobeçš„å‡½æ•°å</li>
<li><code>dfd=%ax filename=%dx flags=%cx mode=+4($stack)</code>ï¼šè·å–å‚æ•°å¹¶è¾“å‡ºï¼Œ<code>%ax</code>ã€<code>%dx</code>ã€<code>%cx</code>å’Œ<code>+4($stack)</code>åˆ†åˆ«ä¸ºå¯„å­˜å™¨åå­—å’Œæ ˆä¸Šåç§»</li>
</ul>
<p>å¯é€šè¿‡å¦‚ä¸‹kprobeè·å–è¿”å›å€¼ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;r:myretprobe do_sys_open $retval&#x27;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events</span><br></pre></td></tr></table></figure>

<p>å„ä¸ªå‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>r</code>ï¼škprobeç±»å‹ä¸ºkretprobe</li>
<li><code>myretprobe</code>ï¼ševentåç§°</li>
<li><code>do_sys_open</code>ï¼šè¿›è¡Œkprobeçš„å‡½æ•°å</li>
<li><code>$retval</code>ï¼šè·å–è¿”å›å€¼å¹¶è¾“å‡º</li>
</ul>
<p>å¯ç”¨è¿™ä¸¤ä¸ªkprobeï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myprobe/<span class="built_in">enable</span></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myretprobe/<span class="built_in">enable</span></span><br></pre></td></tr></table></figure>

<p>å¼€å¯ftraceï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/tracing_on</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹ç»“æœï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat /sys/kernel/debug/tracing/trace</span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#           TASK-PID    CPU#    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |       |          |         |</span></span><br><span class="line">           &lt;...&gt;-1447  [001] 1038282.286875: myprobe: (do_sys_open+0x0/0xd6) dfd=3 filename=7fffd1ec4440 flags=8000 mode=0</span><br><span class="line">           &lt;...&gt;-1447  [001] 1038282.286878: myretprobe: (sys_openat+0xc/0xe &lt;- do_sys_open) <span class="variable">$retval</span>=fffffffffffffffe</span><br><span class="line">           &lt;...&gt;-1447  [001] 1038282.286885: myprobe: (do_sys_open+0x0/0xd6) dfd=ffffff9c filename=40413c flags=8000 mode=1b6</span><br><span class="line">           &lt;...&gt;-1447  [001] 1038282.286915: myretprobe: (sys_open+0x1b/0x1d &lt;- do_sys_open) <span class="variable">$retval</span>=3</span><br><span class="line">           &lt;...&gt;-1447  [001] 1038282.286969: myprobe: (do_sys_open+0x0/0xd6) dfd=ffffff9c filename=4041c6 flags=98800 mode=10</span><br><span class="line">           &lt;...&gt;-1447  [001] 1038282.286976: myretprobe: (sys_open+0x1b/0x1d &lt;- do_sys_open) <span class="variable">$retval</span>=3</span><br></pre></td></tr></table></figure>

<p>è¯¦ç»†ä½¿ç”¨æ–¹å¼å¯ä»¥å‚è€ƒï¼š<a href="https://www.kernel.org/doc/html/latest/trace/kprobetrace.html">Kprobe-based Event Tracing</a></p>
<p>ä¸Šé¢ä¸ºç›´æ¥åœ¨debugfsä¸‹æ“ä½œï¼Œæ“ä½œæ¯”è¾ƒç¹çï¼Œä¹Ÿæœ‰ä¸€äº›ç°æˆçš„å·¥å…·<a href="https://github.com/iovisor/bpftrace">bpftrace</a>å’Œ<a href="https://github.com/brendangregg/perf-tools/blob/master/kernel/kprobe">perf-tools</a>å¯¹debugfsä¸‹çš„æ“ä½œè¿›è¡Œäº†å°è£…ï¼Œå¯ä»¥ç®€åŒ–æ“ä½œæ­¥éª¤ã€‚</p>
<h2 id="kprobe-module"><a href="#kprobe-module" class="headerlink" title="kprobe module"></a>kprobe module</h2><p>kprobeæœ€åŸå§‹çš„ä½¿ç”¨æ–¹å¼æ˜¯ç¼–è¯‘ä¸€ä¸ªå†…æ ¸æ¨¡å—ï¼Œåœ¨æ¨¡å—å†…éƒ¨è¿›è¡Œkprobeçš„æ³¨å†Œhandlerï¼Œåœ¨handlerå®ç°æ‰€éœ€è¦çš„é€»è¾‘ã€‚</p>
<p>è¿™ç§æ–¹å¼æä¾›äº†å¾ˆå¼ºå¤§çš„è‡ªç”±åº¦ï¼Œç¼ºç‚¹å°±æ˜¯ä½¿ç”¨éš¾åº¦è¾ƒé«˜ï¼Œåœ¨ä¸€äº›éœ€è¦å¤æ‚ä¸€ç‚¹çš„é€»è¾‘çš„åœ°æ–¹å¯ä»¥ä½¿ç”¨ï¼Œ<a href="https://www.kernel.org/doc/Documentation/kprobes.txt">å†…æ ¸æ–‡æ¡£</a>å¯¹è¿™ç§æ–¹å¼è¿›è¡Œäº†è¯¦ç»†è¯´æ˜ã€‚</p>
<p>ä»¥ä¸Šè¿°æ’æŸ¥ACKæ˜¯å¦æœ‰è¢«æ­£å¸¸æ¥æ”¶çš„é—®é¢˜ä¸ºä¾‹ï¼Œé€šè¿‡çœ‹ä»£ç å¯ä»¥ç¡®è®¤ï¼Œå¯¹åº”ACKå¤„ç†å‡½æ•°ä¸º<code>tcp_ack</code>ï¼Œå‚æ•°ä¸­åŒ…å«äº†<code>skb</code>ï¼ŒåŸºäºftraceçš„kprobeå¯ä»¥è·å–åˆ°<code>skb</code>ï¼Œç”šè‡³å¯ä»¥é€šè¿‡åç§»è·å–åˆ°<code>skb</code>çš„æˆå‘˜ï¼Œä½†é—®é¢˜åœ¨äºï¼Œåœ¨ä¸€ä¸ªæ­£å¸¸çš„Linuxç¯å¢ƒï¼Œæ¯ç§’å¤„ç†çš„ACKå¤ªå¤šäº†ï¼Œè¿™ç§kprobeæ²¡æ³•ç²¾ç¡®è¿‡æ»¤æ‰€éœ€å†…å®¹ï¼Œæ‰€ä»¥éœ€è¦è‡ªè¡Œç¼–å†™è¿‡æ»¤é€»è¾‘ï¼Œå¹¶è¾“å‡ºæœŸæœ›çš„å†…å®¹ã€‚</p>
<p>æ’æŸ¥è¿‡ç¨‹ä¸­ç”¨åˆ°çš„éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kprobes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/tcp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pre_tcp_ack</span><span class="params">(struct kprobe *p, struct pt_regs *regs)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kprobe</span> <span class="title">kp_tcp_ack</span> =</span> &#123;</span><br><span class="line">	.symbol_name = <span class="string">&quot;tcp_ack&quot;</span>,</span><br><span class="line">	.pre_handler = pre_tcp_ack,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pre_tcp_ack</span><span class="params">(struct kprobe *p, struct pt_regs *regs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	<span class="keyword">int</span> flag;</span><br><span class="line"></span><br><span class="line">	skb = (struct sk_buff *)regs-&gt;si;</span><br><span class="line">	<span class="keyword">if</span> (!skb) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (tcp_hdr(skb)-&gt;source != htons(<span class="number">7001</span>) &amp;&amp; tcp_hdr(skb)-&gt;dest != htons(<span class="number">7001</span>)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	flag = (<span class="keyword">int</span>)regs-&gt;dx;</span><br><span class="line">	printk(<span class="string">&quot;Get ACK: %u(%x) in tcp_ack(flag: %d).\n&quot;</span>, TCP_SKB_CB(skb)-&gt;ack_seq, TCP_SKB_CB(skb)-&gt;ack_seq, flag);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (register_kprobe(&amp;kp_tcp_ack)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	printk(<span class="string">&quot;trace-ack loaded.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fini</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	unregister_kprobe(&amp;kp_tcp_ack);</span><br><span class="line"></span><br><span class="line">	printk(<span class="string">&quot;trace-ack unloaded.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(init);</span><br><span class="line">module_exit(fini);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ•´ä½“é€»è¾‘éå¸¸ç®€å•ï¼Œåœ¨<code>module_init</code>ä¸­é€šè¿‡<code>register_kprobe</code>æ³¨å†Œkprobeï¼Œåœ¨<code>module_exit</code>ä¸­é€šè¿‡<code>unregister_kprobe</code>å–æ¶ˆkprobeçš„æ³¨å†Œã€‚</p>
<p><code>struct kprobe</code>å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kprobe</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">hlist</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* list of kprobes for multi-handler support */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*count the number of times this probe was temporarily disarmed */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> nmissed;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* location of the probe point */</span></span><br><span class="line">	<span class="keyword">kprobe_opcode_t</span> *addr;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Allow user to indicate symbol name of the probe point */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *symbol_name;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Offset into the symbol */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Called before addr is executed. */</span></span><br><span class="line">	<span class="keyword">kprobe_pre_handler_t</span> pre_handler;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Called after addr is executed, unless... */</span></span><br><span class="line">	<span class="keyword">kprobe_post_handler_t</span> post_handler;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * ... called if executing addr causes a fault (eg. page fault).</span></span><br><span class="line"><span class="comment">	 * Return 1 if it handled fault, otherwise kernel will see it.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">kprobe_fault_handler_t</span> fault_handler;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * ... called if breakpoint trap occurs in probe handler.</span></span><br><span class="line"><span class="comment">	 * Return 1 if it handled break, otherwise kernel will see it.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">kprobe_break_handler_t</span> break_handler;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Saved opcode (which has been replaced with breakpoint) */</span></span><br><span class="line">	<span class="keyword">kprobe_opcode_t</span> opcode;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* copy of the original instruction */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">arch_specific_insn</span> <span class="title">ainsn</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Indicates various status flags.</span></span><br><span class="line"><span class="comment">	 * Protected by kprobe_mutex after this kprobe is registered.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	u32 flags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æˆå‘˜å¾ˆå¤šï¼Œé€šå¸¸åªéœ€å…³æ³¨<code>handler</code>å’Œ<code>symbol</code>ï¼š</p>
<ul>
<li>handlerï¼šå¯¹åº”äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ‰€æ‰§è¡Œçš„å‡½æ•°</li>
<li>symbolï¼šéœ€è¦probeçš„ç¬¦å·åï¼Œå³å‡½æ•°å</li>
</ul>
<p>æ ¹æ®<code>symbol</code>åœ¨å®Œæˆå¯¹åº”ç±»å‹çš„<code>handler</code>ç¼–å†™ï¼Œæœ€åå°†kprobeæ³¨å†Œåˆ°å†…æ ¸ï¼Œå³å¯æ­£å¸¸å·¥ä½œã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ä¾‹å­ä¸­çš„<code>pre_handler</code>ä¸º<code>pre_tcp_ack</code>ï¼Œåœ¨å…¶å†…éƒ¨å…ˆæ˜¯è·å–åˆ°äº†<code>skb</code>ï¼Œå†æ ¹æ®ç«¯å£å·è¿‡æ»¤æ‰ä¸éœ€è¦çš„<code>skb</code>ï¼Œå†è¾“å‡ºTCPçš„<code>seq</code>å’Œ<code>ack</code>ã€‚</p>
<p>ä½¿ç”¨<code>symbol</code>æ³¨å†Œçš„kprobeåªèƒ½åœ¨ç‰¹å®šå‡½æ•°çš„å…¥å£/å‡ºå£æ‰§è¡Œï¼Œ<code>struct kprobe</code>è¿˜æœ‰æˆå‘˜<code>addr</code>å’Œ<code>offset</code>ï¼Œå¯ä»¥ç”¨äºç²¾ç¡®æŒ‡å®šprobeçš„åœ°å€ï¼Œä½†è¿™ç§ä½¿ç”¨æ–¹å¼éš¾åº¦å¾ˆå¤§ï¼Œè·å–æ‰€éœ€å‚æ•°æ—¶éœ€è¦é€šè¿‡æ±‡ç¼–ä»£ç ç¡®è®¤å¯¹åº”çš„å¯„å­˜å™¨ï¼Œå†è·å–ã€‚è€Œåœ¨å‡½æ•°å…¥å£çš„kprobeå¯ä»¥æ ¹æ®å¯¹åº”æ¶æ„çš„ä¼ å‚è§„èŒƒé€šè¿‡å¯¹åº”å¯„å­˜å™¨ç›´æ¥è·å–ï¼Œå…³äºé€šè¿‡å¯„å­˜å™¨è·å–å‡½æ•°å‚æ•°çš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥å‚è€ƒ<code>bpf_tracing.h</code>ä¸­çš„<code>PT_REGS_PARAM1</code>ç±»ä¼¼å®ã€‚</p>
<h1 id="Systemtap"><a href="#Systemtap" class="headerlink" title="Systemtap"></a>Systemtap</h1><p><a href="https://sourceware.org/systemtap/index.html">systemtap</a>æ˜¯ä¸€ä¸ªåŸºäºkprobeå¼€å‘çš„åŠ¨æ€è°ƒè¯•å·¥å…·ï¼ŒåŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œæœ‰è‡ªå·±çš„è„šæœ¬è¯­è¨€ï¼ˆå®Œæ•´è¯­æ³•è§„èŒƒå‚è€ƒ<a href="https://sourceware.org/systemtap/langref.pdf">SystemTap Language Reference</a>ï¼‰ï¼Œå¯ä»¥é€šè¿‡ç¼–å†™systemtapè„šæœ¬çš„æ–¹å¼ï¼Œç”±systemtapç”Ÿæˆå¯¹åº”çš„kprobeä»£ç å¹¶åŠ è½½åˆ°å†…æ ¸è¿è¡Œã€‚è¿™æ ·ç”¨æˆ·çš„å¼€å‘éš¾åº¦å°±å¤§å¤§é™ä½äº†ï¼Œä¸å†éœ€è¦æ‡‚å†…æ ¸ç¼–ç¨‹ï¼Œä¹Ÿä¸éœ€è¦æœ‰å†…æ ¸ç¼–è¯‘ç¯å¢ƒã€‚</p>
<p>systemtapçš„å®‰è£…ä½¿ç”¨åœ¨å¤§å¤šæ•°çš„Linuxå‘è¡Œç‰ˆä¸Šéƒ½æ¯”è¾ƒå®¹æ˜“ï¼Œç›´æ¥é€šè¿‡å¯¹åº”çš„åŒ…ç®¡ç†å·¥å…·å®‰è£…å³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åŒæ—¶éœ€è¦å®‰è£…å¯¹åº”å†…æ ¸debuginfoï¼Œå› ä¸ºsystemtapæ˜¯é€šè¿‡vmlinuxå’Œdebuginfoå»ç¡®å®šprobeç‚¹çš„ã€‚</p>
<h2 id="æ— debuginfoä½¿ç”¨systemtap"><a href="#æ— debuginfoä½¿ç”¨systemtap" class="headerlink" title="æ— debuginfoä½¿ç”¨systemtap"></a>æ— debuginfoä½¿ç”¨systemtap</h2><p>å¯¹äºæ²¡æœ‰debuginfoçš„ç”Ÿäº§ç¯å¢ƒæ˜¯å¦å¯ä»¥ä½¿ç”¨systemtapå‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¦æœ‰ç›®æ ‡ç¯å¢ƒå¯¹åº”çš„å†…æ ¸ç¼–è¯‘ç¯å¢ƒã€‚</p>
<p>å› ä¸ºsystemtapçš„å·¥ä½œåŸç†å°±æ˜¯å…ˆç”Ÿæˆå†…æ ¸æ¨¡å—å†åŠ è½½æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸¤æ­¥åˆ†å¼€ï¼Œåœ¨ç¼–è¯‘ç¯å¢ƒä¸Šç”Ÿæˆå¯¹åº”çš„å†…æ ¸æ¨¡å—ï¼Œåœ¨ç›®æ ‡ç¯å¢ƒä¸ŠåŠ è½½æ¨¡å—è¿›è¡Œè°ƒè¯•ã€‚</p>
<p>ä»¥å†…æ ¸æ¨¡å—<code>xt_state</code>ä¸­çš„å‡½æ•°<code>state_mt</code>ä¸ºä¾‹ï¼Œé¦–å…ˆæŸ¥çœ‹å¯¹åº”çš„probeç‚¹ï¼Œä»¥åŠå±€éƒ¨å˜é‡ï¼Œæ³¨æ„ä½¿ç”¨<code>-r</code>æŒ‡å®šå†…æ ¸ä»£ç è·¯å¾„ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@docker &lt;bca7e9fa6017&gt; /home ]<span class="comment">#stap -r /home/kernel.rh8/ -L &#x27;module(&quot;xt_state&quot;).function(&quot;state_mt@net/netfilter/xt_state.c&quot;)&#x27;</span></span><br><span class="line">module(<span class="string">&quot;xt_state&quot;</span>).<span class="keyword">function</span>(<span class="string">&quot;state_mt@net/netfilter/xt_state.c:24&quot;</span>) <span class="variable">$skb</span>:struct sk_buff const* <span class="variable">$par</span>:struct xt_action_param* <span class="variable">$sinfo</span>:struct xt_state_info const*</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å°†<code>function</code>æ¢æˆ<code>statement</code>ï¼Œä»¥å°†probeç‚¹æŒ‡å®šåˆ°å…·ä½“è¡Œï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@docker &lt;bca7e9fa6017&gt; /home ]<span class="comment">#sed -n &#x27;23, 39p&#x27; /home/kernel.rh8/net/netfilter/xt_state.c</span></span><br><span class="line">static bool</span><br><span class="line">state_mt(const struct sk_buff *skb, struct xt_action_param *par)</span><br><span class="line">&#123;</span><br><span class="line">        const struct xt_state_info *sinfo = par-&gt;matchinfo;</span><br><span class="line">        enum ip_conntrack_info ctinfo;</span><br><span class="line">        unsigned int statebit;</span><br><span class="line">        struct nf_conn *ct = nf_ct_get(skb, &amp;ctinfo);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ct) /* line 31 */</span><br><span class="line">                statebit = XT_STATE_BIT(ctinfo);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ctinfo == IP_CT_UNTRACKED)</span><br><span class="line">                statebit = XT_STATE_UNTRACKED;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                statebit = XT_STATE_INVALID;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> (sinfo-&gt;statemask &amp; statebit);</span><br><span class="line">&#125;</span><br><span class="line">[root@docker &lt;bca7e9fa6017&gt; /home ]<span class="comment">#stap -r /home/kernel.rh8/ -L &#x27;module(&quot;xt_state&quot;).statement(&quot;*@net/netfilter/xt_state.c:31&quot;)&#x27;</span></span><br><span class="line">module(<span class="string">&quot;xt_state&quot;</span>).statement(<span class="string">&quot;state_mt@net/netfilter/xt_state.c:31&quot;</span>) <span class="variable">$skb</span>:struct sk_buff const* <span class="variable">$par</span>:struct xt_action_param* <span class="variable">$sinfo</span>:struct xt_state_info const* <span class="variable">$ctinfo</span>:enum ip_conntrack_info</span><br><span class="line">[root@docker &lt;bca7e9fa6017&gt; /home ]<span class="comment">#stap -r /home/kernel.rh8/ -L &#x27;module(&quot;xt_state&quot;).statement(&quot;*@net/netfilter/xt_state.c:38&quot;)&#x27;</span></span><br><span class="line">module(<span class="string">&quot;xt_state&quot;</span>).statement(<span class="string">&quot;state_mt@net/netfilter/xt_state.c:38&quot;</span>) <span class="variable">$skb</span>:struct sk_buff const* <span class="variable">$par</span>:struct xt_action_param* <span class="variable">$sinfo</span>:struct xt_state_info const* <span class="variable">$statebit</span>:unsigned int</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åœ¨ä¸åŒçš„probeç‚¹ï¼Œå¯ä»¥è®¿é—®çš„å±€éƒ¨å˜é‡ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œä½†æ˜¯å…³äºå±€éƒ¨å˜é‡è¿˜æœ‰ä¸€ç‚¹ç–‘æƒ‘ï¼šä»¥31è¡Œä¸ºä¾‹ï¼Œå…¶å®åº”è¯¥æ˜¯è¿˜èƒ½è®¿é—®<code>statebit</code>å’Œ<code>ct</code>è¿™ä¸¤ä¸ªå˜é‡çš„ï¼Œä½†probeæ˜¾ç¤ºå‡ºæ¥çš„å˜é‡å¹¶ä¸åŒ…å«è¿™ä¸¤ä¸ªï¼Œå¯èƒ½æ˜¯å¯¹å˜é‡åšäº†ä¸€äº›ä¼˜åŒ–ï¼Œä¸€äº›è¿˜æ²¡èµ‹å€¼çš„å˜é‡ï¼ˆ<code>statebit</code>ï¼‰å’Œä¸€äº›å˜é‡å¯ä»¥é—´æ¥é€šè¿‡å…¶ä»–å˜é‡è·å–ï¼ˆ<code>ct</code>ï¼‰è¢«ä¼˜åŒ–æ‰äº†ã€‚</p>
<p>ç¼–å†™å¦‚ä¸‹systemtapè„šæœ¬ç”¨äºåœ¨<code>state_mt</code>å†…éƒ¨è¾“å‡º<code>ctinfo</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Part 1: Global embedded C include */</span></span><br><span class="line">%&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter/x_tables.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter/xt_state.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/tcp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/netfilter/nf_conntrack_core.h&gt;</span></span></span><br><span class="line">%&#125;</span><br><span class="line"><span class="comment">/* Part 1 end */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Part2: Embedded C function */</span></span><br><span class="line"><span class="function">function <span class="title">print_ctinfo</span> <span class="params">(skb, ctinfo)</span></span></span><br><span class="line"><span class="function">%</span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">th</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">ip_conntrack_info</span> <span class="title">ctinfo</span>;</span></span><br><span class="line"></span><br><span class="line">	skb = (struct sk_buff *)STAP_ARG_skb;</span><br><span class="line">	<span class="keyword">if</span> (!skb) &#123;</span><br><span class="line">		STAP_RETURN();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (skb-&gt;protocol != htons(ETH_P_IP)) &#123;</span><br><span class="line">		STAP_RETURN();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	iph = ip_hdr(skb);</span><br><span class="line">	<span class="keyword">if</span> (!iph) &#123;</span><br><span class="line">		STAP_RETURN();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iph-&gt;protocol != IPPROTO_TCP) &#123;</span><br><span class="line">		STAP_RETURN();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	th = tcp_hdr(skb);</span><br><span class="line">	<span class="keyword">if</span> (!th) &#123;</span><br><span class="line">		STAP_RETURN();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (th-&gt;dest != htons(<span class="number">22</span>)) &#123;</span><br><span class="line">		STAP_RETURN();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ctinfo = STAP_ARG_ctinfo;</span><br><span class="line">	<span class="keyword">if</span> (printk_ratelimit()) &#123;</span><br><span class="line">		printk(<span class="string">&quot;[%s] Capture TCP packet: %hu.%hu.%hu.%hu:%hu-&gt;%hu.%hu.%hu.%hu:%hu with ctinfo: %d.\n&quot;</span>,</span><br><span class="line">			   __func__,</span><br><span class="line">			   iph-&gt;saddr &amp; <span class="number">0xff</span>, (iph-&gt;saddr &amp; <span class="number">0xff00</span>) &gt;&gt; <span class="number">8</span>, (iph-&gt;saddr &amp; <span class="number">0xff0000</span>) &gt;&gt; <span class="number">16</span>, (iph-&gt;saddr &amp; <span class="number">0xff000000</span>) &gt;&gt; <span class="number">24</span>,</span><br><span class="line">			   ntohs(th-&gt;source),</span><br><span class="line">			   iph-&gt;daddr &amp; <span class="number">0xff</span>, (iph-&gt;daddr &amp; <span class="number">0xff00</span>) &gt;&gt; <span class="number">8</span>, (iph-&gt;daddr &amp; <span class="number">0xff0000</span>) &gt;&gt; <span class="number">16</span>, (iph-&gt;daddr &amp; <span class="number">0xff000000</span>) &gt;&gt; <span class="number">24</span>,</span><br><span class="line">			   ntohs(th-&gt;dest),</span><br><span class="line">			   ctinfo);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	STAP_RETURN();</span><br><span class="line">%&#125;</span><br><span class="line"><span class="comment">/* Part 2 end */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Part 3: Probes */</span></span><br><span class="line"><span class="function">probe <span class="title">module</span><span class="params">(<span class="string">&quot;xt_state&quot;</span>)</span>.<span class="title">statement</span><span class="params">(<span class="string">&quot;state_mt@net/netfilter/xt_state.c:31&quot;</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	print_ctinfo($skb, $ctinfo)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">probe begin</span><br><span class="line">&#123;</span><br><span class="line">	print(<span class="string">&quot;probe start.\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">probe end</span><br><span class="line">&#123;</span><br><span class="line">	print(<span class="string">&quot;probe end.\n&quot;</span>)</span><br><span class="line">	<span class="built_in">exit</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Part3 end */</span></span><br></pre></td></tr></table></figure>

<p>è„šæœ¬åˆ†ä¸º3éƒ¨åˆ†ï¼š</p>
<ul>
<li>Part 1ï¼šåµŒå…¥çš„Cä»£ç çš„å…¨å±€includeï¼Œå› ä¸ºåç»­åµŒå…¥çš„Cå‡½æ•°éœ€è¦ä¸€äº›å¤´æ–‡ä»¶ï¼Œæ‰€ä»¥åœ¨å¼€å¤´å®šä¹‰å¥½ã€‚</li>
<li>Part 2ï¼šåŠŸèƒ½å‡½æ•°<code>print_ctinfo</code>ï¼Œæ¥å—ä¸¤ä¸ªå‚æ•°<code>skb</code>å’Œ<code>ctinfo</code>ã€‚</li>
<li>Part 3ï¼šå£°æ˜æ¢æµ‹ç‚¹probe</li>
</ul>
<p>Part 1å’ŒPart 2ä½¿ç”¨äº†åµŒå…¥Cä»£ç ï¼Œå…³äºåµŒå…¥Cä»£ç ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š</p>
<ul>
<li>æœ€å¤–å±‚ä½¿ç”¨<code>%&#123;...%&#125;</code>è¿™æ ·çš„æ‹¬å·</li>
<li>è·å–å‡½æ•°å‚æ•°é€šè¿‡<code>STAP_ARG_</code>å‰ç¼€åŠ ä¸Šå‚æ•°åè·å–ï¼Œå¦‚<code>STAP_ARG_skb</code></li>
<li>å‡½æ•°å†…éƒ¨ä½¿ç”¨<code>STAP_RETURN()</code>è¿›è¡Œè¿”å›ï¼Œå‚æ•°ä¸ä¸ºç©ºæ—¶å¯ä»¥ä¸ºå­—ç¬¦ä¸²æˆ–æ•´æ•°ï¼Œå’Œå‡½æ•°å®šä¹‰æ—¶çš„è¿”å›ç±»å‹ç›¸åŒã€‚</li>
<li>å‡½æ•°å†…éƒ¨ä½¿ç”¨<code>STAP_RETVALUE</code>ä½œä¸ºè¿”å›å€¼ï¼Œå¯ä»¥ä¸ºæ•´æ•°æˆ–å­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²è¿”å›æ—¶éœ€ä½¿ç”¨<code>snprintf</code>ç±»ä¼¼çš„å‡½æ•°ä¸ºå…¶èµ‹å€¼ã€‚</li>
</ul>
<p>Part 2ä¸­<code>print_ctinfo</code>å†…éƒ¨é€šè¿‡å‚æ•°è·å–åˆ°<code>skb</code>å’Œ<code>ctinfo</code>ï¼Œå¹¶è¿›è¡Œåˆæ³•æ€§æ£€æŸ¥ï¼Œé€šè¿‡åˆæ³•æ€§æ£€æŸ¥åï¼Œç›´æ¥é€šè¿‡<code>printk</code>è¾“å‡º<code>skb</code>å’Œ<code>ctinfo</code>ç›¸å…³çš„ä¿¡æ¯ã€‚</p>
<p>Part 3ä¸­å®šä¹‰äº†3ä¸ªprobeï¼Œåˆ†åˆ«ä¸º<code>xt_state.c</code>ç¬¬31è¡Œå¯¹åº”åœ°å€çš„probeï¼Œä»¥åŠä¸¤ä¸ªå†…å»ºprobe start å’Œendï¼Œåˆ†åˆ«åœ¨è¿è¡Œçš„å¼€å§‹å’Œç»“æŸå¤„è°ƒç”¨ã€‚</p>
<p>systemtapè„šæœ¬ç¼–å†™å®Œæˆåï¼Œå³å¯ä½¿ç”¨<code>stap</code>å‘½ä»¤ç¼–è¯‘å¯¹åº”çš„æ¨¡å—ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@docker &lt;bca7e9fa6017&gt; /home ]<span class="comment">#stap -r /home/kernel.rh8 -DSTP_NO_OVERLOAD -DSTP_NO_VERREL_CHECK  -DSTP_NO_BUILDID_CHECK -v -p4 -m print_ctinfo.ko -g print_ctinfo.stp </span></span><br><span class="line">Truncating module name to <span class="string">&#x27;print_ctinfo&#x27;</span></span><br><span class="line">Pass 1: parsed user script and 484 library scripts using 155264virt/96900res/2956shr/93944data kb, <span class="keyword">in</span> 290usr/50sys/337real ms.</span><br><span class="line">Pass 2: analyzed script: 3 probes, 4 <span class="built_in">functions</span>, 1 embed, 0 globals using 157656virt/100236res/3944shr/96336data kb, <span class="keyword">in</span> 50usr/380sys/431real ms.</span><br><span class="line">Pass 3: translated to C into <span class="string">&quot;/tmp/stap7rcpFZ/print_ctinfo_src.c&quot;</span> using 157920virt/100756res/4216shr/96600data kb, <span class="keyword">in</span> 30usr/380sys/414real ms.</span><br><span class="line">print_ctinfo.ko</span><br><span class="line">Pass 4: compiled C into <span class="string">&quot;print_ctinfo.ko&quot;</span> <span class="keyword">in</span> 2270usr/760sys/2612real ms.</span><br><span class="line">[root@docker &lt;bca7e9fa6017&gt; /home ]<span class="comment">#file print_ctinfo.ko </span></span><br><span class="line">print_ctinfo.ko: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), BuildID[sha1]=0xd1741342db5acb8c31f82e5684273aae24125c82, not stripped</span><br></pre></td></tr></table></figure>

<p><code>stap</code>çš„æ‰§è¡Œä¸€å…±æœ‰5ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ä¸ºï¼š<code>parse</code>ã€<code>elaborate</code>ã€<code>translate</code>ã€<code>compile</code>å’Œ<code>run</code>ï¼Œå¯ä»¥é€šè¿‡<code>-p</code>æŒ‡å®šæ‰§è¡Œé˜¶æ®µã€‚ä¸Šè¿°æŒ‡å®šäº†<code>-p4</code>çš„å‘½ä»¤æœ€ç»ˆç¼–è¯‘å‡ºäº†å¯ç”¨çš„å†…æ ¸æ¨¡å—<code>print_ctinfo.ko</code>ã€‚</p>
<p>åœ¨è¿è¡Œç¯å¢ƒä¸Šï¼Œåˆ™å¯ä»¥ç›´æ¥é€šè¿‡<code>staprun</code>å‘½ä»¤è¿›è¡Œprobeï¼Œè¯¥å‘½ä»¤ä¼šè‡ªåŠ¨åŠ è½½æ¨¡å—ï¼Œå‘½ä»¤æ‰§è¡Œå®Œæˆåï¼Œä¼šè‡ªåŠ¨å¸è½½æ¨¡å—ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ./staprun print_ctinfo.ko</span></span><br><span class="line">probe start.</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶è§‚å¯Ÿå†…æ ¸æ—¥å¿—ï¼Œå¯ä»¥æ‰¾åˆ°æœŸæœ›çš„è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°æˆåŠŸè¿‡æ»¤äº†ç»è¿‡<code>state_mt</code>çš„SSHæŠ¥æ–‡å¹¶ä¸”è¾“å‡ºäº†ç›¸å…³ä¿¡æ¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2022-12-08 17:37:07.614013 warning [kernel:] [171938.274058] [function___global_print_ctinfo__overload_0] Capture TCP packet: 172.23.9.13:7037-&gt;10.103.240.223:22 with ctinfo: 0.</span><br><span class="line">2022-12-08 17:37:07.623029 warning [kernel:] [171938.283066] [function___global_print_ctinfo__overload_0] Capture TCP packet: 10.103.241.85:51515-&gt;10.103.240.223:22 with ctinfo: 0.</span><br><span class="line">2022-12-08 17:37:07.623997 warning [kernel:] [171938.284053] [function___global_print_ctinfo__overload_0] Capture TCP packet: 172.23.9.13:7037-&gt;10.103.240.223:22 with ctinfo: 0.</span><br></pre></td></tr></table></figure>

<p><code>stap</code>åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šå°†ç”Ÿæˆçš„Cä»£ç æ”¾åœ¨ä¸´æ—¶ç›®å½•ï¼Œå¯ä»¥é€šè¿‡<code>-k</code>é€‰é¡¹ä¿ç•™ä¸´æ—¶ç›®å½•ï¼Œç„¶åæŸ¥çœ‹å¯¹åº”çš„Cä»£ç ã€‚ä¸Šè¿°è‡ªå®šä¹‰å‡½æ•°<code>print_ctinfo</code>ç”Ÿæˆçš„ç›®æ ‡Cä»£ç éƒ¨åˆ†å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">function___global_print_ctinfo__overload_0</span> <span class="params">(struct context* __restrict__ c)</span> </span>&#123;</span><br><span class="line">  __label__ deref_fault;</span><br><span class="line">  __label__ out;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">function___global_print_ctinfo__overload_0_locals</span> *  __<span class="title">restrict__</span> <span class="title">l</span> =</span> &amp; c-&gt;locals[c-&gt;nesting+<span class="number">1</span>].function___global_print_ctinfo__overload_0;</span><br><span class="line">  (<span class="keyword">void</span>) l;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> CONTEXT c</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> THIS l</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> STAP_ARG_skb THIS-&gt;l_skb</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> STAP_ARG_ctinfo THIS-&gt;l_ctinfo</span></span><br><span class="line">  c-&gt;last_stmt = <span class="string">&quot;identifier &#x27;print_ctinfo&#x27; at print_ctinfo.stp:8:10&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> (unlikely (c-&gt;nesting+<span class="number">1</span> &gt;= MAXNESTING)) &#123;</span><br><span class="line">    c-&gt;last_error = <span class="string">&quot;MAXNESTING exceeded&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    c-&gt;nesting ++;</span><br><span class="line">  &#125;</span><br><span class="line">  c-&gt;next = <span class="number">0</span>;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> STAP_NEXT do &#123; c-&gt;next = 1; goto out; &#125; while(0)</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> STAP_RETURN() do &#123; goto out; &#125; while(0)</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> STAP_PRINTF(fmt, ...) do &#123; _stp_printf(fmt, ##__VA_ARGS__); &#125; while (0)</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> STAP_ERROR(...) do &#123; snprintf(CONTEXT-&gt;error_buffer, MAXSTRINGLEN, __VA_ARGS__); CONTEXT-&gt;last_error = CONTEXT-&gt;error_buffer; goto out; &#125; while (0)</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> return goto out</span></span><br><span class="line">  <span class="keyword">if</span> (c-&gt;actionremaining &lt; <span class="number">0</span>) &#123; c-&gt;last_error = <span class="string">&quot;MAXACTION exceeded&quot;</span>;<span class="keyword">goto</span> out; &#125;</span><br><span class="line">  &#123;</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">th</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">enum</span> <span class="title">ip_conntrack_info</span> <span class="title">ctinfo</span>;</span></span><br><span class="line"></span><br><span class="line">        skb = (struct sk_buff *)STAP_ARG_skb;</span><br><span class="line">        <span class="keyword">if</span> (!skb) &#123;</span><br><span class="line">                STAP_RETURN();</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ä¸€äº›åœ¨å‡½æ•°ä½“å†…éƒ¨ä½¿ç”¨çš„å®ï¼Œå¦‚<code>STAP_RETURN</code>ï¼Œåœ¨å‡½æ•°å¼€å¤´éƒ½æœ‰å®šä¹‰ï¼Œç”Ÿæˆçš„å‡½æ•°å<code>function___global_print_ctinfo__overload_0</code>ä¹Ÿå’Œå†…æ ¸æ—¥å¿—ä¸­ä¸€è‡´ã€‚</p>
<p>é™¤äº†å†…æ ¸å‡½æ•°çš„probeï¼Œsystemtapè¿˜æ”¯æŒè®¸å¤šå…¶ä»–ç±»å‹çš„probeï¼Œå¯é€šè¿‡<code>stap --dump-probe-types</code>æŸ¥çœ‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@docker &lt;bca7e9fa6017&gt; /home ]<span class="comment">#stap -r /home/kernel.rh8 --dump-probe-types</span></span><br><span class="line">......</span><br><span class="line">netfilter.hook(string).pf(string)</span><br><span class="line">netfilter.hook(string).pf(string).priority(string)</span><br><span class="line">netfilter.pf(string).hook(string)</span><br><span class="line">netfilter.pf(string).hook(string).priority(string)</span><br><span class="line">......</span><br><span class="line">process(string).begin</span><br><span class="line">process(string).end</span><br><span class="line">......</span><br><span class="line">procfs(string).<span class="built_in">read</span></span><br><span class="line">procfs(string).read.maxsize(number)</span><br><span class="line">......</span><br><span class="line">python2.module(string).<span class="keyword">function</span>(string)</span><br><span class="line">python2.module(string).<span class="keyword">function</span>(string).call</span><br><span class="line">python2.module(string).<span class="keyword">function</span>(string).<span class="built_in">return</span></span><br><span class="line">python3.module(string).<span class="keyword">function</span>(string)</span><br><span class="line">python3.module(string).<span class="keyword">function</span>(string).call</span><br><span class="line">python3.module(string).<span class="keyword">function</span>(string).<span class="built_in">return</span></span><br><span class="line">......</span><br><span class="line">timer.hz(number)</span><br><span class="line">timer.jiffies(number)</span><br><span class="line">timer.jiffies(number).randomize(number)</span><br></pre></td></tr></table></figure>

<p>åŒ…å«äº†è®¸å¤šé’ˆå¯¹ç‰¹å®šåœºæ™¯çš„probeï¼ŒåŒ…æ‹¬å¯¹ç”¨æˆ·æ€çš„è¿›ç¨‹ã€pythonæ¨¡å—ç­‰ã€‚</p>
]]></content>
      <categories>
        <category>Technology</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>A multiplication overflow problem</title>
    <url>/2023/01/21/A-multiplication-overflow-problem/</url>
    <content><![CDATA[<h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p>æˆ‘å¸äº§å“ä»å†…æ ¸ctæŠ„äº†ä¸€ä»½ipè§£æçš„ä»£ç åœ¨åº”ç”¨å±‚ä½¿ç”¨ï¼Œåœ¨å®¢æˆ·è·‘ä¸šåŠ¡çš„æ—¶å€™coredumpæ‰äº†ï¼Œä»å †æ ˆåˆ†æçœ‹æ˜¯åšä¹˜æ³•è¿‡ç¨‹ä¸­æ•´æ•°æº¢å‡ºabortäº†ï¼Œåœ¨è¿™é‡Œç®€å•è®°å½•ä¸‹ã€‚</p>
<h1 id="in4-pton"><a href="#in4-pton" class="headerlink" title="in4_pton"></a>in4_pton</h1><p>é—®é¢˜å‡½æ•°ä¸º<code>in4_pton</code>ï¼Œç”¨äºå°†å­—ç¬¦ä¸²ipè½¬æ¢æˆäºŒè¿›åˆ¶ipï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * in4_pton - convert an IPv4 address from literal to binary representation</span></span><br><span class="line"><span class="comment"> * @src: the start of the IPv4 address string</span></span><br><span class="line"><span class="comment"> * @srclen: the length of the string, -1 means strlen(src)</span></span><br><span class="line"><span class="comment"> * @dst: the binary (u8[4] array) representation of the IPv4 address</span></span><br><span class="line"><span class="comment"> * @delim: the delimiter of the IPv4 address in @src, -1 means no delimiter</span></span><br><span class="line"><span class="comment"> * @end: A pointer to the end of the parsed string will be placed here</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return one on success, return zero when any error occurs</span></span><br><span class="line"><span class="comment"> * and @end will point to the end of the parsed string.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">in4_pton</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *src, <span class="keyword">int</span> srclen,</span></span></span><br><span class="line"><span class="params"><span class="function">	     u8 *dst,</span></span></span><br><span class="line"><span class="params"><span class="function">	     <span class="keyword">int</span> delim, <span class="keyword">const</span> <span class="keyword">char</span> **end)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *s;</span><br><span class="line">	u8 *d;</span><br><span class="line">	u8 dbuf[<span class="number">4</span>];</span><br><span class="line">	<span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> w = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (srclen &lt; <span class="number">0</span>)</span><br><span class="line">		srclen = <span class="built_in">strlen</span>(src);</span><br><span class="line">	s = src;</span><br><span class="line">	d = dbuf;</span><br><span class="line">	i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> c;</span><br><span class="line">		c = xdigit2bin(srclen &gt; <span class="number">0</span> ? *s : <span class="string">&#x27;\0&#x27;</span>, delim);</span><br><span class="line">		<span class="keyword">if</span> (!(c &amp; (IN6PTON_DIGIT | IN6PTON_DOT | IN6PTON_DELIM | IN6PTON_COLON_MASK))) &#123;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (c &amp; (IN6PTON_DOT | IN6PTON_DELIM | IN6PTON_COLON_MASK)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (w == <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">goto</span> out;</span><br><span class="line">			*d++ = w &amp; <span class="number">0xff</span>;</span><br><span class="line">			w = <span class="number">0</span>;</span><br><span class="line">			i++;</span><br><span class="line">			<span class="keyword">if</span> (c &amp; (IN6PTON_DELIM | IN6PTON_COLON_MASK)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (i != <span class="number">4</span>)</span><br><span class="line">					<span class="keyword">goto</span> out;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">goto</span> cont;</span><br><span class="line">		&#125;</span><br><span class="line">		w = (w * <span class="number">10</span>) + c; <span class="comment">/* Coredump here. */</span></span><br><span class="line">		<span class="keyword">if</span> ((w &amp; <span class="number">0xffff</span>) &gt; <span class="number">255</span>) &#123;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">cont:</span><br><span class="line">		<span class="keyword">if</span> (i &gt;= <span class="number">4</span>)</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		s++;</span><br><span class="line">		srclen--;</span><br><span class="line">	&#125;</span><br><span class="line">	ret = <span class="number">1</span>;</span><br><span class="line">	<span class="built_in">memcpy</span>(dst, dbuf, <span class="keyword">sizeof</span>(dbuf));</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">if</span> (end)</span><br><span class="line">		*end = s;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(in4_pton);</span><br></pre></td></tr></table></figure>

<p>å¯¼è‡´coredumpçš„ä»£ç ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">w = (w * <span class="number">10</span>) + c;</span><br></pre></td></tr></table></figure>

<p>coredumpå †æ ˆä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#0  0x00007f9563a35428 in raise () from /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">#1  0x00007f9563a3702a in abort () from /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">#2  0x000056378c35c332 in __mulvsi3 ()</span><br><span class="line">#3  0x000056378bdcec16 in in4_pton (delim=-1, end=&lt;synthetic pointer&gt;, dst=0x7f95355e9a44 &quot;&quot;, srclen=566, </span><br><span class="line">    src=0x50005e1169ba &lt;error: Cannot access memory at address 0x50005e1169ba&gt;)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>src</code>æ˜¯<code>mbuf</code>çš„L4æ•°æ®èµ·å§‹åœ°å€ï¼Œç”±äºç¯å¢ƒä¸Šæ²¡æœ‰æ‰“å¼€å¤§é¡µå†…å­˜çš„coredumpï¼Œå¯¼è‡´<code>src</code>çš„å†…å®¹æ— æ³•è·å–ï¼Œæé«˜äº†ä¸€ç‚¹åˆ†æéš¾åº¦ï¼Œä¸è¿‡å½±å“ä¹Ÿä¸æ˜¯å¾ˆå¤§ã€‚</p>
<p>æ¥ç€åˆ†æä¸‹æ•´ä½“å‡½æ•°æµç¨‹ï¼Œä»<code>src</code>çš„èµ·å§‹åœ°å€<code>s</code>å¼€å§‹è¯»å–æ¯ä¸ªå­—ç¬¦å¹¶ä½œç›¸åº”è½¬æ¢ï¼Œä¿å­˜åˆ°<code>c</code>ä¸­ï¼Œç„¶åç´¯åŠ åˆ°<code>w</code>ä¸­å»ï¼Œç­‰äºé€ä½è¯»å–åè¿›åˆ¶æ•´æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">......</span><br><span class="line">		<span class="keyword">int</span> c;</span><br><span class="line">		c = xdigit2bin(srclen &gt; <span class="number">0</span> ? *s : <span class="string">&#x27;\0&#x27;</span>, delim);</span><br><span class="line">......</span><br><span class="line">		w = (w * <span class="number">10</span>) + c; <span class="comment">/* Coredump here. */</span></span><br><span class="line">		<span class="keyword">if</span> ((w &amp; <span class="number">0xffff</span>) &gt; <span class="number">255</span>) &#123;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>å¾ˆæ˜æ˜¾ï¼Œè¿™ä¸€æ®µæ˜¯ä¸ºäº†å°†å­—ç¬¦å½¢å¼çš„ç‚¹åˆ†åè¿›åˆ¶çš„IPçš„æ•°å­—éƒ¨åˆ†è½¬æ¢æˆåè¿›åˆ¶æ•°å­—å¹¶ä¿å­˜ï¼Œè¿™é‡Œé€šè¿‡ç´¯è®¡å€¼æ˜¯å¦å¤§äº255åˆ¤æ–­æ•°å€¼æ˜¯å¦æº¢å‡º/æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚</p>
<p>è¿™é‡Œè¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œä»<code>xdigit2bin</code>å®šä¹‰ä¸­å¯ä»¥å‘ç°ï¼Œ<code>c</code>çš„é«˜16bitä»£è¡¨äº†<code>c</code>å­—ç¬¦çš„ç±»å‹ï¼Œä½16bitä»£è¡¨äº†å¯¹åº”çš„æ•°å€¼ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IN6PTON_XDIGIT		0x00010000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IN6PTON_DIGIT		0x00020000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IN6PTON_COLON_MASK	0x00700000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IN6PTON_COLON_1		0x00100000	<span class="comment">/* single : requested */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IN6PTON_COLON_2		0x00200000	<span class="comment">/* second : requested */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IN6PTON_COLON_1_2	0x00400000	<span class="comment">/* :: requested */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IN6PTON_DOT		0x00800000	<span class="comment">/* . */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IN6PTON_DELIM		0x10000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IN6PTON_NULL		0x20000000	<span class="comment">/* first/tail */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IN6PTON_UNKNOWN		0x40000000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">xdigit2bin</span><span class="params">(<span class="keyword">char</span> c, <span class="keyword">int</span> delim)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> val;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (c == delim || c == <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> IN6PTON_DELIM;</span><br><span class="line">	<span class="keyword">if</span> (c == <span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> IN6PTON_COLON_MASK;</span><br><span class="line">	<span class="keyword">if</span> (c == <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> IN6PTON_DOT;</span><br><span class="line"></span><br><span class="line">	val = hex_to_bin(c);</span><br><span class="line">	<span class="keyword">if</span> (val &gt;= <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> val | IN6PTON_XDIGIT | (val &lt; <span class="number">10</span> ? IN6PTON_DIGIT : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (delim == <span class="number">-1</span>)</span><br><span class="line">		<span class="keyword">return</span> IN6PTON_DELIM;</span><br><span class="line">	<span class="keyword">return</span> IN6PTON_UNKNOWN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿæ­£æ˜¯è¿™ä¸€ç‚¹å¯¼è‡´äº†æœ€ç»ˆçš„æº¢å‡ºï¼šå¦‚æœ<code>c</code>åªè¡¨ç¤ºæ•°å€¼çš„è¯ï¼Œé€šè¿‡å’Œ<code>255</code>æ¯”è¾ƒå¯ä»¥ç¡®ä¿ä¸æº¢å‡ºï¼Œä½†æ¯ä¸ªæ•°å­—çš„é«˜16bitéƒ½æœ‰ç½®ä½ï¼Œå½“èµ·å§‹å­—ç¬¦ä¸²çš„ä»¥è‹¥å¹²<code>0</code>å¼€å¤´æ—¶ï¼Œé«˜16bitä¸€ç›´è¢«ç´¯åŠ ï¼Œè€Œä½16bitçš„å€¼ä¸€ç›´æ˜¯<code>0</code>ï¼Œå§‹ç»ˆå°äº<code>255</code>ï¼Œæœ€ç»ˆæ•´ä½“è¶…è¿‡äº†<code>int</code>çš„ä¸Šç•Œï¼Œç»“æœæº¢å‡ºã€‚</p>
<h1 id="How-about-kernel"><a href="#How-about-kernel" class="headerlink" title="How about kernel?"></a>How about kernel?</h1><p>å•å•çœ‹æº¢å‡ºåŸå› å¥½åƒå·²ç»å¾ˆæ˜ç¡®äº†ï¼Œä½†è¿™æ®µä»£ç æ˜¯ä»å†…æ ¸æŠ„å‡ºæ¥çš„ï¼Œä¸ºä»€ä¹ˆå†…æ ¸æ­£å¸¸è¿è¡Œå®‰ç¨³æ— æ™å‘¢ï¼Ÿ</p>
<p>æ‰€ä»¥åœ¨å†…æ ¸ä¸Šæ„é€ ä¸€ä¸‹å¯¹åº”åœºæ™¯éªŒè¯ï¼Œå‡½æ•°è°ƒç”¨é¡ºåºä¸ºï¼š<code>nf_nat_sip</code>-&gt;<code>ct_sip_parse_request</code>-&gt;<code>skp_epaddr_len</code>-&gt;<code>epaddr_len</code>-&gt;<code>sip_parse_addr</code>-&gt;<code>in4_pton</code>ã€‚</p>
<p>é¡¶å±‚è°ƒç”¨å…¥å£<code>nf_nat_sip</code>ä½äºå†…æ ¸æ¨¡å—<code>nf_nat_sip</code>ï¼Œåœ¨æ¨¡å—åˆå§‹åŒ–çš„æ—¶å€™è¢«æ³¨å†Œåˆ°<code>netfilter</code>çš„<code>NAT</code>æ¨¡å—ä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_nat_sip_hooks</span> <span class="title">sip_hooks</span> =</span> &#123;</span><br><span class="line">	.msg		= nf_nat_sip,</span><br><span class="line">	.seq_adjust	= nf_nat_sip_seq_adjust,</span><br><span class="line">	.expect		= nf_nat_sip_expect,</span><br><span class="line">	.sdp_addr	= nf_nat_sdp_addr,</span><br><span class="line">	.sdp_port	= nf_nat_sdp_port,</span><br><span class="line">	.sdp_session	= nf_nat_sdp_session,</span><br><span class="line">	.sdp_media	= nf_nat_sdp_media,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">nf_nat_sip_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	BUG_ON(nf_nat_sip_hooks != <span class="literal">NULL</span>);</span><br><span class="line">	nf_nat_helper_register(&amp;nat_helper_sip);</span><br><span class="line">	RCU_INIT_POINTER(nf_nat_sip_hooks, &amp;sip_hooks);</span><br><span class="line">	nf_ct_helper_expectfn_register(&amp;sip_nat);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥è¦è¿›å…¥è¿™ä¸ªå‡½æ•°ï¼Œé¦–å…ˆæ·»åŠ ä¸€æ¡DNATè§„åˆ™ï¼Œç”¨æˆ·æ€ç›´æ¥é€šè¿‡iptablesæ“ä½œï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># iptables -t nat -A PREROUTING -p udp -s 10.103.240.222 --dport 5060 -j DNAT --to-destination 1.2.3.4</span></span><br></pre></td></tr></table></figure>

<p><code>iptable</code>æŒ‡å®š<code>-t nat</code>é€‰é¡¹æŸ¥çœ‹æ·»åŠ å®Œæˆåçš„NATè§„åˆ™ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># iptables -nvL -t nat</span></span><br><span class="line">Chain PREROUTING (policy ACCEPT 18234 packets, 3134K bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">    0     0 DNAT       udp  --  *      *       10.103.240.222       0.0.0.0/0            udp dpt:5060 to:1.2.3.4</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT 16998 packets, 2947K bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 269 packets, 109K bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT 277 packets, 110K bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</span><br></pre></td></tr></table></figure>

<p>åŠ è½½<code>nf_nat_sip</code>æ¨¡å—ï¼Œæ‰“å¼€å†…æ ¸æŠ¥æ–‡è½¬å‘ä»¥åŠ<code>netfilter</code>å¯¹åº”çš„<code>helper</code>åŠŸèƒ½ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># modprobe nf_nat_sip</span></span><br><span class="line"><span class="comment"># echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span></span><br><span class="line"><span class="comment"># echo 1 &gt; /proc/sys/net/netfilter/nf_conntrack_helper</span></span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨<code>scapy</code>æ„é€ å¼‚å¸¸æŠ¥æ–‡å‘é€ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>payload = <span class="string">&#x27;425945207369703a736572766963654030303937302e312e312e313a35303630205349502f322e300d0a5669613a205349502f322e302f5544502031302e3130332e3234302e3233323a353036303b6272616e63683d7a39684734624b2d313032373537382d313835392d390d0a46726f6d3a2073697070203c7369703a736970704031302e3130332e3234302e3233323a353036303e3b7461673d313835390d0a546f3a20737574203c7369703a736572766963654030303937302e312e312e313a353036303e3b7461673d3132393736534950705461673031313835390d0a43616c6c2d49443a20313835392d313032373537384031302e3130332e3234302e3233320d0a435365713a2032204259450d0a436f6e746163743a207369703a736970704031302e3130332e3234302e3233323a353036300d0a4d61782d466f7277617264733a2037300d0a5375626a6563743a20506572666f726d616e636520546573740d0a436f6e74656e742d4c656e6774683a20300d0a0d0a&#x27;</span>.decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>send(IP(dst=<span class="string">&quot;10.103.241.233&quot;</span>)/UDP(sport=<span class="number">5060</span>,dport=<span class="number">5060</span>)/payload)</span><br><span class="line">.</span><br><span class="line">Sent <span class="number">1</span> packets.</span><br></pre></td></tr></table></figure>

<p>å†é€šè¿‡<code>kprobe</code>è¾“å‡º<code>in4_pton</code>çš„å‚æ•°ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ./kprobe &#x27;p:in4_pton src=+0(%di):string&#x27;</span></span><br><span class="line">				&lt;idle&gt;-0     [002] ..s. 858059.345971: in4_pton: (in4_pton+0x0/0x170) src=<span class="string">&quot;00970.1.1.1:5060 SIP/2.0</span></span><br><span class="line"><span class="string">Via: SIP/2.0/UDP 10.103.240.232:5060;branch=z9hG4bK-1027578-1859-9</span></span><br><span class="line"><span class="string">From: sipp &lt;sip:sipp@10.103.240.232:5060&gt;;tag=1859</span></span><br><span class="line"><span class="string">To: sut &lt;sip:service@00970.1.1.1:5060&gt;;tag=12976SIPpTag011859</span></span><br><span class="line"><span class="string">Call-ID: 1859-1027578@10.103.240.232</span></span><br><span class="line"><span class="string">CSeq: 2 BYE</span></span><br><span class="line"><span class="string">Contact: sip:sipp@10.103.240.232:5060</span></span><br><span class="line"><span class="string">Max-Forwards: 70</span></span><br><span class="line"><span class="string">Subject: Performance Test</span></span><br><span class="line"><span class="string">Content-Length: 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span></span><br></pre></td></tr></table></figure>

<p>ä»<code>kprobe</code>è¾“å‡ºä¸­å¯ä»¥çœ‹åˆ°ï¼Œå†…æ ¸<code>in4_pton</code>çš„å‚æ•°<code>src</code>ä¹Ÿæ˜¯è‹¥å¹²<code>0</code>å¼€å¤´çš„å­—ç¬¦ä¸²ï¼ŒæŒ‰ç…§å¯¹ä»£ç çš„åˆ†æä¼šæº¢å‡ºï¼Œä½†ä¸ºå•¥å†…æ ¸è¿˜æ˜¯å¥½å¥½çš„ï¼Ÿæ˜¯ä¸æ˜¯å†…æ ¸æº¢å‡ºä¸ä¼šå¯¼è‡´coredumpï¼Ÿ</p>
<p>æ®æ­¤ï¼Œç¼–å†™ä¸€ä¸ªæº¢å‡ºçš„å†…æ ¸æ¨¡å—ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i, w, c;</span><br><span class="line"></span><br><span class="line">        printk(<span class="string">&quot;mo loaded.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        w = <span class="number">0</span>;</span><br><span class="line">        c = <span class="number">0x30000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">30</span>; i++) &#123;</span><br><span class="line">                w = w * <span class="number">10</span> + c;</span><br><span class="line">                printk(<span class="string">&quot;w = 0x%08x\n&quot;</span>, w);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fini</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        printk(<span class="string">&quot;mo unloaded.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(init);</span><br><span class="line">module_exit(fini);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>åŠ è½½æ¨¡å—åè§‚å¯Ÿæ—¥å¿—è¾“å‡ºï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346619</span> warning [kernel:] [<span class="number">195343.614466</span>] mo loaded.</span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346629</span> warning [kernel:] [<span class="number">195343.614467</span>] w = <span class="number">0x00030000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346630</span> warning [kernel:] [<span class="number">195343.614468</span>] w = <span class="number">0x00210000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346631</span> warning [kernel:] [<span class="number">195343.614468</span>] w = <span class="number">0x014d0000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346631</span> warning [kernel:] [<span class="number">195343.614468</span>] w = <span class="number">0x0d050000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346631</span> warning [kernel:] [<span class="number">195343.614469</span>] w = <span class="number">0x82350000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346632</span> warning [kernel:] [<span class="number">195343.614469</span>] w = <span class="number">0x16150000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346632</span> warning [kernel:] [<span class="number">195343.614469</span>] w = <span class="number">0xdcd50000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346639</span> warning [kernel:] [<span class="number">195343.614470</span>] w = <span class="number">0xa0550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346639</span> warning [kernel:] [<span class="number">195343.614470</span>] w = <span class="number">0x43550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346639</span> warning [kernel:] [<span class="number">195343.614470</span>] w = <span class="number">0xa1550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346640</span> warning [kernel:] [<span class="number">195343.614471</span>] w = <span class="number">0x4d550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346640</span> warning [kernel:] [<span class="number">195343.614471</span>] w = <span class="number">0x05550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346640</span> warning [kernel:] [<span class="number">195343.614471</span>] w = <span class="number">0x35550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346641</span> warning [kernel:] [<span class="number">195343.614472</span>] w = <span class="number">0x15550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346641</span> warning [kernel:] [<span class="number">195343.614472</span>] w = <span class="number">0xd5550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346642</span> warning [kernel:] [<span class="number">195343.614472</span>] w = <span class="number">0x55550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346642</span> warning [kernel:] [<span class="number">195343.614473</span>] w = <span class="number">0x55550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346643</span> warning [kernel:] [<span class="number">195343.614473</span>] w = <span class="number">0x55550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346643</span> warning [kernel:] [<span class="number">195343.614473</span>] w = <span class="number">0x55550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346643</span> warning [kernel:] [<span class="number">195343.614473</span>] w = <span class="number">0x55550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346644</span> warning [kernel:] [<span class="number">195343.614474</span>] w = <span class="number">0x55550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346644</span> warning [kernel:] [<span class="number">195343.614474</span>] w = <span class="number">0x55550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346645</span> warning [kernel:] [<span class="number">195343.614474</span>] w = <span class="number">0x55550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346645</span> warning [kernel:] [<span class="number">195343.614475</span>] w = <span class="number">0x55550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346646</span> warning [kernel:] [<span class="number">195343.614475</span>] w = <span class="number">0x55550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346646</span> warning [kernel:] [<span class="number">195343.614475</span>] w = <span class="number">0x55550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346647</span> warning [kernel:] [<span class="number">195343.614475</span>] w = <span class="number">0x55550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346647</span> warning [kernel:] [<span class="number">195343.614476</span>] w = <span class="number">0x55550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346648</span> warning [kernel:] [<span class="number">195343.614476</span>] w = <span class="number">0x55550000</span></span><br><span class="line"><span class="number">2022</span><span class="number">-12</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">18.346648</span> warning [kernel:] [<span class="number">195343.614476</span>] w = <span class="number">0x55550000</span></span><br></pre></td></tr></table></figure>

<p>ç»“æœçœ‹ä¸Šå»ç¡®å®æº¢å‡ºäº†ï¼Œä½†æ²¡æœ‰é€ æˆcoredumpã€‚</p>
<h1 id="mulvsi3"><a href="#mulvsi3" class="headerlink" title="__mulvsi3"></a>__mulvsi3</h1><p>å›è¿‡å¤´çœ‹æœ€åˆé€ æˆcoredumpçš„å‡½æ•°<code>__mulvsi3</code>ï¼Œè¯¥å‡½æ•°æ˜¯GCCå†…ç½®å‡½æ•°ï¼Œå¯¹åº”çš„æ±‡ç¼–ä»£ç ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">00000000004005f0 &lt;__mulvsi3&gt;:</span><br><span class="line">  4005f0:       48 63 c7                movslq %edi,%rax</span><br><span class="line">  4005f3:       48 63 f6                movslq %esi,%rsi</span><br><span class="line">  4005f6:       48 0f af c6             imul   %rsi,%rax /* rax = rax * rsi */</span><br><span class="line">  4005fa:       48 89 c2                mov    %rax,%rdx</span><br><span class="line">  4005fd:       89 c1                   mov    %eax,%ecx</span><br><span class="line">  4005ff:       48 c1 fa 20             sar    $0x20,%rdx</span><br><span class="line">  400603:       c1 f9 1f                sar    $0x1f,%ecx</span><br><span class="line">  400606:       39 d1                   cmp    %edx,%ecx /* rdx &gt;&gt; 0x20 == ecx &gt;&gt; 0x1f */</span><br><span class="line">  400608:       75 02                   jne    40060c &lt;__mulvsi3+0x1c&gt;</span><br><span class="line">  40060a:       f3 c3                   repz retq </span><br><span class="line">  40060c:       50                      push   %rax</span><br><span class="line">  40060d:       e8 1e fe ff ff          callq  400430 &lt;abort@plt&gt;</span><br><span class="line">  400612:       66 2e 0f 1f 84 00 00    nopw   %cs:0x0(%rax,%rax,1)</span><br><span class="line">  400619:       00 00 00 </span><br><span class="line">  40061c:       0f 1f 40 00             nopl   0x0(%rax)</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åœ¨è®¡ç®—å®Œä¹˜ç§¯åï¼Œé€šè¿‡æœ€é«˜ä½çš„è¿›ä½å’Œæ¬¡é«˜ä½çš„è¿›ä½æƒ…å†µè¿›è¡Œæº¢å‡ºåˆ¤æ–­ï¼ˆåŒé«˜ä½åˆ¤æ–­æ³•ï¼ŒåŸç†æ²¡ææ‡‚ï¼‰ï¼Œå¦‚æœå‘ç”Ÿæº¢å‡ºåˆ™è·³è½¬ï¼Œå¹¶ä¸”æœ€ç»ˆæ‰§è¡Œ<code>abort</code>ã€‚</p>
<p>ä¸ºä»€ä¹ˆå†…æ ¸æ²¡æœ‰å‘ç”Ÿcoredumpï¼Œå¤§æ¦‚å› ä¸ºå†…æ ¸çš„ä¹˜æ³•å¯¹åº”çš„å®ç°æ²¡æœ‰åšæº¢å‡ºæ£€æµ‹ã€‚åº”ç”¨å±‚ä¹Ÿæ˜¯åŒç†ï¼Œå¦‚æœå¯¹åº”çš„ä¹˜æ³•å®ç°æ²¡æœ‰æº¢å‡ºæ£€æµ‹çš„è¯ä¹Ÿä¸ä¼šå‡ºç°coredumpã€‚</p>
<p>é€šå¸¸æ¥è¯´ï¼Œæ•´æ•°æº¢å‡ºçš„é—®é¢˜ä¸»è¦å¯èƒ½å½±å“ä¸€äº›æ¡ä»¶åˆ¤æ–­ï¼Œè¿›è€Œé€ æˆæ­»å¾ªç¯ç­‰é—®é¢˜ï¼Œè¿™ç§å¯¼è‡´coredumpçš„æ¯”è¾ƒå°‘ï¼Œä½†æ€»çš„æ¥è¯´è¿˜æ˜¯åº”è¯¥å°½é‡é¿å…ã€‚</p>
]]></content>
      <categories>
        <category>Technology</category>
      </categories>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>How does QEMU notify Guest the nic link status changed</title>
    <url>/2022/05/22/How-does-QEMU-notify-Guest-the-nic-link-status-changed/</url>
    <content><![CDATA[<p>äº‹æƒ…çš„èµ·å› æ˜¯åŒäº‹é—®åˆ°ï¼ŒGuestå†…éƒ¨virtioç½‘å¡çš„é“¾è·¯çŠ¶æ€æ˜¯å¦‚ä½•æ”¹å˜çš„ï¼Œäºæ˜¯ä»virtioç½‘å¡å…¥æ‰‹ï¼Œæ¢³ç†äº†ä¸€ä¸‹QEMUçš„ç½‘å¡é“¾è·¯çŠ¶æ€çš„ç›¸å…³ä»£ç ã€‚</p>
<span id="more"></span>

<h1 id="virtio-net-set-link-status"><a href="#virtio-net-set-link-status" class="headerlink" title="virtio_net_set_link_status"></a>virtio_net_set_link_status</h1><p>æœç´¢ç›¸å…³ä»£ç ï¼Œèƒ½å¤Ÿæ‰¾åˆ°è®¾ç½®virtio-neté“¾è·¯çŠ¶æ€çš„å‡½æ•°<code>virtio_net_set_link_status</code>ï¼Œè¯¥å‡½æ•°ä¼šåˆ¤æ–­å¦‚æœé“¾è·¯çŠ¶æ€å‘ç”Ÿäº†æ”¹å˜ï¼Œåˆ™è°ƒç”¨<code>virtio_notify_config</code>é€šçŸ¥Guestå†…éƒ¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">virtio_net_set_link_status</span><span class="params">(NetClientState *nc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    VirtIONet *n = qemu_get_nic_opaque(nc);</span><br><span class="line">    VirtIODevice *vdev = VIRTIO_DEVICE(n);</span><br><span class="line">    <span class="keyword">uint16_t</span> old_status = n-&gt;status;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nc-&gt;link_down)</span><br><span class="line">        n-&gt;status &amp;= ~VIRTIO_NET_S_LINK_UP;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        n-&gt;status |= VIRTIO_NET_S_LINK_UP;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n-&gt;status != old_status)</span><br><span class="line">        virtio_notify_config(vdev);</span><br><span class="line"></span><br><span class="line">    virtio_net_set_status(vdev, vdev-&gt;status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨åˆå§‹åŒ–virtio-netçš„<code>NetClientInfo</code>çš„æ—¶å€™<code>link_status_changed</code>å‡½æ•°è®¾ç½®ä¸º<code>virtio_net_set_link_status</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> NetClientInfo net_virtio_info = &#123;</span><br><span class="line">    .type = NET_CLIENT_DRIVER_NIC,</span><br><span class="line">    .size = <span class="keyword">sizeof</span>(NICState),</span><br><span class="line">    .can_receive = virtio_net_can_receive,</span><br><span class="line">    .receive = virtio_net_receive,</span><br><span class="line">    .link_status_changed = virtio_net_set_link_status,</span><br><span class="line">    .query_rx_filter = virtio_net_query_rxfilter,</span><br><span class="line">    .announce = virtio_net_announce,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="link-status-changed"><a href="#link-status-changed" class="headerlink" title="link_status_changed"></a>link_status_changed</h1><p>ä»å‡½æ•°å‘½åä¸Šå¯ä»¥çœ‹å‡ºï¼Œè¯¥å‡½æ•°åœ¨é“¾è·¯çŠ¶æ€å‘ç”Ÿæ”¹å˜åè¢«è°ƒç”¨ã€‚</p>
<p>è¯¥å‡½æ•°æœ‰2ä¸ªè°ƒç”¨å¤„ï¼š<code>qmp_set_link</code>å’Œ<code>qemu_del_net_client</code>ã€‚</p>
<h2 id="qmp-set-link"><a href="#qmp-set-link" class="headerlink" title="qmp_set_link"></a>qmp_set_link</h2><p>qmpå¼€å¤´çš„å‡½æ•°å¾ˆæ˜æ˜¾ï¼Œéƒ½æ˜¯QMP(<a href="https://wiki.qemu.org/Documentation/QMP">QEMU Machine Protocol</a>ï¼‰ç›¸å…³çš„å‘½ä»¤å¯¹åº”çš„å®ç°å‡½æ•°ï¼Œä¸€èˆ¬åœºæ™¯ä¸‹éƒ½æ˜¯ç”¨æˆ·é€šè¿‡HMPï¼ˆ<a href="https://wiki.qemu.org/ToDo/HMP">Human Monitor Interface</a>ï¼‰æ¥å£å»æ‰‹åŠ¨è®¾ç½®çš„ã€‚</p>
<p>æ‰€ä»¥ï¼Œä¸€ç§æ˜¾ç„¶çš„è°ƒç”¨æ–¹å¼ä¸ºï¼šé€šè¿‡QMPï¼Œä¸»åŠ¨è®¾ç½®é“¾è·¯çŠ¶æ€ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨åç«¯ä¸ºvhost-userçš„åœºæ™¯ä¸‹ï¼ŒQEMUä»£ç æœ‰ç‰¹æ®Šå¤„ç†ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">net_vhost_user_event</span><span class="params">(<span class="keyword">void</span> *opaque, QEMUChrEvent event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">switch</span> (event) &#123;</span><br><span class="line">    <span class="keyword">case</span> CHR_EVENT_OPENED:</span><br><span class="line">......</span><br><span class="line">        qmp_set_link(name, <span class="literal">true</span>, &amp;err);</span><br><span class="line">......</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> CHR_EVENT_CLOSED:</span><br><span class="line">        <span class="comment">/* a close event may happen during a read/write, but vhost</span></span><br><span class="line"><span class="comment">         * code assumes the vhost_dev remains setup, so delay the</span></span><br><span class="line"><span class="comment">         * stop &amp; clear to idle.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">FIXME:</span> better handle failure in vhost code, remove bh</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (s-&gt;watch) &#123;</span><br><span class="line">......</span><br><span class="line">            aio_bh_schedule_oneshot(ctx, chr_closed_bh, opaque);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> CHR_EVENT_BREAK:</span><br><span class="line">    <span class="keyword">case</span> CHR_EVENT_MUX_IN:</span><br><span class="line">    <span class="keyword">case</span> CHR_EVENT_MUX_OUT:</span><br><span class="line">        <span class="comment">/* Ignore */</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        error_report_err(err);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å³åç«¯ä¸ºvhost-useræ—¶ï¼Œå½“å¯¹åº”çš„socketè¿æ¥äº‹ä»¶å‘ç”Ÿï¼Œä¸»åŠ¨ä»ä»£ç ä¸­è°ƒç”¨<code>qmp_set_link</code>ï¼Œè®¾ç½®ç½‘å¡çš„é“¾è·¯çŠ¶æ€ä¸ºUPï¼›å½“å¯¹åº”socketæ–­å¼€äº‹ä»¶å‘ç”Ÿï¼Œå¼‚æ­¥è°ƒç”¨ä¸€æ¬¡<code>chr_closed_bh</code>ï¼Œè¯¥å‡½æ•°ä¸­è¿›è¡Œåç«¯æ–­å¼€å¯¹åº”çš„æ¸…ç†æ“ä½œï¼ŒåŒ…æ‹¬è°ƒç”¨<code>qmp_set_link</code>å°†ç½‘å¡çš„é“¾è·¯çŠ¶æ€è®¾ç½®ä¸ºDOWNã€‚</p>
<h2 id="qemu-del-net-client"><a href="#qemu-del-net-client" class="headerlink" title="qemu_del_net_client"></a>qemu_del_net_client</h2><p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯æ¸…ç†NetClientStateçš„ç›¸å…³è”èµ„æºï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œè°ƒç”¨<code>link_status_changed</code>å¹¶ä¸æ˜¯è®¾ç½®å½“å‰è¢«æ¸…ç†çš„NetClientStateå¯¹åº”è®¾å¤‡çš„çŠ¶æ€ï¼Œè€Œæ˜¯è®¾ç½®peerçš„çŠ¶æ€ï¼ˆQEMUç½‘ç»œè™šæ‹ŸåŒ–ä¸­å¯¹è™šæ‹Ÿç½‘ç»œè®¾å¤‡æŠ½è±¡ä¸ºdeviceå’Œbackendï¼Œå¦‚virtio-net/vhost-netã€e1000/tapéƒ½æ˜¯device/backendçš„å¯¹åº”å…³ç³»ï¼Œä¸¤è€…äº’ä¸ºpeerï¼Œè¯¦ç»†å¯å‚è€ƒ<a href="https://wiki.qemu.org/Documentation/Networking">Wiki</a>ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">qemu_del_net_client</span><span class="params">(NetClientState *nc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">    <span class="comment">/* If there is a peer NIC, delete and cleanup client, but do not free. */</span></span><br><span class="line">    <span class="keyword">if</span> (nc-&gt;peer &amp;&amp; nc-&gt;peer-&gt;info-&gt;type == NET_CLIENT_DRIVER_NIC) &#123;</span><br><span class="line">        NICState *nic = qemu_get_nic(nc-&gt;peer);</span><br><span class="line">        <span class="keyword">if</span> (nic-&gt;peer_deleted) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        nic-&gt;peer_deleted = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; queues; i++) &#123;</span><br><span class="line">            ncs[i]-&gt;peer-&gt;link_down = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nc-&gt;peer-&gt;info-&gt;link_status_changed) &#123;</span><br><span class="line">            nc-&gt;peer-&gt;info-&gt;link_status_changed(nc-&gt;peer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; queues; i++) &#123;</span><br><span class="line">            qemu_cleanup_net_client(ncs[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸€èˆ¬è€Œè¨€ï¼Œå½“backendå¯¹åº”çš„NetClientStateè¢«åˆ é™¤æ—¶ï¼Œä¼šè°ƒç”¨<code>qemu_del_net_client</code>ï¼Œé€šçŸ¥peerç½‘å¡é“¾è·¯çŠ¶æ€å‘ç”Ÿäº†æ”¹å˜ã€‚</p>
<p>è¯¥å‡½æ•°çš„è°ƒç”¨å¤„ï¼Œé™¤äº†å„ç±»å‹ç½‘å¡çš„åˆå§‹åŒ–å¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œå’Œå…³æœºæµç¨‹ï¼Œå°±åªæœ‰<code>qmp_netdev_del</code>ï¼ˆåˆæ˜¯ä¸€å¤„QMPçš„æ¥å£è°ƒç”¨ğŸ˜…ï¼‰ï¼Œä¹Ÿå°±è¯´æ˜ï¼Œåªæœ‰é€šè¿‡QMPåˆ é™¤netdevæ—¶ï¼Œä¼šèµ°åˆ°è¿™ä¸ªé€»è¾‘ã€‚</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>ä¸Šè¿°ä»£ç åˆ†æä¸­ï¼Œé™¤äº†å…¥æ‰‹ç‚¹ä»virtio-netï¼Œå…¶ä½™éƒ½æ˜¯å¯¹<code>link_status_changed</code>çš„è°ƒç”¨åˆ†æï¼Œå³è¯¥æµç¨‹å¯¹QEMUçš„å…¶ä»–ç±»å‹ç½‘å¡åŒæ ·é€‚ç”¨ã€‚</p>
<p>æ­£å¸¸è¿è¡Œè¿‡ç¨‹ä¸­ä¼šå¼•èµ·Guestå†…éƒ¨é“¾è·¯çŠ¶æ€æ”¹å˜çš„åœºæ™¯å¦‚ä¸‹ï¼š</p>
<ul>
<li>virtio-netç½‘å¡çš„backendä¸ºvhost-useræ—¶ï¼Œå¯¹åº”çš„unix socketå‘ç”Ÿæ–­å¼€ã€è¿æ¥äº‹ä»¶ï¼›</li>
<li>é€šè¿‡qmpï¼Œä¸»åŠ¨è®¾ç½®å¯¹åº”ç½‘å¡çš„é“¾è·¯çŠ¶æ€ï¼›</li>
<li>é€šè¿‡qmpï¼Œåˆ é™¤backendï¼Œé€šçŸ¥peerç½‘å¡é“¾è·¯çŠ¶æ€å‘ç”Ÿæ”¹å˜ã€‚</li>
</ul>
<p><code>qemu_del_net_client</code>æœ¬èº«è¿˜æœ‰å…¶ä»–è°ƒç”¨å¤„ï¼Œå¦‚å…³æœºæµç¨‹ã€backendåˆå§‹åŒ–å¤±è´¥çš„å¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œä½†ä¸å±äºæ­£å¸¸è¿è¡Œè¿‡ç¨‹ä¸­çš„åœºæ™¯ï¼Œåœºæ™¯ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥å°±ä¸ä½œåˆ†æäº†ã€‚</p>
]]></content>
      <categories>
        <category>Technology</category>
      </categories>
      <tags>
        <tag>Virtualization</tag>
        <tag>Virtio/Vhost</tag>
      </tags>
  </entry>
  <entry>
    <title>Travels of Martzki: Travel in Gansu and Qinghai in 2020</title>
    <url>/2022/03/06/Travel-in-Gansu-and-Qinghai-in-2020/</url>
    <content><![CDATA[<p>åœ¨2020å¹´çš„9æœˆï¼Œæˆ‘å‚åŠ äº†å…¬å¸ç»„ç»‡çš„æ—…è¡Œå›¢ï¼Œç›®çš„åœ°æ˜¯é’æµ·å’Œç”˜è‚ƒï¼Œå¼€å¯äº†ç¬¬ä¸€æ¬¡çš„è¥¿åŒ—ä¹‹æ—…ã€‚</p>
<p>é¦–å…ˆè¯´ä¸‹æ—…è¡Œæœ¬èº«ï¼Œç”±äºæ˜¯è·Ÿå›¢æ¸¸ï¼Œç”šè‡³æ˜¯è·Ÿå…¬å¸çš„å›¢ï¼Œæ‰€ä»¥è¡Œç¨‹ä¸Šé¢æ²¡æœ‰ä»€ä¹ˆå¯è‡ªç”±å®‰æ’çš„ä½™åœ°ï¼Œä¹Ÿæ²¡æ³•æŠŠé’ç”˜å¤§ç¯çº¿ä¸Šçš„æ‰€æœ‰æ™¯ç‚¹éƒ½æ¸¸è§ˆä¸€éã€‚è™½ç„¶ç›®çš„åœ°æ˜¯é’æµ·ç”˜è‚ƒï¼Œä½†å®é™…ä¸Š6å¤©è¡Œç¨‹ï¼Œæœ€ååªæœ‰2å¤©åœ¨é’æµ·ï¼ŒåŠ ä¸Šä¸€è·¯çš„å¥”æ³¢ï¼Œå…¶å®ä½“éªŒä¸Šæ¥è¯´è¿˜æ˜¯éå¸¸è¾›è‹¦çš„ã€‚</p>
<span id="more"></span>

<h1 id="å…°å·å¸‚åŒº"><a href="#å…°å·å¸‚åŒº" class="headerlink" title="å…°å·å¸‚åŒº"></a>å…°å·å¸‚åŒº</h1><p>æˆ‘ä»¬æ˜¯ä»å…°å·å¼€å§‹æ•´ä¸ªè¡Œç¨‹çš„ã€‚å…°å·ä½œä¸ºä¸€ä¸ªäºŒçº¿åŸå¸‚ï¼Œç»™äººæ•´ä½“çš„æ„Ÿå—å°±æ˜¯å‘è¾¾ç¨‹åº¦ä¸é«˜ï¼Œä¸è¿‡ç”Ÿæ´»èŠ‚å¥æ¯”è¾ƒæ‚ é—²ã€‚ç»™æˆ‘å°è±¡æ¯”è¾ƒæ·±çš„ä¸€ç‚¹å°±æ˜¯ï¼Œåˆšåˆ°å…°å·çš„ç¬¬ä¸€é¡¿åˆé¤ï¼Œå¯¼æ¸¸å¸¦ç€ä¸€å¤§å·´çš„äººï¼Œä»æ²¡æœ‰æ–‘é©¬çº¿çº¢ç»¿ç¯çš„åŒå®çº¿é“è·¯æ¨ªç©¿é©¬è·¯åˆ°å¯¹é¢çš„é¤å…ï¼Œç€å®éœ‡æ’¼äº†ä¸€ç•ªğŸ˜…ã€‚æ•´ä¸ªè¿‡ç¨‹é™¤äº†æ²¡æœ‰æ–‘é©¬çº¿çº¢ç»¿ç¯ï¼Œå’Œå°å­¦è€å¸ˆé¢†ç€ä¸€å¤§ç¾¤å°å­¦ç”Ÿè¿‡é©¬è·¯çš„åœºæ™¯ä¸èƒ½è¯´å¾ˆåƒï¼Œåªèƒ½è¯´ä¸€æ¨¡ä¸€æ ·ã€‚</p>
<p>åœ¨å…°å·å¸‚åŒºï¼Œå”¯ä¸€ç»„ç»‡æˆ‘ä»¬ä¸€èµ·æ¸¸è§ˆçš„æ™¯ç‚¹æ˜¯ä¸­å±±æ¡¥ã€‚åœ¨åƒå®Œåˆé¤ååˆ°ä¸­å±±æ¡¥çš„ä¸€è·¯ä¸Šï¼Œå¯¼æ¸¸ä¸€è·¯ä¸Šæ»”æ»”ä¸ç»åœ°æ¸²æŸ“é»„æ²³ç¬¬ä¸€æ¡¥çš„å»ºç­‘å†å²å’Œè§£æ”¾æˆ˜äº‰å†å²ï¼ŒçœŸæ­£åˆ°è¾¾åï¼Œå…¶å®åœ¨æˆ‘ä¸ªäººçœ‹æ¥å°±æ˜¯ä¸€åº§æœ‰ç€å†å²èƒŒæ™¯çš„é“æ¡¥è€Œå·²ï¼Œä¸Šé¢æŒ¤æ»¡äº†æ¸¸å®¢åœ¨æ‹ç…§æ‰“å¡ã€‚ä»æ™¯ç‚¹æœ¬èº«è€Œè¨€ï¼Œå¦‚æœä¸æ˜¯å¯¹ç›¸å…³å†å²æœ‰å…´è¶£çš„è¯ï¼Œåªæ˜¯ä¸€ä¸ªå•çº¯çš„æ‰“å¡æ™¯ç‚¹ç½¢äº†ï¼Œå¹¶ä¸å€¼å¾—æ¨èã€‚ä¸è¿‡å¦‚æœåƒæˆ‘ä¸€æ ·ï¼Œä¹‹å‰æ²¡æœ‰è§è¿‡é»„æ²³çš„è¯ï¼Œä¹Ÿæ˜¯å€¼å¾—ä¸€å»çš„ï¼Œè™½ç„¶ä¸æ˜¯å£¶å£ç€‘å¸ƒé‚£æ ·å£®è§‚çš„é»„æ²³ï¼Œä½†ä¹Ÿæ˜¯é»„æ²³ï¼Œå¾ˆé»„çš„ğŸ¤¡ã€‚</p>
<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_4101.jpeg" width="70%" height="70%" alt="ä¸­å±±æ¡¥ï¼ˆä¸€ï¼‰"> 

<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_1106.jpeg" width="70%" height="70%" alt="ä¸­å±±æ¡¥ï¼ˆäºŒï¼‰"> 

<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_4212.jpeg" width="70%" height="70%" alt="æ‘„äºä¸­å±±æ¡¥çš„å…°å·å‚æ™š">

<p>è™½ç„¶æ˜¯è·Ÿå›¢æ¸¸ï¼Œåƒé¥­éƒ½æ˜¯æ—…è¡Œç¤¾å®‰æ’çš„å›¢é¤ï¼Œä½†åœ¨æ™šä¸Šæˆ‘ä»¬è¿˜æ˜¯ä»ç½‘ä¸Šæ‰¾äº†ä¸€å®¶è¯„åˆ†è¿˜okçš„å…°å·ç‰›è‚‰é¢å»æ‰“å¡ã€‚å°½ç®¡ä¸åƒã€ŠèˆŒå°–ä¸Šçš„ä¸­å›½ã€‹ä¸­çš„é‚£æ ·ï¼Œè¿é¢çš„ç²—ç»†éƒ½å¯ä»¥é€‰æ‹©ï¼Œåªæ˜¯ä¸€å®¶æ™®æ™®é€šé€šçš„ç‰›è‚‰é¢é¦†ï¼Œä½†è‡³å°‘ä»å–ç›¸ä¸Šæ¥çœ‹ï¼Œåº”è¯¥ä¹Ÿæ˜¯èƒ½ç¬¦åˆå…°å·ç‰›è‚‰é¢â€œä¸€æ¸…äºŒç™½ä¸‰çº¢å››ç»¿äº”é»„â€çš„ç‰¹ç‚¹çš„ã€‚</p>
<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_0453.jpeg" width="70%" height="70%" alt="å…°å·ç‰›è‚‰é¢">

<h1 id="ä¸ƒå½©ä¸¹éœ"><a href="#ä¸ƒå½©ä¸¹éœ" class="headerlink" title="ä¸ƒå½©ä¸¹éœ"></a>ä¸ƒå½©ä¸¹éœ</h1><p>ä¸ƒå½©ä¸¹éœä¹Ÿæ˜¯å¯¼æ¸¸æµ“å¢¨é‡å½©æåŠ›æ¨èçš„æ™¯ç‚¹ï¼Œå¯¹ä¹‹å‰æ²¡æœ‰äº†è§£è¿‡è¿™ä¸ªæ™¯ç‚¹çš„æˆ‘æ¥è¯´ï¼Œä¸€è·¯ä¸Šå¬ç€å¯¼æ¸¸æ´—è„‘çš„å®£ä¼ ï¼Œä»¥åŠæŠ±ç€å¯¹5Aæ™¯ç‚¹çš„æ•¬ä»°ï¼Œè¿˜æ˜¯äº§ç”Ÿäº†ä¸å°çš„æœŸå¾…å€¼ã€‚ä¸è¿‡çœŸæ­£åˆ°äº†æ™¯ç‚¹ä»¥åï¼Œå®¢è§‚çš„æ¥è¯´è¿˜æ˜¯å’Œæˆ‘çš„é¢„æœŸäº§ç”Ÿäº†äº¿ç‚¹ç‚¹çš„è¯¯å·®çš„ğŸ¤¡ã€‚</p>
<p>é¦–å…ˆæ™¯ç‚¹åé‡Œçš„ä¸¹éœï¼ŒæŒ‡çš„æ˜¯ä¸¹éœåœ°è²Œï¼Œç”¨æˆ‘ä¸ªäººçš„ã€é€šä¿—ä¸€ç‚¹çš„è¯´æ³•å°±æ˜¯ï¼šçº¢åœŸğŸ¤¡ã€‚è™½ç„¶åœ¨åœ°ç†å­¦å’ŒçŸ¿ç‰©å­¦ä¸Šå¯èƒ½ç”±äºè‹¥å¹²ç¨€æœ‰çš„æ¡ä»¶ï¼Œæœ€ç»ˆå‘ˆç°å‡ºäº†çº¢è‰²ä¸ºä¸»çš„å¤–è²Œç‰¹å¾ï¼Œä½†åœ¨å¤–è¡Œæ¸¸å®¢çœ‹æ¥ï¼Œå¯èƒ½ä½“ä¼šä¸åˆ°å…¶ä¸­çš„ä»·å€¼ã€‚æ™¯åŒºé‡Œçš„ä¸¹éœåœ°è²Œï¼Œä¸»è¦æ˜¯è‹¥å¹²çš„å°å‹ä¸˜é™µï¼Œæœ‰çš„ä¸˜é™µç”±äºå…¶è‡ªèº«å½¢çŠ¶ï¼ŒåŠ ä¸Šäººä¸ºçš„è‰ºæœ¯åŠ å·¥ï¼Œä¸ºå…¶å† ä»¥ç‰¹æ®Šçš„åç§°ã€‚æ¯”å¦‚è¿™ä¸ªå½¢ä¼¼ä¸€ä¸ªå§å§¿çš„äººçš„å°å±±ï¼Œåº”è¯¥æ˜¯æœ‰ä¸ªåå­—çš„ï¼ˆI really canâ€™t recallğŸ¤¡ï¼‰ã€‚</p>
<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_0639.jpeg" width="70%" height="70%" alt="å§å§¿å°å±±">

<p>å…¶æ¬¡åç§°é‡Œçš„ä¸ƒå½©ï¼ŒæŒ‡çš„æ˜¯ä¸˜é™µè¡¨å±‚é™¤äº†çº¢è‰²ä¸ºä¸»çš„çŸ¿ç‰©ä»¥å¤–ï¼Œè¿˜æœ‰è®¸å¤šç§ç±»çš„çŸ¿ç‰©ï¼Œåœ¨é˜³å…‰çš„ç…§å°„ä¸‹ï¼ˆperhapsï¼‰ä¼šæ˜¾ç¤ºå‡ºä¸ƒå½©çš„é¢œè‰²ï¼Œvery incredibleã€‚ä¸è¿‡å®¢è§‚æ¥è¯´ï¼Œæˆ‘ä»¬å»çš„å½“å¤©ç¡®å®æ˜¯é˜´å¤©ï¼Œæ‰€ä»¥å‘ˆç°åœ¨çœ¼å‰çš„åŸºæœ¬ä¸Šä¹Ÿå°±æ˜¯çº¢è‰²ä¸ºä¸»çš„ä¸˜é™µã€‚</p>
<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_4262.jpeg" width="70%" height="70%" alt="é˜´å¤©çš„ä¸ƒå½©ä¸¹éœï¼ˆä¸€ï¼‰">

<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_4263.jpeg" width="70%" height="70%" alt="é˜´å¤©çš„ä¸ƒå½©ä¸¹éœï¼ˆäºŒï¼‰">

<p>ä½œä¸º5Açº§æ™¯åŒºï¼Œä»å–å®¶ç§€ä¸Šçœ‹æ¥ï¼Œç¡®å®æ˜¯æœ‰ç‚¹ä¸œè¥¿çš„ï¼Œæˆ–è®¸æ™´å¤©å»ä¼šæœ‰ä¸€ä¸ªæ›´å¥½çš„ä½“éªŒã€‚</p>
<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/W020210514653355246570.jpeg" width="70%" height="70%" alt="ä¸ƒå½©ä¸¹éœå–å®¶ç§€ï¼ˆå›¾æºï¼šhttp://www.zhangye.gov.cn/yzzy/jdtj/lzx/202105/t20210514_637807.htmlï¼‰">

<h1 id="å˜‰å³ªå…³"><a href="#å˜‰å³ªå…³" class="headerlink" title="å˜‰å³ªå…³"></a>å˜‰å³ªå…³</h1><blockquote>
<p>é•¿åŸè¥¿èµ·å˜‰å³ªå…³ï¼Œå†¬è‡³å±±æµ·å…³ã€‚</p>
</blockquote>
<p>è¿™ä¾¿æ˜¯æˆ‘ä»ä¹¦æœ¬ä¸Šå¾—åˆ°çš„å¯¹å˜‰å³ªå…³çš„æœ€åˆå°è±¡ã€‚ä½œä¸ºé•¿åŸæœ€è¥¿çš„å…³å£ï¼Œå˜‰å³ªå…³ä¹Ÿè¢«ä¸–äººç§°ä½œâ€œå¤©ä¸‹ç¬¬ä¸€é›„å…³â€ã€‚</p>
<p>è™½ç„¶ç°åœ¨çš„å˜‰å³ªå…³ï¼Œå·²ç»ä¸å†æ˜¯å½“å¹´æ²³è¥¿èµ°å»Šä¸Šçš„å†›äº‹è¦å¡ï¼Œä½†å½“äººçœŸçœŸæ­£æ­£åœ°æ¥åˆ°å˜‰å³ªå…³é—¨å‰ï¼Œèµ°è¿›å†…åŸï¼Œç™»ä¸ŠåŸæ¥¼è¿œçœºç¥è¿å±±å’Œæˆˆå£è’æ¼ æ—¶ï¼Œèº«æ—åŸå¢™ä¸Šå†ç»é£éœœçš„ç –çŸ³ï¼Œå°±åƒä¹…ç»æ²™åœºçš„è€å…µä¸€æ ·ï¼Œä¼¼ä¹è¿˜åœ¨è¯‰è¯´ç€å½“å¹´çš„é‡‘æˆˆé“é©¬ã€‚é—­ä¸ŠåŒçœ¼ï¼Œæ„Ÿå—ç€è¥¿åŒ—çš„é£æ²™å¹è¿‡è„¸åºï¼Œä¹Ÿæ„Ÿå—ç€å†å²çš„æµé€ã€‚â€œå“€å¾ç”Ÿä¹‹é¡»è‡¾,ç¾¡é•¿æ±Ÿä¹‹æ— ç©·ã€‚â€è¯´çš„å¯èƒ½ä¹Ÿå°±æ˜¯è¿™æ ·çš„æ„Ÿå—å§ã€‚</p>
<p>æˆ‘æƒ³ï¼Œå¯¹äºå˜‰å³ªå…³ï¼Œæ— é¡»å¤šè¨€ã€‚</p>
<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_2809.jpeg" width="70%" alt="å˜‰å³ªå…³å…‰åŒ–é—¨">

<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_1192.jpeg" width="70%" alt="å˜‰å³ªå…³å†…">

<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_4271.jpeg" width="70%" alt="å˜‰å³ªå…³ç»ƒå…µåœº">

<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_8297.jpeg" width="70%" alt="å˜‰å³ªå…³åŸå¢™å’Œè¿œå¤„çš„ç¥è¿å±±">

<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_3004.jpeg" width="70%" alt="å˜‰å³ªå…³åŸæ¥¼">

<h1 id="é¸£æ²™å±±-amp-æœˆç‰™æ³‰"><a href="#é¸£æ²™å±±-amp-æœˆç‰™æ³‰" class="headerlink" title="é¸£æ²™å±± &amp; æœˆç‰™æ³‰"></a>é¸£æ²™å±± &amp; æœˆç‰™æ³‰</h1><p>é¸£æ²™å±±å’Œæœˆç‰™æ³‰ï¼Œæ˜¯æ•¦ç…Œè‘—åçš„æ²™æ¼ æ™¯åŒºã€‚</p>
<p>æ‰€è°“é¸£æ²™å±±ï¼ŒæŒ‡çš„æ˜¯æ•´ä¸ªæ²™æ¼ æ™¯åŒºä¸­çš„æ²™ä¸˜ï¼Œåœ¨äººä»¬å‘ä¸Šæ”€çˆ¬æ—¶ï¼Œä¼šéšç€è„šæŒè¸©å…¥æ²™åœ°ï¼Œå‘å‡ºç‰¹æ®Šçš„å“å£°ï¼›è€Œæœˆç‰™æ³‰ï¼ŒæŒ‡çš„åˆ™æ˜¯åœ¨æ•´ä¸ªæ²™æ¼ ä¸­çš„ä¸€ç‰‡å°å°ç»¿æ´²ï¼Œç”±äºæ³‰æ°´ä»ä¸Šç©ºä¿¯è§†å½¢ä¼¼æœˆç‰™è€Œå¾—åã€‚</p>
<p>æ•´ä¸ªæ™¯ç‚¹å¯¹äºç¬¬ä¸€æ¬¡è§åˆ°æ²™æ¼ çš„æˆ‘æ¥è¯´ï¼Œå¸å¼•åŠ›åè¶³ï¼Œå¯ä»¥è¯´æ˜¯æ•´ä¸ªæ—…è¡Œä¸­æœ€å€¼å¾—æ¨èçš„æ™¯ç‚¹äº†ã€‚å°±åƒæ²¡æœ‰è§è¿‡é›ªçš„å—æ–¹äººç¬¬ä¸€æ¬¡è§åˆ°ä¸‹é›ªä¸€æ ·ï¼Œæˆ‘ç›¸ä¿¡å¯¹æ‰€æœ‰æ²¡æœ‰äº²çœ¼è§åˆ°æ²™æ¼ çš„äººè€Œè¨€éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ— æ³•æ‹’ç»æ²™æ¼ çš„è‡ªç„¶é­…åŠ›ã€‚ç”šè‡³è¿˜åœ¨æ™¯åŒºå¤–ï¼Œçœ‹åˆ°è¿œå¤„çš„æ²™ä¸˜åçš„å¤§å®¶éƒ½éš¾æ©å…´å¥‹ä¹‹æƒ…ã€‚</p>
<p>åœ¨æ²™æ¼ ä¸­ï¼Œå¯ä»¥çˆ¬ä¸Šå±±é¡¶ï¼Œçœºæœ›æ•´ä¸ªæ²™æ¼ ï¼Œçœ‹ç€ç”±å¤§é£å¹å‡ºçš„æ²™ä¸˜æ£±è§’ï¼Œå’Œè¿œå¤„åœ¨æ²™ä¸˜è¡Œèµ°çš„è¡Œäººã€‚æ€»ä¹‹ï¼Œåªè¦è„šåœ¨æ²™å­ä¸Šï¼Œæ•´ä¸ªäººéƒ½æ˜¯å…´å¥‹çš„ã€‚</p>
<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_4316.jpeg" width="70%" alt="æ£±è§’åˆ†æ˜çš„æ²™ä¸˜">

<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_9787.jpeg" width="70%" alt="æ²™ä¸˜å’Œæ—…äºº">

<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_4332.jpeg" width="70%" alt="å¤•é˜³å’Œæœˆç‰™æ³‰">

<p>é™¤äº†è‡ªç„¶æ™¯è‰²çš„è§‚èµå¤–ï¼Œè¿™é‡Œè¿˜æœ‰éå¸¸å¤šçš„è‡ªè´¹é¡¹ç›®ï¼Œä¸»è¦æœ‰éª†é©¼éª‘è¡Œã€æ²™æ¼ è¶Šé‡æ‘©æ‰˜ã€æ»‘ç¿”æœºç­‰ã€‚</p>
<h2 id="éª†é©¼éª‘è¡Œ"><a href="#éª†é©¼éª‘è¡Œ" class="headerlink" title="éª†é©¼éª‘è¡Œ"></a>éª†é©¼éª‘è¡Œ</h2><p>å…¶å®éª‘éª†é©¼è¿™ä¸ªé¡¹ç›®ï¼Œå…¨å›½å„åœ°åº”è¯¥éƒ½æœ‰ï¼Œç”šè‡³ä¸éœ€è¦å’Œæ²™æ¼ æœ‰å•¥å…³ç³»ï¼Œåªè¦éª†é©¼èƒ½æ´»åº”è¯¥éƒ½èƒ½å¼€å±•ğŸ¤¡ã€‚</p>
<p>ä½†æ˜¯åœ¨æ²™æ¼ ä¸­ï¼Œè·Ÿéšé©¼é˜Ÿï¼Œå¯èƒ½å¤šå°‘èƒ½æœ‰ä¸€ç‚¹å½“å¹´ç©¿è¶Šä¸ç»¸ä¹‹è·¯çš„å•†äººä»¬çš„éª‘è¡Œä½“éªŒå§ã€‚</p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨æ™¯åŒºå®˜æ–¹å”®ç¥¨å¤„ï¼Œå”®å‡ºçš„éª†é©¼ç¥¨ï¼Œåªæ˜¯åŒ…å«éª‘è¡Œï¼ŒåŒæ—¶åœ¨éª‘è¡Œè·¯é€”ä¸Šè®¾ç½®äº†ä¸€äº›æ”¾ç€å°å–‡å­æ’­æ”¾ç€éŸ³ä¹çš„è‡ªåŠ¨æ‹ç…§ç‚¹ã€‚åœ¨ç¦»å¼€æ™¯åŒºçš„æ—¶å€™ï¼Œå¯ä»¥é€‰æ‹©å»å†²å°å‡ºç›¸ç‰‡ä½œä¸ºç•™å¿µï¼Œå½“ç„¶ï¼Œæ˜¯è‡ªè´¹çš„ğŸ¤¡ï¼ˆæ™¯åŒºåˆ›æ”¶ç»å…¸æ“ä½œäº†ï¼‰ã€‚</p>
<p>é™¤äº†å®˜æ–¹çš„æ‹ç…§æœåŠ¡ä»¥å¤–ï¼Œæ¯ä¸€æ”¯é©¼é˜Ÿï¼Œä¼šæœ‰ä¸€ä¸¤ä¸ªé¥²å…»å‘˜è´Ÿè´£ç‰µç€éª†é©¼æŒ‡å¼•æ–¹å‘ï¼Œè™½ç„¶æ™¯åŒºè¯´äº†ä¸å…è®¸ç§è‡ªæ”¶è´¹ï¼Œä½†ä»–ä»¬è¿˜æ˜¯ä¼šå‘ä½ æä¾›æœ‰å¿çš„æ‹ç…§æœåŠ¡ã€‚è™½ç„¶ä»ç»“æœä¸Šæ¥çœ‹ï¼Œæ‹ç…§æ°´å¹³ç›¸å½“æ‹‰èƒ¯ï¼Œèƒœåœ¨èƒ½æ‹åˆ°éª‘è¡Œçš„è§’åº¦ã€‚æ¯•ç«Ÿååœ¨éª†é©¼ä¸Šä¸ç®¡æ˜¯ç”¨æ‰‹æœºè¿˜æ˜¯è‡ªæ‹æ†ï¼Œéƒ½è¿˜æ˜¯æŒºæŠ–çš„ã€‚</p>
<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_4389.jpeg" width="70%" alt="æ²™æ¼ é©¼é˜Ÿ">

<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_9700.jpeg" width="70%" alt="æ²™æ¼ é©¼é˜Ÿå’Œæ‹ç…§æŠ€æœ¯å·¨çƒ‚çš„é¥²å…»å‘˜">

<h2 id="æ²™æ¼ è¶Šé‡æ‘©æ‰˜"><a href="#æ²™æ¼ è¶Šé‡æ‘©æ‰˜" class="headerlink" title="æ²™æ¼ è¶Šé‡æ‘©æ‰˜"></a>æ²™æ¼ è¶Šé‡æ‘©æ‰˜</h2><p>è¶Šé‡æ‘©æ‰˜æ˜¯æœ‰ç€å››ä¸ªç²—çŠ·è¶Šé‡è½®èƒçš„è¶Šé‡æ‘©æ‰˜ï¼Œä¸€èº«çš„æŸ´æ²¹å‘³å’Œç£¨çš„é”ƒäº®çš„åˆ¹è½¦æŠŠæ‰‹ä»¿ä½›åœ¨è¯‰è¯´ç€å®ƒçš„ä¹…ç»é£éœœã€‚</p>
<p>æ‘©æ‰˜ä¸»è¦ç”±é©¾é©¶å‘˜é©¾é©¶ï¼Œæœ‰ç€å›ºå®šè·¯çº¿ï¼ŒåŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªä¸Šå¡çš„è·¯çº¿ï¼Œåˆ°è¾¾æŠ˜è¿”ç‚¹åè¿”å›ã€‚åœ¨åˆ°è¾¾æŠ˜è¿”ç‚¹ä¹‹å‰ï¼Œé©¾é©¶å‘˜è¿˜ä¼šè®©æ¸¸å®¢è‡ªè¡Œé©¾é©¶ä¸€æ®µè·¯ç¨‹ã€‚è‡ªè¡Œé©¾é©¶çš„è¿‡ç¨‹ä¸­ï¼Œä¸éœ€è¦æ¢æŒ¡ï¼Œåªéœ€è¦åŠ æ²¹å’Œæ§åˆ¶æ–¹å‘ï¼Œä½†åœ¨æ²™æ¼ ä¸Šç”±äºåœ°å½¢èµ·ä¼ä¸å¹³ï¼Œèƒ½å¤Ÿæ„Ÿå—åˆ°æŠŠæ‰‹ä¸Šä¼ æ¥çš„å·¨å¤§æ‰­è½¬åŠ›ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦é©¾é©¶å‘˜åœ¨ååº§è¾…åŠ©æŠŠæ§æ–¹å‘çš„ã€‚åœ¨è‡ªè¡Œé©¾é©¶ç»“æŸåï¼ŒåŸºæœ¬å°±åˆ°äº†æŠ˜è¿”ç‚¹äº†ã€‚</p>
<p>é‡ç‚¹æ¥äº†ï¼Œè¶ç€ä½ åˆšåˆšåˆ°è¾¾æŠ˜è¿”ç‚¹ï¼Œè‡ªè¡Œé©¾é©¶çš„å…´å¥‹åŠ²å„¿è¿˜æ²¡è¿‡ï¼Œé©¾é©¶å‘˜ä»¬å°±ä¼šå¼€å§‹æ¨é”€â€œå¢å€¼æœåŠ¡â€ï¼Œé¢å¤–ä»˜è´¹å¸¦ä½ è¿›å…¥æ²™æ¼ æ·±å¤„é¢†ä¼šçœŸæ­£çš„æ²™æ¼ æ™¯è‰²ã€‚å³ä¾¿è¢«æ‹’ç»äº†ä¹‹åè¿˜æ˜¯å®‰åˆ©ä¸åœï¼Œå¤§æ¦‚å°±æ˜¯ï¼šä½ ä»¬ç©çš„éƒ½ä¸æ˜¯çœŸæ­£çš„æ²™æ¼ ï¼ŒçœŸæ­£çš„æ²™æ¼ å¥½ç©ç€å‘¢ï¼Œç»™é’±å°±å¸¦ä½ å»ğŸ¤¡ã€‚</p>
<p>å½“ä»–æ¨é”€å¤±è´¥åï¼Œè¿”ç¨‹è¿‡ç¨‹å¯èƒ½ä¸€ä¸ªæ˜¯å› ä¸ºæƒ³èµ¶ç´§å›å»æ¥ä¸‹ä¸€å•ï¼Œå¦ä¸€ä¸ªå¯èƒ½å› ä¸ºä¸æ»¡æ²¡æœ‰èµšåˆ°é’±ï¼Œé©¾é©¶è¿‡ç¨‹éå¸¸æ¿€çƒˆï¼Œä¸‹å¡è¿‡ç¨‹éƒ½æ˜¯å…¨ç¨‹è½°ç€æ²¹é—¨ã€‚æˆ‘ååœ¨ååº§åŒæ‰‹æŠ“ç€è½¦æ¶ï¼Œå‡ ä¹å±è‚¡ç¦»åœ°å…¨ç¨‹é£ç€å›å»çš„ï¼Œåˆ°è¾¾ä»¥ååŒæ‰‹å‡ ä¹è„±åŠ›äº†ğŸ¤¡ã€‚</p>
<p>æ€»ä¹‹è¿˜æ˜¯å€¼å¾—ä½“éªŒçš„ï¼Œè‡³äºæ˜¯å¦è¦é¢å¤–ä»˜é’±è®©ä»–å¸¦ä½ å»æ²™æ¼ æ·±å¤„å°±è§ä»è§æ™ºäº†ï¼Œå¦‚æœé‡åˆ°æŠ¥å¤æ€§æ¿€çƒˆé©¾é©¶å¯ä»¥è¦æ±‚ä»–å‡é€Ÿï¼Œå®‰å…¨ç¬¬ä¸€ã€‚</p>
<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_4289.jpeg" width="70%" alt="è¶Šé‡æ‘©æ‰˜">

<h2 id="æ»‘ç¿”æœº"><a href="#æ»‘ç¿”æœº" class="headerlink" title="æ»‘ç¿”æœº"></a>æ»‘ç¿”æœº</h2><p>æ™¯åŒºæœ‰å°å‹çš„èºæ—‹æ¡¨æ»‘ç¿”æœºï¼Œå½“ç„¶ä¸å¯èƒ½æ˜¯æ¸¸å®¢é©¾é©¶ï¼Œæ¸¸å®¢ä¹˜åæ»‘ç¿”æœºä»ä¸Šç©ºæ¸¸è§ˆæ•´ä¸ªæ™¯åŒºï¼Œä½“éªŒåº”è¯¥è¿˜æ˜¯ä¸é”™çš„ã€‚ä¸è¿‡ä¸çŸ¥é“æ˜¯ä¸æ˜¯æ‰€æœ‰äººéƒ½åƒæˆ‘ä¸€æ ·ï¼Œå˜´ä¸Šè¯´ç€â€œä¼šä¸ä¼šä¸å®‰å…¨â€ã€â€œæ„Ÿè§‰å¯èƒ½ä¹Ÿæ²¡å¤šå¤§æ„æ€â€ï¼Œä½†å¿ƒé‡Œæƒ³ç€å§æ§½å¥½è´µç„¶åæ²¡å»ğŸ¤¡ã€‚</p>
<h1 id="è«é«˜çªŸ"><a href="#è«é«˜çªŸ" class="headerlink" title="è«é«˜çªŸ"></a>è«é«˜çªŸ</h1><p>å°±åƒä¸€æåˆ°è¥¿å®‰ï¼Œäººä»¬é¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯å…µé©¬ä¿‘ä¸€æ ·ï¼Œä¸€æåˆ°æ•¦ç…Œï¼Œäººä»¬è‚¯å®šé¦–å…ˆæƒ³åˆ°çš„ä¹Ÿæ˜¯è«é«˜çªŸï¼Œå› ä¸ºè«é«˜çªŸå®åœ¨æ˜¯å¤ªæœ‰åäº†ï¼Œåº”è¯¥æ˜¯ä¸€ä¸ªç”˜è‚ƒå¿…å»çš„æ™¯ç‚¹ã€‚</p>
<p>è«é«˜çªŸçš„å®—æ•™ã€å†å²ã€è‰ºæœ¯ä»·å€¼ï¼Œå®Œå…¨ä¸å¿…æè¿°ï¼Œé‚£äº›æ´çªŸå†…å†ç»åƒå¹´å´ä¾ç„¶è‰²å½©è‰³ä¸½çš„å£ç”»å’Œæ ©æ ©å¦‚ç”Ÿçš„é›•åƒï¼Œæ¯‹åº¸ç½®ç–‘æ˜¯ä¸–ç•Œç¬¬ä¸€æ¡£çš„æ°´å¹³ã€‚</p>
<p>æ‰€ä»¥è¿™é‡Œå°±å†™ä¸€ä¸‹å…¶ä»–æ–¹é¢çš„ä¸œè¥¿ï¼š</p>
<ul>
<li>æ¸¸è§ˆç¥¨åˆ«ï¼šä¸ºäº†ä¿æŠ¤è«é«˜çªŸï¼Œé—¨ç¥¨åˆ†ä¸ºAç±»ç¥¨å’ŒBç±»ç¥¨ï¼Œéœ€è¦ç½‘ä¸Šé¢„çº¦ï¼Œä¸¤ç±»ç¥¨çš„åŒºåˆ«ï¼Œä¸»è¦æ˜¯å¯ä»¥æ¸¸è§ˆçš„æ´çªŸä¸åŒï¼ŒAç±»ç¥¨å¯ä»¥æ¸¸è§ˆçš„æ´çªŸæ›´åŠ ç²¾ç¾ï¼›</li>
<li>æ¸¸è§ˆè·¯ç¨‹ï¼šè«é«˜çªŸå†…ä¸å…è®¸è‡ªè¡Œæ¸¸è§ˆï¼Œéƒ½æ˜¯ç”±ä¸“ä¸šçš„è§£è¯´å‘˜å…¼å¯¼æ¸¸è´Ÿè´£å¸¦é¢†æ¸¸è§ˆã€‚å€¼å¾—ä¸€æçš„æ˜¯è§£è¯´å‘˜çš„ä¸“ä¸šæ°´å¹³éå¸¸ä¹‹é«˜ï¼Œä»è¯­è¨€è¡¨è¾¾åˆ°è§£è¯´å†…å®¹éƒ½æ˜¯æ— å¯æŒ‘å‰”çš„ï¼Œä¸æ„§æ˜¯ä¸–ç•Œæ–‡åŒ–é—äº§çš„è§£è¯´å‘˜ï¼Œç‚¹èµï¼›</li>
<li>æ¸¸è§ˆè§„èŒƒï¼šæ´çªŸå†…ä¸å…è®¸æ‹ç…§ã€ä½¿ç”¨é—ªå…‰ç¯ã€æ‰‹ç”µç­‰ï¼Œä¸€ä¸ªæ˜¯ä¸ºäº†æ–‡åŒ–ä¿æŠ¤ï¼Œå¦ä¸€ä¸ªæ˜¯é¿å…å…‰çº¿åŠ é€Ÿå£ç”»çš„æ°§åŒ–ï¼Œæ•´ä¸ªæµè§ˆè¿‡ç¨‹ä¸­åªèƒ½è·Ÿéšè§£è¯´å‘˜çš„æ‰‹ç”µå…‰å»æ¸¸è§ˆï¼›</li>
<li>ä»‹ç»çŸ­ç‰‡ï¼šæ­£å¼æ¸¸è§ˆä¹‹å‰ï¼Œä¼šåœ¨ä¸€ä¸ªç”µå½±é™¢ï¼Œæ’­æ”¾è«é«˜çªŸç›¸å…³å†å²æ–‡åŒ–çš„ä»‹ç»çŸ­ç‰‡ï¼Œä½†æ˜¯ç”±äºå…‰çº¿æ¯”è¾ƒæš—ï¼Œå†…å®¹è§£è¯´ä¹Ÿç›¸å¯¹æ¯ç‡¥ï¼Œè¿˜æ˜¯æ¯”è¾ƒæ— èŠçš„ï¼›</li>
<li>ç”µå­ä¿æŠ¤ï¼šæ®è§£è¯´å‘˜ä»‹ç»ï¼Œè«é«˜çªŸå·²ç»å¯åŠ¨äº†å°†æ´çªŸå†…çš„å£ç”»ã€é›•åƒç­‰è‰ºæœ¯ç‘°å®é€šè¿‡ä¿¡æ¯åŒ–æ‰‹æ®µä¿å­˜çš„å·¥ç¨‹ï¼Œå¥½è®©è«é«˜çªŸåœ¨äººç±»å†å²ä¸Šæ°¸è¿œä¿ç•™ä¸‹å»ã€‚</li>
</ul>
<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_2670.jpeg" width="70%" alt="è«é«˜çªŸï¼ˆä¸€ï¼‰">

<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_4341.jpeg" width="70%" alt="è«é«˜çªŸï¼ˆäºŒï¼‰">

<h1 id="èŒ¶å¡ç›æ¹–"><a href="#èŒ¶å¡ç›æ¹–" class="headerlink" title="èŒ¶å¡ç›æ¹–"></a>èŒ¶å¡ç›æ¹–</h1><p>æ­¤æ¬¡æ—…è¡Œå”¯äºŒçš„é’æµ·æ™¯ç‚¹ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç½‘çº¢æ™¯ç‚¹ï¼Œè¢«ç§°ä½œâ€œå¤©ç©ºä¹‹é•œâ€ã€‚</p>
<p>èŒ¶å¡ç›æ¹–é™¤äº†ä½œä¸ºä¸€ä¸ªæ—…æ¸¸æ™¯ç‚¹å¤–ï¼Œè¿˜æ˜¯ä¸€ä¸ªé‡è¦çš„åˆ¶ç›åŸºåœ°ã€‚æˆ‘ä»¬çš„æ¸¸è§ˆè·¯çº¿å°±æ˜¯ä»åˆ¶ç›åŸºåœ°å¼€å§‹çš„ï¼Œåˆ¶ç›åŸºåœ°èƒ½å¤Ÿçœ‹åˆ°ä»é‡‡é›†ç”¨çš„å·¥ä¸šè®¾å¤‡å’Œå †ç§¯æˆå±±çš„ç™½è‰²ç›å †ï¼Œæ­¤å¤–ä¹Ÿæ˜¯ä¸€ä¸ªç å¤´ã€‚åœ¨ç²—ç•¥æ¸¸è§ˆäº†åˆ¶ç›åŸºåœ°åï¼Œæˆ‘ä»¬å°±ä»ç å¤´åèˆ¹ï¼Œç›´æ¥åˆ°è¾¾æœ‰ç€â€œå¤©ç©ºä¹‹é•œâ€ä¹‹ç§°çš„æ™¯åŒºä¸­å¿ƒã€‚</p>
<p>â€œå¤©ç©ºä¹‹é•œâ€èŒ¶å¡ç›æ¹–çš„ç‰¹ç‚¹å°±æ˜¯æ¹–ä¸­æœ‰å¾ˆå¤šçš„ç™½è‰²ç»“æ™¶ç›ï¼Œä»æ¹–é¢è‚‰çœ¼å¯è§éƒ½æ˜¯ç™½è‰²çš„ä¸€ç‰‡ï¼Œæ™´å¤©çš„æ—¶å€™ï¼Œé˜³å…‰ã€æ¹–æ°´ã€ç»“æ™¶ç›çš„å…±åŒä½œç”¨ä¸‹ï¼Œæ¹–é¢å€’æ˜ çš„å¤©ç©ºé•œåƒï¼Œå®›å¦‚å¤©ç©ºæœ¬èº«ä¸€æ ·ã€‚åœ¨æ¹–é¢å¹³é™çš„æ—¶å€™ï¼Œæ›´æœ‰æ°´å¤©ä¸€è‰²çš„æ„Ÿè§‰ã€‚</p>
<p>æ¹–ä¸­æœ‰è®¸å¤šåœ°æ–¹çš„ç»“æ™¶ç›ç”Ÿé•¿çš„å¾ˆé«˜ï¼Œå¯¼è‡´æ°´æ·±å¾ˆæµ…ï¼Œæ¸¸å®¢å¯ä»¥ç›´æ¥ä¸‹æ°´æ‹ç…§ã€‚æ™¯åŒºä¹Ÿæä¾›é˜²æ°´é‹å¥—ç§Ÿèµï¼Œå¯ä»¥ç©¿ç€ç›´æ¥ä¸‹æ°´ï¼Œä¸è¿‡å¥½å¤šå¥³å­©å„¿éƒ½æ˜¯ç›´æ¥ç©¿ç€é•¿è£™å…‰è„šä¸‹æ°´æ‹ç…§çš„ï¼Œå³ä¾¿9æœˆçš„é’æµ·æ°”æ¸©å¾ˆä½ï¼Œå³ä¾¿åœ¨è½¦ä¸Šè¿˜æ˜¯é•¿è£™å¤–é¢è£¹ç€ç¾½ç»’æœï¼Œå³ä¾¿ä¸ä»…æ°´æ¸©ä½ç›æµ“åº¦è¿˜å¾ˆé«˜ï¼Œä½†ï¼Œé‚£åˆæ€ä¹ˆæ ·å‘¢ï¼Ÿå¥½çœ‹å¯æ˜¯ä¸€è¾ˆå­çš„äº‹ğŸ¤¡ã€‚</p>
<p>ç¦»å¼€æ—¶æˆ‘ä»¬ä¹˜åäº†ç½‘çº¢å°ç«è½¦ï¼Œä»æ™¯ç‚¹è¿”å›å…¥å£ã€‚è¯´æ˜¯ç½‘çº¢å°ç«è½¦ï¼Œå…¶å®è¿™ä¸ªé“è·¯æœ€åˆå°±æ˜¯èŒ¶å¡çš„åˆ¶ç›å·¥ä¸šç”¨æ¥è¿é€ç›çš„è´§è¿é“è·¯ã€‚åæ¥æ—…æ¸¸ä¸šå‘å±•èµ·æ¥ï¼Œå°†è´§è¿è½¦å¢æ¢æˆäº†å¼€æ”¾çš„å®¢è¿è½¦å¢ï¼Œç”¨äºå®¢æµè¿è¾“ã€‚å°ç«è½¦è¡Œé©¶é€Ÿåº¦ä¸å¿«ï¼Œååœ¨ä¸Šé¢å¯ä»¥å¾ˆå¥½åœ°æ¬£èµç›æ¹–é£æ™¯ã€‚</p>
<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_7801.jpeg" width="70%" alt="èŒ¶å¡ç›æ¹–ï¼ˆä¸€ï¼‰">

<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_2132.jpeg" width="70%" alt="èŒ¶å¡ç›æ¹–ï¼ˆäºŒï¼‰">

<h1 id="é’æµ·æ¹–"><a href="#é’æµ·æ¹–" class="headerlink" title="é’æµ·æ¹–"></a>é’æµ·æ¹–</h1><p>é’æµ·æ¹–ä½œä¸ºé’æµ·æœ€çŸ¥åçš„æ—…æ¸¸æ™¯ç‚¹ï¼Œå¯æƒœçš„æ˜¯è¿™æ¬¡æ—…è¡Œé‡Œé¢åªå‘†äº†ä¸€ä¸ªä¸‹åˆï¼ˆè¿™é‡Œä¸å¾—ä¸åæ§½ä¸‹è¡Œç¨‹å®‰æ’ğŸ™„ï¼‰ï¼Œè€Œä¸”å½“å¤©è¿è½®èˆ¹ä¹Ÿæ²¡æœ‰ï¼Œå°±åœ¨æ¹–è¾¹æ•£æ­¥æ‰“äº†ä¸‹å¡ï¼ŒåŸºæœ¬å°±ç»“æŸäº†ã€‚è¯´å®è¯é’æµ·æ¹–ä½œä¸ºè‡ªè¡Œè½¦ç¯æ¹–èµ›çš„åœºåœ°å’Œæˆ¿è½¦è‡ªç”±è¡Œçš„çƒ­é—¨é€‰æ‹©åœ°ï¼Œè¦æ˜¯å¥½å¥½ç©ä¸€å‘¨å¯èƒ½éƒ½ä¸å¤Ÿï¼Œä½†æˆ‘ä»¬åªæœ‰ä¸€ä¸ªä¸‹åˆğŸ¤·ã€‚</p>
<p>å…¶æ¬¡æ™šä¸Šå°±ä½åœ¨æ¹–è¾¹çš„é…’åº—ï¼Œè™½ç„¶å«é…’åº—ï¼Œä½†å…¶å®å°±æ˜¯æ‹›å¾…æ‰€æ°´å¹³ï¼Œæ˜¯æ•´ä¸ªæ—…è¡Œä¸­ä½å®¿æ¡ä»¶æœ€å·®çš„ï¼Œä¸”æ²¡æœ‰ç©ºè°ƒï¼ˆä¸è¿‡é’æµ·å¥½åƒé…’åº—éƒ½æ²¡æœ‰ç©ºè°ƒï¼ŒåŒ…æ‹¬åœ¨è¥¿å®å¸‚ä¸­å¿ƒçš„é…’åº—ä¹Ÿæ²¡æœ‰ï¼‰ï¼Œè‡ªç”±è¡Œæ˜¯å¦é€‰æ‹©ä½åœ¨æ¹–è¾¹å¯ä»¥æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©ã€‚åŒæ—¶è™½ç„¶æ·±å¤„é’æµ·æ¹–è¾¹ï¼Œå¯¼æ¸¸å˜±å’æ³¨æ„é«˜åŸååº”ï¼Œä½†æµ·æ‹”ä¹Ÿå°±2000å¤šç±³ï¼ŒåŸºæœ¬ä¸ç”¨æ‹…å¿ƒé«˜åã€‚</p>
<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_2844.jpeg" width="70%" alt="é’æµ·æ¹–ï¼ˆä¸€ï¼‰">

<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_2865.jpeg" width="70%" alt="é’æµ·æ¹–ï¼ˆäºŒï¼‰">

<img src="/images/2022-03-06-Travel-in-Gansu-and-Qinghai-in-2020/IMG_2871 2.jpeg" width="70%" alt="é’æµ·æ¹–ï¼ˆä¸‰ï¼‰">
]]></content>
      <categories>
        <category>Travel</category>
      </categories>
      <tags>
        <tag>Travel</tag>
      </tags>
  </entry>
  <entry>
    <title>Mattermost Auto Reply Tool</title>
    <url>/2022/02/17/Mattermost-auto-reply-tool/</url>
    <content><![CDATA[<h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p><a href="https://mattermost.org/">Mattermost</a>æ˜¯ä¸€æ¬¾å¼€æºçš„IMå·¥å…·ï¼Œä½œä¸ºSlackçš„æ›¿ä»£äº§å“ã€‚</p>
<h2 id="Mattermost-Source-Code"><a href="#Mattermost-Source-Code" class="headerlink" title="Mattermost Source Code"></a>Mattermost Source Code</h2><p>mattermostçš„githubä¸»é¡µä¸Šä¸»è¦æœ‰è¿™å‡ ä¸ªé¡¹ç›®ï¼š</p>
<ul>
<li>mattermost-server: ç”¨Goå¼€å‘çš„æœåŠ¡ç«¯ä»£ç ï¼Œä¹Ÿæ˜¯æ•´ä½“çš„æ ¸å¿ƒä»£ç ï¼›</li>
<li>mattermost-webapp: åŸºäºWebçš„å®¢æˆ·ç«¯ä»£ç ï¼Œæ‰€æœ‰å…¶ä»–ç±»å‹çš„å®¢æˆ·ç«¯ï¼Œå‡æ˜¯åŸºäºwebappå®ç°ï¼›</li>
<li>desktop: åŸºäºElectronçš„Windowså®¢æˆ·ç«¯ä»£ç ï¼Œé€šè¿‡Chromiumæµè§ˆå™¨å†…æ ¸è¿æ¥webappï¼Œå®Œæˆå®¢æˆ·ç«¯çš„åŠŸèƒ½ï¼›</li>
<li>mattermost-mobile: iOSå’ŒAndroidçš„å®¢æˆ·ç«¯ä»£ç ï¼Œåº”è¯¥ä¹Ÿæ˜¯é€šè¿‡æµè§ˆå™¨å†…æ ¸è¿æ¥webappè¿›è€Œå®ç°çš„çš„å®¢æˆ·ç«¯åŠŸèƒ½ã€‚</li>
</ul>
<span id="more"></span>

<h2 id="Mattermost-Deployment"><a href="#Mattermost-Deployment" class="headerlink" title="Mattermost Deployment"></a>Mattermost Deployment</h2><p><a href="https://docs.mattermost.com/guides/deployment.html#server-installation">å®˜æ–¹æ–‡æ¡£</a>ä¸­æä¾›äº†å„ç§ç¯å¢ƒä¸‹çš„éƒ¨ç½²æ–¹å¼ï¼Œæœ€ä¾¿æ·çš„å°±æ˜¯ç›´æ¥åœ¨æœ¬åœ°è¿è¡Œdockerå®¹å™¨ã€‚ä¸å¾—ä¸è¯´ï¼Œå®¹å™¨æŠ€æœ¯æå¤§åœ°ç®€åŒ–äº†åº”ç”¨çš„éƒ¨ç½²æµç¨‹ï¼Œå¦‚æœåªæ˜¯éœ€è¦éƒ¨ç½²ä¸€ä¸ªåŸºæœ¬çš„æœåŠ¡ç«¯ï¼Œç›´æ¥æŒ‰ç…§æ–‡æ¡£æŒ‡å¯¼ï¼Œå¯åŠ¨å®¹å™¨å³å¯ï¼Œå®¹å™¨å†…ä¼šè‡ªè¡Œè¿è¡Œserverå’Œwebappï¼Œå³å¯é€šè¿‡æµè§ˆå™¨è¿æ¥webappã€‚</p>
<h1 id="Mattermost-Auto-Reply"><a href="#Mattermost-Auto-Reply" class="headerlink" title="Mattermost Auto Reply"></a>Mattermost Auto Reply</h1><p>å…³äºMattermostè‡ªèº«çš„å…¶ä»–åŠŸèƒ½å°±ä¸ä»‹ç»äº†ï¼Œæœ‰ä»–è‡ªå·±çš„ä¼˜ç¼ºç‚¹ã€‚èŠå¤©åŠŸèƒ½ä¸­ï¼ŒMattermostè‡ªèº«æä¾›äº†ä¸€ä¸ªè‡ªåŠ¨å›å¤çš„åŠŸèƒ½ï¼Œåœ¨å¼€å¯è‡ªåŠ¨å›å¤æ—¶ï¼Œå°†ä¼šæŠŠåœ¨çº¿çŠ¶æ€è®¾ç½®ä¸ºç¦»å¼€ã€‚æ­¤æ—¶æ”¶åˆ°æ‰€æœ‰ç§èŠä¿¡æ¯åï¼Œä¼šè§¦å‘è‡ªåŠ¨å›å¤ã€‚</p>
<p>è¿™ä¸ªè‡ªå¸¦åŠŸèƒ½çš„é¸¡è‚‹çš„åœ°æ–¹åœ¨äºï¼šä¼šå¼ºåˆ¶å°†çŠ¶æ€è®¾ç½®ä¸ºç¦»çº¿ï¼Œæ­¤æ—¶æ”¶åˆ°æ–°çš„æ¶ˆæ¯ä¸å†æœ‰æ¨é€æé†’ï¼Œå¹¶ä¸”æ— æ³•è®¾ç½®è‡ªåŠ¨å›å¤é—´éš”ï¼Œæ¯æ”¶åˆ°çš„ä¸€æ¡æ–°æ¶ˆæ¯éƒ½ä¼šè§¦å‘è‡ªåŠ¨å›å¤ã€‚<br>è€Œä¸€ä¸ªç†æƒ³çš„è‡ªåŠ¨å›å¤åŠŸèƒ½åº”è¯¥åŒ…å«ï¼š</p>
<ul>
<li>å¯è‡ªç”±å¼€å…³</li>
<li>å’Œè‡ªèº«è´¦æˆ·åœ¨çº¿çŠ¶æ€æ— å…³ï¼Œä¸ä¼šè®¾ç½®åœ¨çº¿çŠ¶æ€ä¸ºç¦»å¼€</li>
<li>åŠŸèƒ½å¼€å¯åä¸å½±å“æ­£å¸¸ä½¿ç”¨ï¼Œæ”¶åˆ°æ–°æ¶ˆæ¯åèƒ½å¤Ÿæ­£å¸¸è§¦å‘æ¶ˆæ¯æ¨é€</li>
<li>å¯è®¾ç½®æ¶ˆæ¯å›å¤çš„é¢‘ç‡</li>
</ul>
<h2 id="Develop-with-Server"><a href="#Develop-with-Server" class="headerlink" title="Develop with Server"></a>Develop with Server</h2><p>å¯¹ä¸€æ¬¾å¼€æºäº§å“è€Œè¨€ï¼Œç›´æ¥ä¿®æ”¹æºä»£ç æ˜¯å®ç°åŠŸèƒ½è‡ªå®šä¹‰çš„æœ€ç›´æ¥çš„æ–¹å¼ã€‚</p>
<p>æœ€åˆçš„æƒ³æ³•å°±æ˜¯ç›´æ¥ä¿®æ”¹åŸç”Ÿçš„è‡ªåŠ¨å›å¤ä»£ç ï¼Œå°†å…¶ä¸­è®¾ç½®åœ¨çº¿çŠ¶æ€çš„ä»£ç å±è”½ï¼Œå³å¯åœ¨ä¸åšå¤§é‡ä¿®æ”¹çš„æƒ…å†µä¸‹ï¼Œå°†è‡ªåŠ¨å›å¤åŠŸèƒ½ä¼šå°†çŠ¶æ€è®¾ç½®ä¸ºç¦»çº¿çš„é—®é¢˜è§£å†³ã€‚</p>
<p>åœ¨çœ‹äº†å¯¹åº”åŠŸèƒ½çš„æºç åï¼Œå‘ç°è¿™éƒ¨åˆ†åŠŸèƒ½æ˜¯åœ¨serverä¸­å®ç°çš„ï¼š  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è‡ªåŠ¨å›å¤åŠŸèƒ½å¯åœï¼ˆåŒæ—¶è®¾ç½®ç”¨æˆ·åœ¨çº¿çŠ¶æ€ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *App)</span> <span class="title">SetAutoResponderStatus</span><span class="params">(user *model.User, oldNotifyProps model.StringMap)</span></span> &#123;</span><br><span class="line">	active := user.NotifyProps[model.AutoResponderActiveNotifyProp] == <span class="string">&quot;true&quot;</span></span><br><span class="line">	oldActive := oldNotifyProps[model.AutoResponderActiveNotifyProp] == <span class="string">&quot;true&quot;</span></span><br><span class="line"></span><br><span class="line">	autoResponderEnabled := !oldActive &amp;&amp; active</span><br><span class="line">	autoResponderDisabled := oldActive &amp;&amp; !active</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> autoResponderEnabled &#123;</span><br><span class="line">		a.SetStatusOutOfOffice(user.Id)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> autoResponderDisabled &#123;</span><br><span class="line">		a.SetStatusOnline(user.Id, <span class="literal">true</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªåŠ¨å›å¤åŠŸèƒ½ä»£ç </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *App)</span> <span class="title">SendAutoResponse</span><span class="params">(c *request.Context, channel *model.Channel, receiver *model.User, post *model.Post)</span> <span class="params">(<span class="keyword">bool</span>, *model.AppError)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> receiver == <span class="literal">nil</span> || receiver.NotifyProps == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	active := receiver.NotifyProps[model.AutoResponderActiveNotifyProp] == <span class="string">&quot;true&quot;</span></span><br><span class="line">	message := receiver.NotifyProps[model.AutoResponderMessageNotifyProp]</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !active || message == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rootID := post.Id</span><br><span class="line">	<span class="keyword">if</span> post.RootId != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		rootID = post.RootId</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	autoResponderPost := &amp;model.Post&#123;</span><br><span class="line">		ChannelId: channel.Id,</span><br><span class="line">		Message:   message,</span><br><span class="line">		RootId:    rootID,</span><br><span class="line">		Type:      model.PostTypeAutoResponder,</span><br><span class="line">		UserId:    receiver.Id,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> _, err := a.CreatePost(c, autoResponderPost, channel, <span class="literal">false</span>, <span class="literal">false</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªåŠŸèƒ½æ˜¯é€šè¿‡å¯¹æœåŠ¡ç«¯ç”¨æˆ·çŠ¶æ€è¿›è¡Œç›¸åº”çš„è®¾ç½®ï¼Œå¯ç”¨åŠŸèƒ½åï¼ŒæœåŠ¡ç«¯åœ¨æ¶ˆæ¯å¤„ç†æ—¶è‡ªåŠ¨å®ç°çš„ï¼Œæ•´ä¸ªè¿‡ç¨‹å®¢æˆ·ç«¯åªèµ·åˆ°äº†ä¸€ä¸ªçŠ¶æ€è®¾ç½®çš„ä½œç”¨ï¼Œä¸å‚ä¸å®é™…çš„å›å¤åŠŸèƒ½å®ç°ã€‚</p>
<p>ç»è¿‡ä¸Šé¢çš„ä»£ç åˆ†æï¼Œå¦‚æœæƒ³è¦é€šè¿‡ä¿®æ”¹åŸç”Ÿä»£ç å®ç°å¯¹åº”åŠŸèƒ½çš„è¯ï¼Œåˆ™éœ€è¦ä¿®æ”¹æœåŠ¡ç«¯ä»£ç ï¼Œé‡æ–°ç¼–è¯‘éƒ¨ç½²å†ä¸Šçº¿ã€‚å…¶åŠ£åŠ¿ä¸»è¦æœ‰ï¼š</p>
<ul>
<li>å¯¹æœåŠ¡ç«¯ä»£ç è¿›è¡Œä¿®æ”¹éœ€è¦å¯¹åº”çš„æƒé™ï¼šå¦‚æœæ²¡æœ‰æœåŠ¡ç«¯çš„ç®¡ç†æƒé™ï¼Œå•ç‹¬ä½œä¸ºç”¨æˆ·ï¼Œæ˜¯æ²¡æœ‰åŠæ³•ä¿®æ”¹æœåŠ¡ç«¯ä»£ç çš„ï¼›</li>
<li>é‡æ–°éƒ¨ç½²ä¼šå¼•èµ·ä¸šåŠ¡ä¸­æ–­ï¼šæ›´æ¢æœåŠ¡ç«¯ä»£ç é‡æ–°éƒ¨ç½²ä¼šå¼•èµ·ä¸šåŠ¡ä¸­æ–­ã€‚</li>
</ul>
<p>ç”±äºå¤§å¤šæ•°ä½¿ç”¨è€…éƒ½æ˜¯å•çº¯çš„ç”¨æˆ·ï¼Œå¹¶ä¸å…·å¤‡é‡æ–°éƒ¨ç½²æœåŠ¡ç«¯çš„æ¡ä»¶ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ¡ˆä½œä¸ºç†è®ºå¯è¡Œä¸”ç®€å•çš„æ–¹æ¡ˆï¼Œä½†å¹¶æœªæœ€ç»ˆé€‰ç”¨ã€‚</p>
<h2 id="Develop-with-Client"><a href="#Develop-with-Client" class="headerlink" title="Develop with Client"></a>Develop with Client</h2><p>ä¸Šé¢åˆ†æäº†å¯¹åº”ä»£ç æ˜¯åœ¨æœåŠ¡ç«¯ä¸­å®ç°çš„ï¼Œåœ¨åŠŸèƒ½è°ƒç ”æœŸé—´ï¼Œå‘ç°ä¿®æ”¹æœåŠ¡ç«¯å®ç°åŠŸèƒ½çš„æ–¹å¼ä¸å¤ªç°å®åï¼Œæ›¾è€ƒè™‘è¿‡ä¿®æ”¹å®¢æˆ·ç«¯ä»£ç ï¼Œåœ¨å®¢æˆ·ç«¯é‡æ–°å®ç°ä¸€ä¸ªè‡ªåŠ¨å›å¤åŠŸèƒ½ã€‚</p>
<p>ä½†ç»è¿‡æ›´ç»†è‡´çš„åˆ†æåå‘ç°ï¼Œmattermostçš„å®¢æˆ·ç«¯æ ¸å¿ƒæ˜¯mattermost-webappï¼Œå®¢æˆ·ç«¯çš„å…·ä½“çš„æ¶ˆæ¯æ”¶å‘åŠŸèƒ½éƒ½æ˜¯åœ¨mattermost-webappä¸­å®ç°çš„ï¼Œå„ä¸ªå¹³å°ä¸Šçš„å®¢æˆ·ç«¯éƒ½åªæ˜¯åˆ©ç”¨å¹³å°ç‰¹æ€§å¯¹mattermost-webappè¿›è¡Œäº†å°è£…ï¼Œä¸»è¦åº”è¯¥æ˜¯ä¸ºäº†å¹³å°ç›¸å…³çš„äº¤äº’åŠŸèƒ½å®ç°ï¼Œæ¯”å¦‚æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€ä»¥åŠæ¶ˆæ¯æ¨é€åŠŸèƒ½çš„å®ç°ã€‚</p>
<img src="/images/2022-02-17-Mattermost-auto-reply-tool/process-diagram.png" width="70%" height="70%" alt="mattermost-desktop Process Diagram">

<p>å¦‚<a href="https://developers.mattermost.com/contribute/desktop/">å®˜æ–¹æ–‡æ¡£</a>æè¿°çš„é‚£æ ·ï¼Œmattermost-desktopåŸºäºElectronå¼€å‘ï¼Œåˆ†ä¸ºmainè¿›ç¨‹å’Œrendererè¿›ç¨‹ï¼Œmainè¿›ç¨‹ç”±NodeJSå®ç°ï¼ŒåŒ…å«äº†é€šçŸ¥ç®¡ç†ã€çª—å£å¸ƒå±€ç®¡ç†ã€é…ç½®ã€æ“ä½œç³»ç»Ÿé›†æˆç­‰åŠŸèƒ½ï¼ŒåŒæ—¶åŒ…å«äº†å¯¹redererè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­‰åŠŸèƒ½ï¼›redererè¿›ç¨‹åŸºæœ¬å°±æ˜¯Chromiumæµè§ˆå™¨å†…æ ¸ï¼Œé€šè¿‡è¿æ¥webappå®ç°å¯¹åº”çš„åŠŸèƒ½ã€‚</p>
<p>mainè¿›ç¨‹å’Œredererè¿›ç¨‹ä¹‹é—´é€šè¿‡ç‰¹å®šçš„IPCè¿›è¡Œäº¤äº’ã€‚</p>
<p>æ‰€ä»¥å°è¯•ä¿®æ”¹å®¢æˆ·ç«¯ä»£ç å®ç°åŠŸèƒ½çš„æ–¹æ¡ˆä¹Ÿå‘Šå¹ï¼Œå› ä¸ºå®¢æˆ·ç«¯çš„æ ¸å¿ƒmattermost-webappé€šå¸¸æ˜¯å’Œmattermost-serverè¿è¡Œåœ¨ä¸€èµ·çš„ï¼Œå¯¹å…¶è¿›è¡Œä¿®æ”¹çš„éš¾åº¦åŒæ ·è¾ƒå¤§ã€‚</p>
<h2 id="Develop-an-API-Request-Proxy"><a href="#Develop-an-API-Request-Proxy" class="headerlink" title="Develop an API Request Proxy"></a>Develop an API Request Proxy</h2><p>ç”±äºæ¶ˆæ¯çš„æ”¶å‘éƒ½æ˜¯webappè°ƒç”¨å’Œserverçš„APIå®ç°çš„ï¼Œæ‰€ä»¥ä¸€ç§ç†è®ºå¯è¡Œçš„æ–¹æ¡ˆä¸ºï¼šè·å–å®¢æˆ·ç«¯çš„cookieç­‰èº«ä»½è®¤è¯ä¿¡æ¯ï¼Œç›‘æ§æ‰€æœ‰å®¢æˆ·ç«¯çš„äº¤äº’è¯·æ±‚ã€‚é€šè¿‡å¯¹äº¤äº’è¯·æ±‚è¿›è¡Œåˆ†æï¼Œæ”¶åˆ°æ¶ˆæ¯åï¼Œä¾æ®è‡ªåŠ¨å›å¤é…ç½®å’Œç­–ç•¥ï¼Œè°ƒç”¨å¯¹åº”çš„APIï¼Œå‘é€é¢„å…ˆè®¾å®šå¥½çš„è‡ªåŠ¨å›å¤æ¶ˆæ¯ã€‚</p>
<img src="/images/2022-02-17-Mattermost-auto-reply-tool/API proxy.drawio.png" width="70%" height="70%" alt="API Request Proxy">

<p>è¿™æ˜¯ä¸€ç§ç†è®ºå¯è¡Œçš„æ–¹æ¡ˆï¼Œä½†å´ä¸æ˜¯ä¸€ä¸ªç°å®çš„ã€å®¹æ˜“å®ç°çš„æ–¹æ¡ˆï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªåŸå› ï¼š</p>
<ul>
<li>è®¤è¯ï¼šä¸è®ºæ˜¯server APIçš„è®¤è¯ä¿¡æ¯çš„è·å–ï¼Œè¿˜æ˜¯HTTPSï¼ˆå‡è®¾æœåŠ¡ç«¯ä½¿ç”¨äº†HTTPSï¼‰çš„è®¤è¯ä¿¡æ¯è·å–ï¼Œéƒ½éœ€è¦é€šè¿‡å·²ç»å®Œæˆè®¤è¯çš„webappæ¥è·å–ï¼Œå®é™…ä¸Šæ˜¯å¾ˆä¸å®¹æ˜“å®ç°çš„ï¼Œè€Œè¿™äº›è®¤è¯ä¿¡æ¯ï¼Œæ˜¯åˆ†æwebappå’Œserverçš„APIè¯·æ±‚ã€é€šè¿‡APIå®Œæˆæ¶ˆæ¯å‘é€çš„å‰æï¼›</li>
<li>ä½¿ç”¨éš¾åº¦ï¼šéœ€è¦ä»¥è¯·æ±‚ä»£ç†çš„æ–¹å¼éƒ¨ç½²ï¼Œä»è€Œèƒ½å¤Ÿåœ¨webappå’Œserveräº¤äº’çš„è¿‡ç¨‹ä¸­è·å–åˆ°äº¤äº’çš„å…·ä½“è¯·æ±‚ã€‚ä»£ç†çš„éƒ¨ç½²å½¢æ€å¢åŠ äº†ç”¨æˆ·çš„ä½¿ç”¨éš¾åº¦ã€‚</li>
</ul>
<p>ç»¼ä¸Šï¼Œè¿™æ˜¯ä¸€ç§ç†è®ºå¯è¡Œçš„ã€ä»å®ç°æ–¹å¼ä¸Šçœ‹è¾ƒä¸ºåŸç”Ÿçš„ï¼ˆrawï¼‰æ–¹æ¡ˆï¼Œä½†å¹¶ä¸ç°å®ã€‚</p>
<h2 id="Develop-with-API-Driver-Finally-Choosed"><a href="#Develop-with-API-Driver-Finally-Choosed" class="headerlink" title="Develop with API Driver (Finally Choosed)"></a>Develop with API Driver (Finally Choosed)</h2><p>å…³äºmattermostçš„APIï¼Œé™¤äº†webappå¯ä»¥ç›´æ¥è®¿é—®å¤–ï¼Œå¦‚<a href="https://api.mattermost.com/#tag/introduction">å®˜æ–¹æ–‡æ¡£</a>æ‰€æè¿°çš„ï¼Œæœ‰å¤šç§è¯­è¨€çš„Driverå¯ä¾›å¼€å‘è€…ä½¿ç”¨ã€‚ä½¿ç”¨ç‰¹å®šçš„Driverå¯ä»¥è¿æ¥serverï¼Œè®¤è¯å®Œæˆåå¯é€šè¿‡å®šä¹‰å¥½çš„APIè°ƒç”¨æ¥å®ç°å¯¹åº”çš„åŠŸèƒ½ï¼Œå³å¯é€šè¿‡APIå®Œæˆç¬¬ä¸‰æ–¹åº”ç”¨çš„å¼€å‘ã€‚</p>
<p>æœ€ç»ˆé€‰æ‹©äº†Pythonçš„<a href="https://github.com/Vaelor/python-mattermost-driver">Driver</a>ï¼Œæ„Ÿè°¢ä½œè€…<a href="https://github.com/Vaelor">@Vaelor</a>ã€‚</p>
<p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/Martzki/Mattermost-Tools">Mattermost-Tools</a>ã€‚</p>
<h3 id="Design-Overview"><a href="#Design-Overview" class="headerlink" title="Design Overview"></a>Design Overview</h3><p>ä¸ºäº†å®Œæˆè‡ªåŠ¨å›å¤çš„åŠŸèƒ½ï¼Œæœ‰å‡ ä¸ªå­åŠŸèƒ½éœ€è¦å®ç°ï¼š</p>
<ul>
<li>Connect to Serverï¼šAPIè°ƒç”¨ã€æ¶ˆæ¯è·å–ç­‰åŠŸèƒ½éƒ½éœ€è¦åœ¨è¿æ¥åˆ°serverå¹¶å®Œæˆè®¤è¯çš„å‰æä¸‹æ‰èƒ½å®ç°ï¼›</li>
<li>Events Handleï¼šè·å–serveræ¨é€çš„eventï¼Œå¤„ç†å¤„ç†æ¶ˆæ¯ç±»å‹çš„eventï¼Œåœ¨æ»¡è¶³è‡ªåŠ¨å›å¤çš„æ¡ä»¶åï¼Œè°ƒç”¨è‡ªåŠ¨å›å¤çš„åŠŸèƒ½ï¼›</li>
<li>Auto Replyï¼šä¾æ®ç”¨æˆ·é…ç½®ï¼Œå¯¹æ¶ˆæ¯è¿›è¡Œè‡ªåŠ¨å›å¤ï¼Œä¹Ÿæ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼›</li>
<li>Config Updateï¼šè‡ªåŠ¨å›å¤ç›¸å…³çš„ç”¨æˆ·é…ç½®çš„æ›´æ–°ï¼›</li>
<li>GUIï¼šç”¨æˆ·å‹å¥½çš„é…ç½®äº¤äº’åŠŸèƒ½ï¼Œå¯åœ¨è¿è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€å˜æ›´ç”¨æˆ·é…ç½®ã€‚</li>
</ul>
<img src="/images/2022-02-17-Mattermost-auto-reply-tool/overview.drawio.png" width="70%" height="70%" alt="Overview">

<h3 id="Connect-to-Server"><a href="#Connect-to-Server" class="headerlink" title="Connect to Server"></a>Connect to Server</h3><p>é¦–å…ˆå°±æ˜¯è¿æ¥åˆ°Serverï¼ŒAPIæä¾›äº†WebSocketå¯¹åº”çš„æ¥å£ï¼Œå¯ä»¥é€šè¿‡ç”¨æˆ·åå¯†ç /Tokençš„æ–¹å¼è¿æ¥serverï¼Œè®¤è¯æˆåŠŸåå³å¯é€šè¿‡WebSocketè·å–æœåŠ¡ç«¯æ¨é€çš„æ¶ˆæ¯ï¼Œä»¥åŠè°ƒç”¨å¯¹åº”çš„æœåŠ¡ç«¯APIã€‚</p>
<img src="/images/2022-02-17-Mattermost-auto-reply-tool/connect to server.drawio.png" width="70%" height="70%" alt="Connect to Server">

<h3 id="Event-Handle"><a href="#Event-Handle" class="headerlink" title="Event Handle"></a>Event Handle</h3><p>WebSocketè¿æ¥åï¼Œæ¥æ”¶serveræ¨é€çš„eventï¼Œå†ä¾æ®å…·ä½“ä¸šåŠ¡é€»è¾‘é€‰æ‹©ä¸åŒçš„eventå¤„ç†æ–¹å¼ã€‚</p>
<p>è¿™å¥—eventæœºåˆ¶å®é™…ä¸Šæä¾›äº†ä¸€ä¸ªæ–¹ä¾¿çš„åŠŸèƒ½å¼€å‘çš„æ¡†æ¶ï¼Œå¯¹åº”çš„åŠŸèƒ½æ³¨å†Œå¯¹ç‰¹å®ševentçš„handlerï¼Œå½“eventè§¦å‘åï¼Œè°ƒç”¨æ³¨å†Œçš„æ‰€æœ‰handlerå³å¯å®ç°ä¸åŒçš„åŠŸèƒ½ã€‚ä¸è¿‡ç›®å‰åªæœ‰ä¸€ä¸ªè‡ªåŠ¨å›å¤çš„åŠŸèƒ½ï¼Œæˆ–è€…è¯´è‡ªåŠ¨å›å¤åªæ˜¯ä¸€ä¸ªç‰¹å®šçš„postç±»å‹çš„event handlerã€‚</p>
<img src="/images/2022-02-17-Mattermost-auto-reply-tool/event handle process.drawio.png" width="70%" height="70%" alt="Event Handle">

<h3 id="Auto-Reply"><a href="#Auto-Reply" class="headerlink" title="Auto Reply"></a>Auto Reply</h3><p>å¯¹è‡ªåŠ¨å›å¤è€Œè¨€ï¼Œåªéœ€å…³æ³¨postç±»å‹çš„eventå³å¯ï¼Œå®Œæ•´çš„eventç±»å‹å‚è€ƒ<a href="https://api.mattermost.com/#tag/WebSocket">APIæ–‡æ¡£</a>ã€‚é€šè¿‡å¯¹postç±»å‹çš„eventæ³¨å†Œhandlerï¼Œåœ¨eventè§¦å‘åè°ƒç”¨å¯¹åº”çš„å®ç°é€»è¾‘å®Œæˆè‡ªåŠ¨å›å¤åŠŸèƒ½ã€‚</p>
<img src="/images/2022-02-17-Mattermost-auto-reply-tool/event handler.drawio.png" width="70%" height="70%" alt="Post Event Handle">

<p>ç›®å‰å¯¹è‡ªåŠ¨å›å¤åŠŸèƒ½çš„è®¾è®¡ï¼Œæœ‰å¦‚ä¸‹åŠŸèƒ½ï¼š</p>
<ul>
<li>ä»…é™ç§èŠï¼šé€šè¿‡åˆ¤æ–­postæ‰€åœ¨channelä¸­çš„äººæ•°æ¥ç¡®å®šå½“å‰postæ˜¯å¦æ˜¯ä¸€æ¡ç§èŠæ¶ˆæ¯ï¼›</li>
<li>è‡ªåŠ¨å›å¤é—´éš”ï¼šå‡å°‘è‡ªåŠ¨å›å¤çš„é¢‘ç‡ï¼Œè®°å½•æ¯ä¸€ä¸ªä¼šè¯çš„è‡ªåŠ¨å›å¤å†å²ï¼Œåœ¨è‡ªåŠ¨å›å¤é—´éš”æœŸé—´çš„å¤šæ¬¡æ¶ˆæ¯æ¥æ”¶ä¸ä¼šè§¦å‘å¤šæ¬¡è‡ªåŠ¨å›å¤ï¼›</li>
<li>è‡ªåŠ¨å›å¤é—´éš”è°ƒæ•´ï¼šåœ¨æ¥æ”¶åˆ°ç‰¹å®šæ¶ˆæ¯åï¼Œè°ƒæ•´ä¸‹ä¸€æ¬¡è‡ªåŠ¨å›å¤çš„é—´éš”ä¸ºä¸€ä¸ªé¢„è®¾å€¼ï¼Œç”¨äºå»¶é•¿è‡ªåŠ¨å›å¤é—´éš”ã€‚</li>
</ul>
<p>äºæ˜¯ï¼Œåœ¨æ”¶åˆ°ç§èŠæ¶ˆæ¯ï¼Œä¸”å½“å‰æ—¶é—´ä¸ä¸Šä¸€æ¬¡è‡ªåŠ¨å›å¤çš„é—´éš”æ—¶é—´å¤§äºç”¨æˆ·é…ç½®çš„è‡ªåŠ¨å›å¤é—´éš”åï¼Œè§¦å‘è‡ªåŠ¨å›å¤çš„æ¡ä»¶ï¼Œé€šè¿‡APIå°†ç”¨æˆ·é¢„è®¾å¥½çš„è‡ªåŠ¨å›å¤æ¶ˆæ¯å‘é€åˆ°å¯¹åº”çš„channelã€‚</p>
<img src="/images/2022-02-17-Mattermost-auto-reply-tool/auto reply handler.drawio.png" width="70%" height="70%" alt="Auto Reply Handler">

<p><strong>ps.</strong> mattermostä¸­ï¼Œå¦‚æœç”¨æˆ·åœ¨æ¥æ”¶åˆ°æœªè¯»postçš„channelä¸­å‘é€äº†æ–°çš„postï¼Œå°†ä¼šæŠŠä¹‹å‰çš„æœªè¯»çŠ¶æ€æ¸…é™¤ï¼Œä½“ç°åœ¨webappä¸Šå°±æ˜¯æœªè¯»æç¤ºè¢«æ¸…é™¤äº†ã€‚æ‰€ä»¥è‡ªåŠ¨å›å¤çš„postå‘é€åï¼Œéœ€è¦å°†åŸæ¥çš„æœªè¯»postçŠ¶æ€é‡æ–°è®¾ç½®ä¸ºæœªè¯»ï¼Œé¿å…ä¸¢å¤±äº†ç”¨æˆ·çš„æœªè¯»æ¶ˆæ¯æé†’ã€‚</p>
<h3 id="Config-Update"><a href="#Config-Update" class="headerlink" title="Config Update"></a>Config Update</h3><p>åœ¨è‡ªåŠ¨å›å¤åŠŸèƒ½ä¸­ï¼Œæä¾›äº†ä¸€äº›å¯ä¾›ç”¨æˆ·é…ç½®çš„é€‰é¡¹ã€‚åœ¨å®é™…ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·å¯èƒ½ä¼šéœ€è¦åŠ¨æ€çš„è°ƒæ•´é…ç½®ï¼Œæœ€å¸¸è§çš„å°±æ˜¯è°ƒæ•´è‡ªåŠ¨å›å¤çš„å†…å®¹ã€‚ä¸ºäº†é¿å…æ¯ä¸€æ¬¡çš„é…ç½®è°ƒæ•´éƒ½éœ€è¦é‡å¯ç¨‹åºï¼Œè®¾è®¡äº†é…ç½®çš„æ›´æ–°çš„åŠŸèƒ½ï¼š</p>
<ol>
<li>å»ºç«‹ä¸€ä¸ªç¼“å­˜ç”¨äºæ¥æ”¶æ–°çš„ç”¨æˆ·é…ç½®ï¼›</li>
<li>æ¯ä¸€æ¬¡è‡ªåŠ¨å›å¤å³å°†è§¦å‘æ—¶æ£€æŸ¥ç¼“å­˜ï¼Œæ˜¯å¦æœ‰æ–°çš„ç”¨æˆ·é…ç½®ä¸‹å‘ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å…ˆæ›´æ–°é…ç½®å†è¿›è¡Œåç»­çš„è‡ªåŠ¨å›å¤ï¼›</li>
<li>æ›´æ–°é…ç½®æ—¶åªæ›´æ–°åˆæ³•å­˜åœ¨çš„å­—æ®µï¼Œè·³è¿‡å¯¹éæ³•å­—æ®µçš„æ›´æ–°ã€‚</li>
</ol>
<p>ä½¿ç”¨ç¼“å­˜çš„ç›®çš„æ˜¯ä¸ºäº†é¿å…é”çš„ä½¿ç”¨ï¼Œé…ç½®æ¶‰åŠå¤šä¸ªå­—æ®µï¼Œæ— æ³•åšåˆ°åŸå­æ›´æ–°ã€‚</p>
<img src="/images/2022-02-17-Mattermost-auto-reply-tool/config update.drawio.png" width="70%" height="70%" alt="Config Update">

<h3 id="GUI"><a href="#GUI" class="headerlink" title="GUI"></a>GUI</h3><blockquote>
<p>å‘½ä»¤è¡Œåˆä¸æ˜¯ä¸èƒ½ç”¨ï¼</p>
</blockquote>
<p>ç”¨æˆ·è‚¯å®šéƒ½å¸Œæœ›åº”ç”¨æ˜¯ç®€å•æ˜“ç”¨çš„ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰äººéƒ½ä¼šä½¿ç”¨ï¼Œæˆ–è€…èƒ½æ¥å—ä»…æ”¯æŒå‘½ä»¤è¡Œçš„å·¥å…·çš„ï¼Œä¸ºæ­¤éœ€è¦ä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªGUIç”¨äºäº¤äº’ã€‚</p>
<p>å¯¹æ¡Œé¢ç”¨æˆ·è€Œè¨€ï¼Œæä¾›GUIï¼Œæœ€å¼€å§‹æƒ³åˆ°çš„æ˜¯å¼€å‘ä¸€ä¸ªæ¡Œé¢åº”ç”¨ç¨‹åºã€‚è™½ç„¶Pythonç¡®å®æœ‰å¯¹åº”çš„å¼€å‘åŒ…ï¼Œå¦‚<a href="">PyQt</a>ã€<a href="">Tkinter</a>ç­‰ï¼Œä½†ç›´æ¥å¼€å‘æ¡Œé¢åº”ç”¨ç¨‹åºæ€»æ˜¯æœ‰ä¸€äº›å„ç§å„æ ·çš„å¼Šç«¯ï¼š</p>
<ul>
<li>å¼€å‘å·¥å…·çš„ä½¿ç”¨ï¼šä½¿ç”¨è¿™äº›å¯¹åº”çš„å¼€å‘åŒ…æœ‰ç€å¯¹åº”çš„å­¦ä¹ æˆæœ¬ï¼Œæ ¹æ®æˆ‘çš„Qtä½¿ç”¨ç»éªŒè€Œè¨€ï¼ŒQtçš„å®‰è£…ååˆ†è‡ƒè‚¿ï¼ŒPyQtåº”è¯¥ä¹Ÿå¥½ä¸åˆ°å“ªå»ï¼›</li>
<li>ä¸‘ï¼šæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼›</li>
<li>å‰åç«¯è€¦åˆï¼šè¿™ä¸ªå…¶å®æ˜¯æˆ‘ä¸ªäººçš„åŸå› ï¼Œå¼€å‘GUIæ—¶ï¼Œä½¿ç”¨å¯¹åº”è¯­è¨€çš„GUIå·¥å…·ï¼Œæ€»æ˜¯å°†å‰åç«¯ä»£ç è€¦åˆåœ¨ä¸€å—ï¼Œä¸åˆ©äºæ‰©å±•ã€‚</li>
</ul>
<p>æ‰€ä»¥ï¼Œè™½ç„¶åç«¯æ˜¯Pythonï¼Œå‰ç«¯æœªå¿…éœ€è¦ç›´æ¥ä½¿ç”¨Pythonå¼€å‘ã€‚æ¢å¥è¯è¯´ï¼Œä½ çš„æ¡Œé¢åº”ç”¨ç¨‹åºï¼Œåˆä½•å¿…ä¸€å®šæ˜¯ä¸€ä¸ªæ¡Œé¢åº”ç”¨ç¨‹åºå‘¢ï¼Ÿmattermostæœ¬èº«å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œæ¡Œé¢å®¢æˆ·ç«¯ä»…ä»…æ˜¯webæµè§ˆå™¨å†…æ ¸çš„ä¸€ä¸ªå°è£…ï¼Œè¿™ç§å‰åç«¯åˆ†ç¦»çš„å¥½å¤„æ˜¯åç«¯å¯ä»¥æä¾›ç›¸åŒçš„æ¥å£ï¼Œå‰ç«¯å¯ä»¥ä¾é è‡ªèº«ç‰¹ç‚¹å»å®ç°ï¼Œé¿å…äº†è€¦åˆã€‚</p>
<p>æ‰€ä»¥æœ€ç»ˆçš„å®ç°ä¸Šï¼Œä½¿ç”¨Pythonå®ç°äº†ä¸€ä¸ªwebæœåŠ¡å™¨ï¼Œå†ä½¿ç”¨HTMLç¼–å†™äº†ä¸€ä¸ªé¡µé¢ç”¨äºäº¤äº’ï¼Œå¥—ç”¨äº†ä¸€äº›CSSæ¨¡æ¿åï¼Œäº¤äº’æ•ˆæœè¿˜ä¸é”™ã€‚</p>
<img src="/images/2022-02-17-Mattermost-auto-reply-tool/web console.png" width="70%" height="70%" alt="Web Console">

<p>é™¤äº†ç”¨æˆ·ç™»é™†ã€é…ç½®æ›´æ–°ç­‰äº¤äº’ï¼Œè¿˜æœ‰ä¸€ç‚¹æ˜¯ï¼Œç”¨æˆ·å¦‚ä½•è¿è¡ŒwebæœåŠ¡å™¨ï¼Œå¦‚æœè¿˜æ˜¯ç›´æ¥é€šè¿‡å‘½ä»¤è¡Œæ‰§è¡ŒPythonçš„æ–¹å¼ï¼Œå¤šå°‘è¿˜æ˜¯æœ‰ç‚¹æã€‚ä¸ºæ­¤ï¼Œä½¿ç”¨<a href="https://github.com/pyinstaller/pyinstaller">PyInstaller</a>å°†è„šæœ¬ã€èµ„æºæ–‡ä»¶å’Œè§£é‡Šå™¨å°è£…æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶ä¸ºå…¶è®¾ç½®äº†ä¸€ä¸ªå›¾æ ‡ï¼Œè¿™æ ·ä¸€æ¥ç”¨æˆ·å¯ä»¥é€šè¿‡ç›´æ¥è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶çš„æ–¹å¼å»è¿è¡Œå·¥å…·ï¼ˆä¸è¿‡PyInstalleræ‰“åŒ…æ—¶ä¼šä¾èµ–ä¸€äº›å¹³å°ç‰¹å®šçš„åŠ¨æ€åº“ï¼Œè¿™éƒ¨åˆ†ä¸æ˜¯å¾ˆé€šç”¨ï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Šå¯èƒ½éœ€è¦é‡æ–°æ‰“åŒ…ï¼‰ã€‚</p>
<p>åŒæ—¶è¿˜ä½¿ç”¨äº†<a href="https://github.com/moses-palmer/pystray">PyStray</a>ä¸ºå·¥å…·åˆ›å»ºäº†ä¸€ä¸ªæ‰˜ç›˜å›¾æ ‡ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç‚¹å‡»å›¾æ ‡çš„æ–¹å¼æ‰“å¼€webé¡µé¢è¿›è¡Œäº¤äº’ï¼ŒåŒæ—¶å¯ä»¥é€šè¿‡å›¾æ ‡æ¥é€€å‡ºç¨‹åºã€‚</p>
<img src="/images/2022-02-17-Mattermost-auto-reply-tool/tray.png" width="70%" height="70%" alt="Tray Icon">

<h3 id="Todo"><a href="#Todo" class="headerlink" title="Todo"></a>Todo</h3><ul>
<li>ç¾¤èŠçš„è‡ªåŠ¨å›å¤ï¼šåœ¨ç¾¤èŠæ”¶åˆ°çš„postä¸­ï¼Œä¾æ®ç‰¹å®šçš„è§¦å‘è¯ï¼Œå¦‚@ï¼Œè§¦å‘è‡ªåŠ¨å›å¤ï¼›</li>
<li>å†…å­˜æ¸…ç†ï¼šç›®å‰ä¸ºæ¯ä¸€ä¸ªè§¦å‘è¿‡è‡ªåŠ¨å›å¤çš„channelåˆ›å»ºä¸€æ¡è®°å½•ï¼Œæ¯è§¦å‘ä¸€æ¬¡è‡ªåŠ¨å›å¤å°†ä¼šæ›´æ–°å…¶ä¸­çš„æœ€åä¸€æ¬¡è‡ªåŠ¨å›å¤çš„æ—¶é—´ã€‚ç†è®ºä¸Šæœ€ç³Ÿç³•çš„åœºæ™¯æ˜¯ï¼Œä¸€ç›´æœ‰æ–°çš„ç§èŠè§¦å‘è‡ªåŠ¨å›å¤ï¼Œä¸”è§¦å‘è‡ªåŠ¨å›å¤åï¼Œä¸å†æœ‰ä»»ä½•æ¶ˆæ¯ã€‚è¿™ä¼šå¯¼è‡´è®°å½•ä¸€ç›´å¢é•¿å¾—ä¸åˆ°é‡Šæ”¾ï¼Œæ‰€ä»¥éœ€è¦æœ‰æœºåˆ¶å»æ¸…ç†ç†è®ºä¸Šå¯èƒ½æ— é™å¢é•¿çš„å†…å­˜è®°å½•ï¼›</li>
<li>ä¼˜åŒ–è‡ªåŠ¨å›å¤æ¡ä»¶ï¼šç›®å‰ä½¿ç”¨è‡ªåŠ¨å›å¤é—´éš”æ¥åˆ¤æ–­æ˜¯å¦ç¬¦åˆè‡ªåŠ¨å›å¤çš„æ¡ä»¶ï¼Œä½†å…¶å®å¯ä»¥ä½¿ç”¨å½“å‰channelçš„å†å²æœ€åä¸€æ¡postçš„æ—¶é—´æ¥åˆ¤æ–­ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸€å®šçš„å†…å­˜ä½¿ç”¨ï¼ŒåŒæ—¶å°†ç”¨æˆ·è‡ªå·±å‘å‡ºçš„æ¶ˆæ¯ï¼Œä¹ŸåŠ å…¥åˆ¤æ–­æ¡ä»¶ä¸­ï¼Œé¿å…äº†ç”¨æˆ·ä¸»åŠ¨å‘é€æ¶ˆæ¯ï¼ŒåŒæ—¶æ”¶åˆ°å›å¤åï¼Œåœ¨è‡ªåŠ¨å›å¤é—´éš”æ»¡è¶³æ¡ä»¶çš„æƒ…å†µä¸‹è‡ªåŠ¨å›å¤çš„åœºæ™¯ï¼ˆè¿™ç§ä¸»åŠ¨å‘èµ·ä¼šè¯ï¼Œåœ¨å›å¤é—´éš”ç¬¦åˆæ¡ä»¶æ—¶ä¹Ÿä¸åº”è¯¥è‡ªåŠ¨å›å¤ï¼‰ï¼›</li>
<li>è¿›ç¨‹é€€å‡ºçš„èµ„æºå›æ”¶ï¼šç›®å‰åŠŸèƒ½å•ä¸€ï¼Œä¸è¿›è¡Œèµ„æºå›æ”¶ä¹Ÿæ²¡æœ‰å¤ªå¤§é—®é¢˜ï¼Œä¸è¿‡åˆç†çš„ä»£ç åº”è¯¥è¦åšå¥½èµ„æºå›æ”¶å†é€€å‡ºç¨‹åºï¼Œé¿å…åç»­å› ä¸ºåŠŸèƒ½æ‰©å±•ï¼Œé€€å‡ºæ—¶éœ€è¦å›æ”¶èµ„æºçš„æ—¶å€™é‡æ–°å¤„ç†ï¼›</li>
<li>UIä»£ç ä¼˜åŒ–ï¼šç²¾ç®€ä¸€äº›æ— ç”¨çš„CSSå¼•ç”¨ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>Technology</category>
      </categories>
      <tags>
        <tag>For Fun</tag>
      </tags>
  </entry>
  <entry>
    <title>Travels of Martzki: Travel in Hangzhou in 2021</title>
    <url>/2022/02/07/Travel-in-Hangzhou-in-2021/</url>
    <content><![CDATA[<p>2021å¹´çš„æ¸…æ˜èŠ‚å‡æœŸï¼Œæ˜¯æˆ‘çš„ç¬¬ä¸€æ¬¡æ­å·æ—…è¡Œã€‚ä¸€æ˜¯æƒ³ä½“éªŒä¸‹æ­å·çš„æ¸…æ˜æ—¶èŠ‚ï¼Œæ¬£èµä¸‹è¥¿æ¹–ç¾æ™¯ï¼›äºŒæ˜¯äº²èº«æ„Ÿå—ä¸‹æ­å·ä½œä¸ºä¸€çº¿ITåŸå¸‚çš„æ°›å›´ã€‚  </p>
<span id="more"></span>
<h1 id="ä½"><a href="#ä½" class="headerlink" title="ä½"></a>ä½</h1><p>ç”±äºå‡æœŸæ¯”è¾ƒçŸ­ï¼Œæ‰€ä»¥é€‰æ‹©äº†ä½åœ¨è¥¿æ¹–é™„è¿‘ã€‚å…¶å®æœ€åˆæƒ³é€‰æ‹©æ¹–è¾¹çš„é…’åº—æˆ–è€…æ°‘å®¿ï¼Œä¸è¿‡ç”±äºé¢„è®¢çš„æ—¶é—´å’ŒğŸ’°çš„é—®é¢˜ï¼Œæœ€åé€‰æ‹©äº†å—é«˜å³°é™„è¿‘çš„æ°‘å®¿ã€‚<br>äº‹åè§‰å¾—ä½åœ¨è¥¿æ¹–é™„è¿‘çš„å†³å®šæ˜¯æ­£ç¡®çš„ï¼Œä¸€æ˜¯æœ¬èº«å‡æœŸçŸ­ï¼Œä¸»è¦æ¸¸ç©çš„åœ°æ–¹ä¹Ÿæ˜¯è¥¿æ¹–ï¼Œè·ç¦»ä¼šè¿‘ä¸€äº›ï¼›äºŒæ˜¯èŠ‚å‡æ—¥çš„æ­å·ï¼Œäº¤é€šçœŸæ˜¯å¤ªå µäº†ï¼Œç‰¹åˆ«æ˜¯è¥¿æ¹–æ™¯åŒºé™„è¿‘ï¼Œæ‰“è½¦éå¸¸å›°éš¾ã€‚</p>
<h1 id="è¡Œ"><a href="#è¡Œ" class="headerlink" title="è¡Œ"></a>è¡Œ</h1><p>å‡ºè¡Œæ–¹å¼ä¸»è¦æ˜¯æ‰“è½¦å’Œå…¬å…±äº¤é€šä¸ºä¸»ã€‚<br>æ­å·æœ‰åœ°é“ï¼Œä½†è¥¿æ¹–æ™¯åŒºé™„è¿‘æ²¡æœ‰ã€‚è¥¿æ¹–æ™¯åŒºé™„è¿‘ï¼Œå‡ºè¡Œæ–¹å¼çš„ä¾¿æ·åº¦ï¼šæ­¥è¡Œ &gt; å…±äº«å•è½¦ &gt; å…¬äº¤è½¦ &gt; æ‰“è½¦ã€‚<br>ä»æˆ‘ä»¬åœ¨è¥¿æ¹–æ™¯åŒºé™„è¿‘æ‰“è½¦çš„ç»éªŒæ¥çœ‹ï¼Œè¾ƒæ—©æˆ–è¾ƒæ™šçš„æ—¶å€™è¿˜æ˜¯å¯ä»¥æ‰“åˆ°è½¦çš„ï¼Œä½†æ˜¯ç™½å¤©ï¼Œç‰¹åˆ«æ˜¯åˆæ™šé¤æ—¶é—´ï¼Œæ‰“è½¦ååˆ†å›°éš¾ï¼Œè¿™ä¸ªæ—¶é—´ç‚¹ä¸»è¦é€‰æ‹©æ­¥è¡Œæˆ–å…±äº«å•è½¦ï¼Œä¸è¿‡é«˜å³°æœŸå…±äº«å•è½¦ä¹Ÿæ˜¯ä¸€è½¦éš¾æ±‚ã€‚<br>PS æ­å·çš„å‡ºç§Ÿè½¦å±äºæ¯”è¾ƒè€æ—§çš„ç‡ƒæ²¹æ±½è½¦ï¼Œä¹˜åä½“éªŒæ¯”è¾ƒå·®ï¼Œç”µåŠ¨è½¦çš„æ™®åŠç‡æ¯”è¾ƒä½ã€‚</p>
<h1 id="ç©"><a href="#ç©" class="headerlink" title="ç©"></a>ç©</h1><p>è¥¿æ¹–é™„è¿‘çš„ä¸»è¦æ¸¸ç©æ™¯ç‚¹å°±æ˜¯â€œè¥¿æ¹–åæ™¯â€ï¼Œè™½ç„¶é€šå¸¸è¿™äº›å®˜æ–¹æ¨èçš„æ™¯ç‚¹è´¨é‡è‰¯è ä¸é½ï¼Œä½†è¥¿æ¹–é™„è¿‘çš„æ¸¸ç©åŸºæœ¬ç¦»ä¸å¼€è¿™äº›æ™¯ç‚¹ã€‚<br>æ¹–è¾¹æ¸¸è§ˆçš„é¡ºåºåŸºæœ¬ä¸Šæ˜¯æ–­æ¡¥å‡ºå‘ï¼Œä¸€è·¯æ¸¸è§ˆæ™¯è‰²èµ°åˆ°è‹å ¤ã€‚</p>
<h2 id="é›·å³°å¡”"><a href="#é›·å³°å¡”" class="headerlink" title="é›·å³°å¡”"></a>é›·å³°å¡”</h2><p>è¥¿æ¹–åæ™¯ä¹‹ä¸€é›·å³°å¤•ç…§ä¸­çš„é›·å³°ï¼ŒæŒ‡çš„å°±æ˜¯é›·å³°å¡”ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ç™½è›‡ä¼ ä¸­ç™½å¨˜å­è¢«é•‡å‹çš„å®å¡”ã€‚<br>ä½†å®é™…ä¸Šï¼Œè¿™æ˜¯ä¸€ä¸ªæˆ‘ä¸ªäººä¸æ¨èçš„æ™¯ç‚¹ã€‚<br>é¦–å…ˆï¼Œç›®å‰çš„é›·å³°å¡”ç»å†äº†é‡å»ºï¼Œæœ€åˆçš„é›·å³°å¡”çš„æ–­å£æ®‹å£ï¼Œä¿ç•™åœ¨ç›®å‰çš„é›·å³°å¡”çš„åº•å±‚ï¼Œå¯ä¾›æ¸¸å®¢è¿œç¨‹è§‚èµï¼Œä¸è¿‡ä¹Ÿå°±æ˜¯ä¸€äº›ç –å—ç½¢äº†ï¼›<br>å…¶æ¬¡ï¼Œè¥¿æ¹–åæ™¯çš„é›·å³°å¤•ç…§ï¼ŒæŒ‡çš„æ˜¯å¤•é˜³è¥¿ä¸‹æ—¶ï¼Œé˜³å…‰ç…§åœ¨è¥¿æ¹–å’Œé›·å³°å¡”é™„è¿‘çš„æ™¯è‰²ã€‚é›·å³°å¡”æœ¬èº«ï¼Œå¡”å†…æ™¯è‰²éå¸¸æ™®é€šï¼Œç™»åˆ°æœ€é«˜å±‚ï¼Œå¯ä»¥çœºæœ›è¥¿æ¹–ï¼Œä¸è¿‡æ™¯è‰²ä¸€èˆ¬ï¼ˆå’Œåœ¨é»„é¹¤æ¥¼ä¸Šçœºæœ›é•¿æ±Ÿå·®ä¸å¤šä¸€ä¸ªæ„æ€ï¼‰ï¼›<br>æœ€åï¼Œè¿˜æ˜¯äººå¤šğŸ˜‘ã€‚<br><img src="/images/2022-02-07-Travel-in-Hangzhou-in-2021/IMG_2048.jpeg" width="70%" height="70%" alt="é›·å³°å¡”ä¸­çš„ç™½è›‡ä¼ æœ¨é›•"><br><img src="/images/2022-02-07-Travel-in-Hangzhou-in-2021/IMG_1502.jpeg" width="70%" height="70%" alt="é›·å³°å¡”"><br><img src="/images/2022-02-07-Travel-in-Hangzhou-in-2021/IMG_7644.jpeg" width="70%" height="70%" alt="é›·å³°å¡”ä¸Šçœºæœ›çš„è¥¿æ¹–æ™¯è‰²"></p>
<h2 id="æ–­æ¡¥"><a href="#æ–­æ¡¥" class="headerlink" title="æ–­æ¡¥"></a>æ–­æ¡¥</h2><p>è¥¿æ¹–åæ™¯ä¹‹ä¸€çš„æ–­æ¡¥æ®‹é›ªä¸­çš„æ–­æ¡¥ï¼Œæ˜¯æˆ‘ä»¬çš„è¥¿æ¹–æ¸¸è§ˆè¡Œç¨‹çš„èµ·ç‚¹ï¼ŒåŒæ ·ä¹Ÿæ˜¯è®¸å¤šäººçš„èµ·ç‚¹ï¼Œæ‰€ä»¥äººå¾ˆå¤šï¼Œå¦‚æœæƒ³è¦æ‹ç…§çš„è¯ï¼Œå¯ä»¥é€‰æ‹©æ—©ä¸€ç‚¹è¿‡å»ã€‚<br>ä¸è¿‡æ¸…æ˜å‡æœŸæ­å·æœ€ä½æ°”æ¸©åªæœ‰ååº¦å·¦å³ï¼Œæ¸…æ™¨çš„æ¹–è¾¹ï¼Œç‰¹åˆ«æ˜¯é˜´å¤©ï¼Œè¿˜æ˜¯éå¸¸å†·çš„ï¼Œéœ€è¦åšå¥½ä¸€å®šçš„å¾¡å¯’å‡†å¤‡ã€‚<br>æ­¤å¤–ï¼Œç™½å ¤è¿æ¥ç€é”¦å¸¦æ¡¥å’Œæ–­æ¡¥ï¼Œåœ¨æ¡¥ä¸Šæ‹ç…§æ—¶å¦‚æœæ–­æ¡¥äººå¤šå¯ä»¥è€ƒè™‘åœ¨é”¦å¸¦æ¡¥ä»£æ›¿ä¸‹ğŸ¤¡ã€‚  </p>
<h2 id="è¥¿æ¹–è‡ªåˆ’èˆ¹"><a href="#è¥¿æ¹–è‡ªåˆ’èˆ¹" class="headerlink" title="è¥¿æ¹–è‡ªåˆ’èˆ¹"></a>è¥¿æ¹–è‡ªåˆ’èˆ¹</h2><p>è¥¿æ¹–è¾¹æœ‰å¤šä¸ªåˆ’èˆ¹çš„åœæ³Šç‚¹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è‡³å°‘éœ€è¦ä¸¤ä¸ªäººï¼ŒåŒæ—¶å—æ¹–ä¸­é£æµªå½±å“ï¼Œé£æµªè¿‡å¤§æ—¶ï¼Œæ˜¯ä¸å…è®¸åˆ’èˆ¹çš„ã€‚å¦‚æœä¸€å®šè¦åˆ’èˆ¹çš„è¯ï¼Œéœ€è¦æå‰åšå¥½å‡†å¤‡ã€‚</p>
<h2 id="ä¸‰æ½­æ˜ æœˆ"><a href="#ä¸‰æ½­æ˜ æœˆ" class="headerlink" title="ä¸‰æ½­æ˜ æœˆ"></a>ä¸‰æ½­æ˜ æœˆ</h2><p>è¥¿æ¹–åæ™¯ä¹‹ä¸€ï¼Œ1å…ƒäººæ°‘å¸èƒŒé¢å–æ™¯åœ°ï¼Œä½äºè¥¿æ¹–ä¸­å¤®çš„æ¹–ä¸­å²›ã€‚ä¸Šä¸‹å²›éœ€è¦ä»è¥¿æ¹–è¾¹åèˆ¹ï¼Œæœ‰å¤šä¸ªç å¤´ï¼Œå¯ä»¥ä»ä¸åŒçš„ç å¤´ä¸Šä¸‹ã€‚<br>è™½ç„¶èŠ‚å‡æ—¥çš„æ­å·å“ªé‡Œéƒ½äººå¤šï¼Œä½†æ¹–ä¸­å²›çš„äººæ ¼å¤–çš„å¤šï¼Œå› ä¸ºå²›ä¸Šé¢ç§¯ä¸å¤§ï¼Œç¦»å¼€å²›ä¹Ÿéœ€è¦æ’é˜Ÿåèˆ¹ï¼Œæ‰€ä»¥å¯¼è‡´ç¦»å²›çš„é˜Ÿä¼å¾ˆé•¿ï¼Œä¸Šå²›å®¹æ˜“ç¦»å²›éš¾ã€‚<br>æœ¬èº«æ™¯ç‚¹ä¸»è¦æ˜¯å²›ä¸Šçš„ä¸€äº›å»ºç­‘å’Œæ¹–ä¸­çš„ä¸‰ä¸ªçŸ³å¡”ï¼Œæ™¯ç‚¹æœ¬èº«å·®å¼ºäººæ„ï¼Œä½†äººå®åœ¨æ˜¯å¤ªå¤šï¼Œå’Œäººç¾¤æ‘©è‚©æ¥è¸µå¤§å¤§é™ä½äº†æ¸¸è§ˆçš„å…´è‡´ã€‚<br><img src="/images/2022-02-07-Travel-in-Hangzhou-in-2021/IMG_6158.jpeg" width="70%" height="70%" alt="ä¸‰æ½­æ˜ æœˆä¸­çš„æ¹–ä¸­çŸ³å¡”å’Œé›·å³°å¡”"><br><img src="/images/2022-02-07-Travel-in-Hangzhou-in-2021/IMG_1452.jpeg" width="70%" height="70%" alt="å²›å†…æ™¯è‰²ï¼ˆä¸€ï¼‰"><br><img src="/images/2022-02-07-Travel-in-Hangzhou-in-2021/IMG_1295.jpeg" width="70%" height="70%" alt="å²›å†…æ™¯è‰²ï¼ˆäºŒï¼‰"><br><img src="/images/2022-02-07-Travel-in-Hangzhou-in-2021/IMG_1913.jpeg" width="70%" height="70%" alt="å²›å†…æ™¯è‰²ï¼ˆä¸‰ï¼‰"><br><img src="/images/2022-02-07-Travel-in-Hangzhou-in-2021/IMG_6983.jpeg" width="70%" height="70%" alt="å²›ä¸Šç å¤´æ’é˜Ÿçš„æ¸¸å®¢"></p>
<h2 id="çµéšå¯º"><a href="#çµéšå¯º" class="headerlink" title="çµéšå¯º"></a>çµéšå¯º</h2><p>çµéšå¯ºæ˜¯è¥¿æ¹–æ™¯åŒºçš„æ¯”è¾ƒæœ‰åçš„å¯ºåº™äº†ï¼Œå¯ºåº™æœ¬èº«ä¸å°ï¼Œä¾å±±è€Œå»ºã€‚ä¸è¿‡æˆ‘æœ¬äººå¯¹å¯ºåº™ç›¸å…³çš„å®—æ•™æ–‡åŒ–ä¸æ„Ÿå†’ï¼Œå¹¶ä¸”ç”±äºæˆ‘ä»¬å»çš„æ—¶å€™å‡ ä¹å·²ç»èµ°äº†ä¸€å¤©äº†ï¼Œéšä¾¿çœ‹äº†çœ‹æˆ‘å°±æ­‡èœäº†ğŸ¤¡ï¼Œå¹¶æ²¡æœ‰å»åˆ°æœ€é«˜çš„åº™å®‡ã€‚<br>å¦‚æœå¯¹å®—æ•™æ–‡åŒ–æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œæˆ–è€…å–œæ¬¢åˆ°å¤„æ‰“å¡çš„è¯ï¼Œå¯ä»¥ä¸€å»ï¼›å¦‚æœåƒæˆ‘ä¸€æ ·çš„è¯å°±ä¸å»ºè®®å»äº†ã€‚<br>å¦å¤–ï¼Œåœ¨çµéšå¯ºå¯ä»¥ä¹˜åç´¢é“å»åŒ—é«˜å³°ï¼Œä½†æ˜¯ç´¢é“å¼€æ”¾æ—¶é—´æœ‰é™åˆ¶ï¼Œä¸”åŒ—é«˜å³°ä¸å±äºçµéšå¯ºçš„èŒƒå›´ï¼Œå¯æ ¹æ®ä¸ªäººæƒ…å†µé€‰æ‹©ã€‚<br><img src="/images/2022-02-07-Travel-in-Hangzhou-in-2021/IMG_6106.jpeg" width="70%" height="70%" alt="çµéšå¯º"></p>
<h2 id="æ¨å…¬å ¤"><a href="#æ¨å…¬å ¤" class="headerlink" title="æ¨å…¬å ¤"></a>æ¨å…¬å ¤</h2><p>æ¨å…¬å ¤è¯´æ˜¯å’Œè‹å ¤ç™½å ¤é½åï¼Œä½†å®é™…ä¸Šæ¸¸å®¢æ¯”çƒ­é—¨çš„é‚£äº›æ™¯ç‚¹è¦å°‘å¤šäº†ï¼Œæˆ‘ä»¬å»çš„æ—¶å€™ç”šè‡³æ²¡æœ‰ä»€ä¹ˆäººã€‚è¿™é‡Œçš„æ ‘æ—ç¯å¢ƒå¾ˆå¥½ï¼Œå¾ˆæ”¾æ¾ï¼Œæ—¶é—´ä¸æ€¥çš„è¯å¯ä»¥æ¥è¿™é‡Œæ•£æ•£æ­¥ã€‚<br><img src="/images/2022-02-07-Travel-in-Hangzhou-in-2021/IMG_1974.jpeg" width="70%" height="70%" alt="æ¨å…¬å ¤æ¹–è¾¹"></p>
<h2 id="ä¹æºªåå…«æ¶§"><a href="#ä¹æºªåå…«æ¶§" class="headerlink" title="ä¹æºªåå…«æ¶§"></a>ä¹æºªåå…«æ¶§</h2><p>ä¹æºªåå…«æ¶§æ˜¯ä¸€æ¡æ¼«é•¿çš„å±±è·¯ï¼Œä¸€è·¯ä¸Šå›´ç»•ç€é«˜è€¸çš„æ ‘æ—ï¼Œæ—¶ä¸æ—¶çš„è¿˜æœ‰ä¸€äº›èŒ¶å›­ï¼Œè·¯è¿‡æ‘è½æ—¶å„å®¶å„æˆ·ä¹Ÿåœ¨å”®å–è‡ªå®¶çš„èŒ¶å¶ã€‚éšç€äº¤é”™çš„æºªæ¶§ï¼Œä»é¾™äº•ä¸€è·¯ä¸‹å±±ï¼Œæœ€ç»ˆå¯ä»¥ç›´æ¥åˆ°è¾¾é’±å¡˜æ±Ÿè¾¹ï¼Œè™½ç„¶ä¸åœ¨è¥¿æ¹–è¾¹ï¼Œä¸è¿‡æ˜¯ä¸€ä¸ªæ˜¯ä¸€ä¸ªæ•£æ­¥çš„å¥½åœ°æ–¹ï¼Œæ¸¸å®¢ä¹Ÿä¸å¤šï¼ŒåŒæ—¶å°½ç®¡æ•´ä¸ªæ™¯åŒºæœ‰ç€ä¸è®¡å…¶æ•°çš„æºªæ¶§ï¼Œå¾—ç›Šäºæ™¯åŒºçš„å·¥ä½œäººå‘˜çš„åƒåœ¾æ‰“æï¼Œæ°´å¾ˆå¹²å‡€ã€‚<br><img src="/images/2022-02-07-Travel-in-Hangzhou-in-2021/IMG_6103.jpeg" width="70%" height="70%" alt="ä¹æºªåå…«æ¶§"></p>
<h2 id="èŒ¶å¶åšç‰©é¦†"><a href="#èŒ¶å¶åšç‰©é¦†" class="headerlink" title="èŒ¶å¶åšç‰©é¦†"></a>èŒ¶å¶åšç‰©é¦†</h2><p>èŒ¶å¶åšç‰©é¦†æœ€åˆæ˜¯åœ¨è¡Œç¨‹è®¡åˆ’ä¹‹ä¸­çš„ï¼Œåæ¥ç”±äºæ—¶é—´ç´§è¿«ï¼ŒåŸæœ¬ä¸æ‰“ç®—å»äº†ï¼Œä½†æˆ‘ä»¬åœ¨ä¹˜åå…¬äº¤è½¦æ—¶ï¼Œé”™è¯¯åœ°æå‰äº†ä¸€ç«™ä¸‹è½¦ã€‚ä¸è¿‡æ²¡æƒ³åˆ°ä¸‹è½¦ä»¥åå‘ç°äº†ä¸€å¤§ç‰‡èŒ¶å›­ï¼Œä»”ç»†ä¸€çœ‹å±…ç„¶å°±æ˜¯ä¹‹å‰è®¡åˆ’å»çš„èŒ¶å¶åšç‰©é¦†ã€‚<br>æˆ‘ä»¬åˆ°è¾¾çš„æ—¶å€™å·²ç»æ˜¯æ™šé¥­æ—¶é—´äº†ï¼Œæ•´ä¸ªèŒ¶å›­å‡ ä¹æ²¡ä»€ä¹ˆäººï¼Œéå¸¸é€‚åˆæ‹ç…§ã€‚å…³äºåšç‰©é¦†å†…éƒ¨ï¼Œç”±äºæ˜¯èŠ‚å‡æ—¥ï¼ŒåŒæ—¶ä¹Ÿåˆ°äº†æ™šé¥­æ—¶é—´ï¼Œå°±æ²¡æœ‰è¿›å»æ¸¸è§ˆäº†ã€‚å¦‚æœå¯¹åšç‰©é¦†å†…éƒ¨æœ‰å…´è¶£ï¼Œå¯ä»¥æå‰å’¨è¯¢ä¸‹å¼€æ”¾æ—¶é—´ã€‚<br><img src="/images/2022-02-07-Travel-in-Hangzhou-in-2021/IMG_2259.jpeg" width="70%" height="70%" alt="èŒ¶å¶åšç‰©é¦†çš„èŒ¶å›­"></p>
<h1 id="åƒ"><a href="#åƒ" class="headerlink" title="åƒ"></a>åƒ</h1><p>åœ¨æ­å·åƒäº†å‡ é¡¿æ­å¸®èœï¼Œé€šå¸¸éƒ½æœ‰ä¸œå¡è‚‰ã€é¾™äº•ç§‹è‘µä»€ä¹ˆçš„ï¼Œæœ€ä¸æ¨èçš„å°±æ˜¯è¥¿æ¹–é†‹é±¼ï¼Œè¿™ç©æ„åº”è¯¥99%çš„äººéƒ½ä¸ä¼šè§‰å¾—å¥½åƒã€‚<br>æ­å·æœ‰ä¸€äº›å…¨å›½è¿é”çš„æ­å¸®èœçš„æ€»åº—ï¼Œåƒç»¿èŒ¶å’Œå¤–å©†å®¶ï¼Œå¦‚æœå–œæ¬¢è¿™äº›é¤å…ä¹Ÿå¯ä»¥å»è¯•è¯•å®ƒä»¬çš„æ€»åº—ã€‚</p>
<h2 id="æ²³åŠè¡—"><a href="#æ²³åŠè¡—" class="headerlink" title="æ²³åŠè¡—"></a>æ²³åŠè¡—</h2><p>æ²³åŠè¡—æ²¡ä»€ä¹ˆè¯´çš„ï¼Œå°±æ˜¯é‚£ç§æ¯ä¸ªæ—…æ¸¸åŸå¸‚éƒ½ä¼šæœ‰çš„é‚£ç§å……æ–¥ç€ä¹‰ä¹Œå°å•†å“ã€å‘ä¸€æ³¢å¤–åœ°æ¸¸å®¢å°±èµ°çš„å•†ä¸šè¡—ï¼Œç±»ä¼¼æ­¦æ±‰çš„æˆ·éƒ¨å··ï¼Œæä¸æ¨èã€‚</p>
<h2 id="æ˜¥å¤ç§‹å†¬"><a href="#æ˜¥å¤ç§‹å†¬" class="headerlink" title="æ˜¥å¤ç§‹å†¬"></a>æ˜¥å¤ç§‹å†¬</h2><p>å»è¿™å®¶é¤å…å…¶å®æ˜¯ä¸€ä¸ªå·§åˆï¼Œæˆ‘ä»¬å½“æ—¶åœ¨èŒ¶å¶åšç‰©é¦†æ¸¸è§ˆå®Œæˆåï¼Œå‡†å¤‡å‰å¾€æ°‘å®¿è€æ¿æ¨èçš„ä¸€å®¶æ­å¸®èœé¦†â€”â€”èŒ¶äººæ‘ï¼Œä½†åˆ°äº†é¤å…å‘ç°æ’é˜Ÿéå¸¸å¤¸å¼ ï¼Œè¿˜æœ‰å¾ˆå¤šæ—…æ¸¸å¤§å·´ä¹Ÿå¸¦ç€æ¸¸å®¢åœ¨è¿™é‡Œå°±é¤ã€‚è™½ç„¶é¤å…è£…ä¿®ä¸Šæœ‰ä¸€å®šçš„ç‰¹è‰²ï¼Œä½†æ•´ä¸ªé¤å…æœ‰ä¸€è‚¡æµ“æµ“çš„ç½‘çº¢é£ï¼ŒåŠ ä¸Šè¿‡é•¿çš„ç­‰å¾…æ—¶é—´ï¼Œæˆ‘ä»¬å°±æ¢åˆ°äº†éš”å£çš„æ˜¥å¤ç§‹å†¬ã€‚<br>é¤å…çš„ç¯å¢ƒä¸é”™ï¼Œèœå¼ä¹Ÿæ¯”è¾ƒæœ‰ç‰¹è‰²ï¼ˆç…§ç‰‡ä¸çŸ¥é“å’‹çš„æ²¡äº†ğŸ¤¡ï¼‰ï¼Œè¿˜æœ‰å®¤å¤–é¤ä½ï¼Œä¸è¿‡å½“æ—¶æ­å·çš„å¤©æ°”è¿˜æ˜¯æ¯”è¾ƒå‡‰çš„ï¼Œä¹Ÿæ²¡æœ‰äººé€‰æ‹©å®¤å¤–å°±é¤ã€‚æ•´ä½“çš„æœåŠ¡è´¨é‡ä¹Ÿè¿˜ä¸é”™ï¼Œæœ€é‡è¦çš„æ˜¯ä¸æ€ä¹ˆéœ€è¦æ’é˜Ÿã€‚</p>
<h2 id="Doux-Amour"><a href="#Doux-Amour" class="headerlink" title="Doux Amour"></a>Doux Amour</h2><p>è¿™å®¶å…¶å®ä¸æ˜¯æ­å¸®èœï¼Œè€Œæ˜¯ä¸€å®¶ç½‘çº¢çš„åŠ¨ç‰©æ³¡èŠ™åº—ï¼Œ<a href="https://www.douxamour.com.au/">æ€»åº—</a>åº”è¯¥æ˜¯åœ¨æ¾³æ´²ï¼Œå›½å†…ä¼¼ä¹åªæœ‰æ­å·æœ‰åˆ†åº—ã€‚<br>åº—é‡Œçš„æ‰€æœ‰æ³¡èŠ™éƒ½æ˜¯å°åŠ¨ç‰©é€ å‹ï¼Œéå¸¸å¯çˆ±ã€‚ä½†æ˜¯æ³¡èŠ™æœ¬èº«ç”±äºä¿è´¨æœŸé—®é¢˜ï¼Œä¸å¤ªé€‚åˆå½“ä½œä¼´æ‰‹ç¤¼ï¼Œå»åƒä¸ªä¸‹åˆèŒ¶æ‹æ‹ç…§ç‰‡è¿˜æ˜¯ä¸é”™çš„ã€‚<br><img src="/images/2022-02-07-Travel-in-Hangzhou-in-2021/IMG_6276.jpeg" width="70%" height="70%" alt="Doux Amourçš„èœå•"><br><img src="/images/2022-02-07-Travel-in-Hangzhou-in-2021/IMG_6272.jpeg" width="70%" height="70%" alt="Doux Amourçš„åŠ¨ç‰©æ³¡èŠ™"></p>
<h2 id="å›½å®¾é¦†ç´«è–‡å…"><a href="#å›½å®¾é¦†ç´«è–‡å…" class="headerlink" title="å›½å®¾é¦†ç´«è–‡å…"></a>å›½å®¾é¦†ç´«è–‡å…</h2><p>çŸ¥ä¹ä¸Šçœ‹åˆ°çš„æ¨èï¼ŒåŸæ–‡ä¸­æåˆ°çŸ¥é“çš„äººå°‘ï¼Œå»çš„äººä¸å¤šï¼Œä¸è¿‡è¿™äº›å¹´ä¼°è®¡å„ç§å®‰åˆ©ç§è‰åï¼Œçœ‹åˆ°æ¨èæ…•åè€Œå»çš„äººä¹Ÿä¸å°‘äº†ã€‚<br>ç´«è–‡å…ä¸æ¥å—é¢„è®¢ï¼Œå¼€æ”¾æ—¶é—´åº”è¯¥æ˜¯ä¸‹åˆå››ç‚¹ã€‚æˆ‘ä»¬åœ¨å››ç‚¹å·¦å³åˆ°è¾¾ç´«è–‡å…é—¨å£ï¼Œè¢«å‘ŠçŸ¥å·²ç»äººæ»¡äº†ä¸å†æ¥å¾…ï¼Œä¸çŸ¥é“æ˜¯çœŸæ»¡äº†è¿˜æ˜¯è¢«å¤§ä½¬ä»¬é¢„å®šäº†ğŸ¤¡ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥è¯•ä¸€è¯•ã€‚</p>
]]></content>
      <categories>
        <category>Travel</category>
      </categories>
      <tags>
        <tag>Travel</tag>
      </tags>
  </entry>
  <entry>
    <title>Virtio feature negotiation from QEMU perspective</title>
    <url>/2022/02/06/Virtio-feature-negotiation-from-QEMU-perspective/</url>
    <content><![CDATA[<h1 id="QEMUä¸­çš„Virtio-featuresåå•†æµç¨‹"><a href="#QEMUä¸­çš„Virtio-featuresåå•†æµç¨‹" class="headerlink" title="QEMUä¸­çš„Virtio featuresåå•†æµç¨‹"></a>QEMUä¸­çš„Virtio featuresåå•†æµç¨‹</h1><p>ä¸‹é¢ä»¥virtio-netå¯¹æ¥vhost-netï¼ˆkernelï¼‰ä¸ºä¾‹ï¼Œåˆ†ææ•´ä¸ªVirtio featuresåå•†çš„è¿‡ç¨‹ã€‚</p>
<h2 id="vhost-net"><a href="#vhost-net" class="headerlink" title="vhost-net"></a>vhost-net</h2><p>vhost_netä½œä¸ºæè¿°åç«¯çš„æ•°æ®ç»“æ„ï¼Œä¸çœŸæ­£ä½¿ç”¨çš„åç«¯ï¼ˆvhost_user or vhost_netï¼‰å¯¹åº”ã€‚<br>æ¯ä¸ªvhost_netåŒ…å«ä¸€ä¸ªvhost_devï¼Œvhost_netçš„featureså®é™…å°±æ˜¯vhost_devçš„featuresï¼Œä¸featuresç›¸å…³çš„æˆå‘˜æœ‰ï¼š<code>features</code>ï¼Œ<code>acked_features</code>ï¼Œ<code>backend_features</code>å’Œ<code>protocol_features</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vhost_net</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vhost_dev</span> <span class="title">dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vhost_virtqueue</span> <span class="title">vqs</span>[2];</span></span><br><span class="line">    <span class="keyword">int</span> backend;</span><br><span class="line">    NetClientState *nc;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vhost_dev</span> &#123;</span></span><br><span class="line">â€¦â€¦</span><br><span class="line">    <span class="keyword">uint64_t</span> features;</span><br><span class="line">    <span class="keyword">uint64_t</span> acked_features;</span><br><span class="line">    <span class="keyword">uint64_t</span> backend_features;</span><br><span class="line">    <span class="keyword">uint64_t</span> protocol_features;</span><br><span class="line">â€¦â€¦</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h3 id="vhost-dev-features"><a href="#vhost-dev-features" class="headerlink" title="vhost_dev::features"></a>vhost_dev::features</h3><p>åœ¨<code>vhost_dev_init</code>ä¸­ï¼Œé€šè¿‡åç«¯å¯¹åº”çš„æ¥å£ï¼ˆioctl or unix socketï¼‰ï¼Œä»åç«¯è·å–åˆ°çš„åç«¯æ”¯æŒçš„featuresã€‚</p>
<h3 id="vhost-dev-acked-features"><a href="#vhost-dev-acked-features" class="headerlink" title="vhost_dev::acked_features"></a>vhost_dev::acked_features</h3><p>å‰ç«¯ä¾æ®ä»åç«¯è·å–çš„host featuresè¿›è¡Œåå•†ï¼Œåå•†å®ŒæˆåçœŸæ­£å‘åç«¯ä¼ é€’çš„featuresï¼ˆè¿‡æ»¤äº†åç«¯ä¸æ”¯æŒçš„featuresï¼‰ï¼Œå³åç«¯çœŸæ­£å·¥ä½œçš„featuresã€‚</p>
<h3 id="vhost-dev-backend-features"><a href="#vhost-dev-backend-features" class="headerlink" title="vhost_dev::backend_features"></a>vhost_dev::backend_features</h3><p>ä»å‘½åçœ‹æ˜¯æè¿°åç«¯çš„featuresï¼Œä½†å’Œfeatureså­—æ®µé‡å¤ã€‚vhost-netç›¸å…³çš„å®é™…ä»£ç è°ƒç”¨å¦‚ä¸‹ï¼š</p>
<ol>
<li>vhost_net_ack_features: åœ¨è®¾ç½®acked_featuresä¹‹å‰ï¼Œç”¨backend_featuresçš„å€¼ä¸ºacked_featuresåˆå§‹åŒ–ã€‚è¿™é‡Œacked_featuresä¸ºä½•ä¸åˆå§‹åŒ–ä¸º0ï¼Œä»QEMUå¼€å‘è€…çš„é‚®ä»¶è®¨è®ºçœ‹ï¼Œä¹‹å‰åœ¨åˆå§‹åŒ–0æ—¶ï¼Œacked_featuresåœ¨åœ¨æŸäº›æƒ…å†µä¸‹ä¼šè¢«åˆå§‹åŒ–ä¸ºunexpected valueï¼ˆThis will result an unexpected value of acked_features which may fail the features setting of vhost.ï¼‰ã€‚ä¸è¿‡åˆå§‹åŒ–ä¸ºbackend_featuresä¼¼ä¹åœ¨vdpaçš„åœºæ™¯ä¸‹æœ‰æ–°çš„é—®é¢˜ï¼Œä¸”é—®é¢˜ä»ç„¶openä¸­ï¼›<a href="https://bugs.launchpad.net/qemu/+bug/1924603">^1</a></li>
<li>vhost_net_init: åœ¨åç«¯ä¸ºvhost-netçš„æ¡ä»¶ä¸‹ï¼Œå¦‚æœåç«¯å¯¹åº”çš„tapè®¾å¤‡ä¸æ”¯æŒvnet_hdrï¼Œåˆ™backend_featuresä¸­çš„<code>VHOST_NET_F_VIRTIO_NET_HDR</code>è¢«ç½®ä½ï¼Œå¦åˆ™ä¸º0ï¼›</li>
<li>vhost_user_backend_init: åœ¨åç«¯ä¸ºvhost-userçš„æ¡ä»¶ä¸‹ï¼Œå¦‚æœåç«¯æ”¯æŒ<code>VHOST_USER_F_PROTOCOL_FEATURES</code>ï¼Œåˆ™backend_featuresä¸­çš„<code>VHOST_USER_F_PROTOCOL_FEATURES</code>è¢«ç½®ä½ã€‚</li>
</ol>
<p>æ­¤å¤–ï¼Œå†…æ ¸vhostä»£ç ä¸­å®šä¹‰äº†<code>VHOST_NET_BACKEND_FEATURES</code>ï¼Œå¯¹åº”çš„ioctlæ“ä½œä¸º<code>VHOST_GET_BACKEND_FEATURES</code>å’Œ<code>VHOST_SET_BACKEND_FEATURES</code>ï¼Œä¸è¿‡ç›®å‰QEMUä»£ç ä¸­æ²¡æœ‰è¿™ä¸¤ä¸ªioctlæ“ä½œå¯¹åº”çš„é€»è¾‘ã€‚</p>
<h3 id="vhost-dev-protocol-features"><a href="#vhost-dev-protocol-features" class="headerlink" title="vhost_dev::protocol_features"></a>vhost_dev::protocol_features</h3><p>åè®®çš„æ‰©å±•featuresã€‚ä¸ºäº†ä¿æŒå‘ä¸‹å…¼å®¹æ€§ï¼Œvhost-useråè®®æ–°å¢çš„featuresä½¿ç”¨protocol_featuresè¿›è¡Œæè¿°ï¼Œç”±<code>VHOST_USER_F_PROTOCOL_FEATURES</code>è¿›è¡Œæ§åˆ¶ï¼Œæ ‡è¯†protocol_featuresæ˜¯å¦ä½¿ç”¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VHOST_USER_F_PROTOCOL_FEATURES 30</span></span><br></pre></td></tr></table></figure>
<p>åœ¨vhost-netåœºæ™¯ä¸‹ï¼Œprotocol_featuresè¢«è®¾ç½®ä¸º0ã€‚</p>
<h2 id="virtio-net"><a href="#virtio-net" class="headerlink" title="virtio-net"></a>virtio-net</h2><p>virtio-netä½œä¸ºæè¿°åç«¯çš„æ•°æ®ç»“æ„ï¼Œä¸Guestçš„å‰ç«¯é©±åŠ¨ï¼ˆvirtio_netï¼‰å¯¹åº”ã€‚åœ¨QEMUä¸­ï¼Œç”¨VirtIONetæ¥æè¿°virtio-netï¼Œæ¯ä¸ªVirtIONetç»“æ„ä¸­åŒ…å«äº†å…¶å¯¹åº”çš„VirtIODeviceã€‚å…¶ä¸­ä¸featuresæœ‰å…³çš„æˆå‘˜æœ‰ï¼šVirtIONetçš„<code>host_features</code>ï¼ŒVirtIODeviceçš„<code>guest_features</code>ï¼Œ<code>host_features</code>å’Œ<code>backend_features</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VirtIONet</span> &#123;</span></span><br><span class="line">    VirtIODevice parent_obj;</span><br><span class="line">â€¦â€¦</span><br><span class="line">    <span class="keyword">uint64_t</span> host_features;</span><br><span class="line">â€¦â€¦</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VirtIODevice</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">â€¦â€¦</span><br><span class="line">    <span class="keyword">uint64_t</span> guest_features;</span><br><span class="line">    <span class="keyword">uint64_t</span> host_features;</span><br><span class="line">    <span class="keyword">uint64_t</span> backend_features;</span><br><span class="line">â€¦â€¦</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="VirtIONet-host-features"><a href="#VirtIONet-host-features" class="headerlink" title="VirtIONet::host_features"></a>VirtIONet::host_features</h3><p>ä»virtioè®¾å¤‡çš„è§’åº¦æ¥çœ‹ï¼ŒåªåŒºåˆ†Guestä¸Hostï¼Œå¹¶ä¸å…³å¿ƒHostçš„å…·ä½“å®ç°ã€‚æ‰€ä»¥VirtIONet::host_featuresä»£è¡¨äº†Hostç†è®ºå¯ä»¥æ”¯æŒçš„æ‰€æœ‰featuresã€‚</p>
<p>VirtIONet::host_featuresåœ¨<code>virtio_net_class_init</code>ä¸­ä½¿ç”¨QEMUä¸­virtio-netè®¾å¤‡çš„é»˜è®¤å±æ€§<code>virtio_net_properties</code>ï¼ˆå…¶ä¸­åŒ…å«äº†offloadç›¸å…³çš„featuresï¼‰æ¥åˆå§‹åŒ–ï¼ŒåŒæ—¶åœ¨æ¯ä¸ªvirtio-netè®¾å¤‡å®ä¾‹åŒ–æ—¶ï¼Œä¾æ®åç«¯è®¾å¤‡ï¼ˆe.g. tapï¼‰çš„é…ç½®ï¼Œå¯¹éƒ¨åˆ†featuresè¿›è¡Œè®¾ç½®ã€‚</p>
<p>VirtIONet::host_featureså”¯ä¸€çš„è°ƒç”¨å¤„åœ¨<code>virtio_net_get_features</code>ï¼Œå³å“åº”Guestå‰ç«¯é©±åŠ¨çš„get_featuresè¯·æ±‚ï¼ŒVirtIONet::host_featuresä½œä¸ºåˆå§‹å€¼ï¼Œåœ¨ä¸€ç³»åˆ—çš„è¿‡æ»¤åŠ¨ä½œåï¼Œå‘å‰ç«¯è¿”å›Hostæ‰€æ”¯æŒçš„featuresï¼ˆç»†èŠ‚è§ä¸‹æ–‡ï¼‰ã€‚</p>
<h3 id="VirtIODevice-host-features"><a href="#VirtIODevice-host-features" class="headerlink" title="VirtIODevice::host_features"></a>VirtIODevice::host_features</h3><p>VirtIODevice::host_featuresåœ¨<code>virtio_bus_device_plugged</code>ä¸­è°ƒç”¨å¯¹åº”virtioè®¾å¤‡çš„get_featuresè¿›è¡Œåˆå§‹åŒ–ï¼Œä¿å­˜çš„æ˜¯get_featuresçš„è¿”å›å€¼ï¼Œå³çœŸæ­£è¿”å›ç»™å‰ç«¯é©±åŠ¨çš„featuresã€‚</p>
<p><code>virtio_net_get_features</code>å‘å‰ç«¯è¿”å›featuresçš„é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ol>
<li>VirtIONet::host_featuresä½œä¸ºåˆå§‹featuresï¼›</li>
<li>å¦‚æœåç«¯è®¾å¤‡ï¼ˆe.g. tapï¼‰ä¸æ”¯æŒvnet_hdrï¼Œåˆ™å°†featuresä¸­å¯¹åº”çš„offload featureså–æ¶ˆç½®ä½ï¼›</li>
<li>QEMUå†…éƒ¨é¢„å®šä¹‰äº†åç«¯æ”¯æŒçš„feature_bitsï¼ˆkernel_feature_bits or user_feature_bitsï¼‰ï¼Œå°†feature_bitsæ”¯æŒä½†vhost_dev::featuresä¸­ä¸æ”¯æŒçš„bitåœ¨featuresä¸­å–æ¶ˆç½®ä½ï¼›</li>
<li>å¯¹<code>VIRTIO_NET_F_MTU</code>è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼ˆå’Œ<code>mtu_bypass_backend</code>æœ‰å…³ï¼Œå¯¹æ•´ä½“åå•†æµç¨‹ä¸é‡è¦ï¼‰ï¼›</li>
<li>å°†ä¸Šè¿°æµç¨‹ä¸­å¤„ç†åçš„featuresè¿”å›ç»™å‰ç«¯é©±åŠ¨ã€‚</li>
</ol>
<p>è¦æ³¨æ„VirtIODevice::host_featureså’ŒVirtIONet::host_featuresçš„åŒºåˆ«ï¼ŒVirtIONet::host_featuresæ˜¯Hostç†è®ºå¯ä»¥æ”¯æŒçš„æ‰€æœ‰featuresï¼Œè€ŒVirtIODevice::host_featuresæ˜¯å¯¹VirtIONet::host_featuresä¸­ä¾æ®åç«¯ã€è®¾å¤‡çš„è®¾ç½®è¿›è¡Œå¤„ç†åï¼ŒçœŸæ­£è¿”å›ç»™å‰ç«¯é©±åŠ¨çš„featuresã€‚</p>
<h3 id="VirtIODevice-guest-features"><a href="#VirtIODevice-guest-features" class="headerlink" title="VirtIODevice::guest_features"></a>VirtIODevice::guest_features</h3><p>Guestå‰ç«¯é©±åŠ¨ç”¨è‡ªèº«featureså’Œget_featureså¾—åˆ°çš„VirtIODevice::host_featuresè¿›è¡Œåå•†åï¼Œä¼ é€’ç»™QEMUï¼Œä¸VirtIODevice::host_featureså–äº¤é›†ï¼Œä¿å­˜å¾—åˆ°guest_featuresã€‚å³å‰åç«¯åœ¨Gueståå•†åå¾—åˆ°çš„featuresã€‚</p>
<h3 id="VirtIODevice-backend-features"><a href="#VirtIODevice-backend-features" class="headerlink" title="VirtIODevice::backend_features"></a>VirtIODevice::backend_features</h3><p>çœ‹ä»£ç è°ƒç”¨æ˜¯ä¸ºäº†ç‰¹æ®Šå¤„ç†<code>mtu_bypass_backend</code>ä¿å­˜çš„ï¼Œåœ¨<code>virtio_net_get_features</code>å¤„ç†æµç¨‹ä¸­ï¼Œç‰¹æ®Šå¤„ç†<code>VIRTIO_NET_F_MTU</code>å‰ä¿å­˜çš„featuresï¼Œé™¤äº†<code>VIRTIO_NET_F_MTU</code>å’ŒVirtIODevice::host_featuresæœ‰å·®å¼‚å¤–ï¼Œå…¶ä»–ä¸€è‡´ã€‚</p>
<h2 id="QEMUæ­£å¸¸å¯åŠ¨æµç¨‹ä¸­çš„featuresåå•†"><a href="#QEMUæ­£å¸¸å¯åŠ¨æµç¨‹ä¸­çš„featuresåå•†" class="headerlink" title="QEMUæ­£å¸¸å¯åŠ¨æµç¨‹ä¸­çš„featuresåå•†"></a>QEMUæ­£å¸¸å¯åŠ¨æµç¨‹ä¸­çš„featuresåå•†</h2><p>QEMUæ­£å¸¸å¯åŠ¨æµç¨‹ä¸­ï¼Œä»å¼€å§‹è¿è¡Œåˆ°GuestOSå¯åŠ¨çš„RunStateçš„å˜åŒ–ï¼š<code>preconfig</code>-&gt;<code>prelaunch</code>-&gt;<code>running</code>ã€‚</p>
<p>ä¸Šè¿°RunStateå˜åŒ–è¿‡ç¨‹ä¸­ï¼Œvirtioè®¾å¤‡çš„featuresç›¸å…³æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>preconfig: <code>qemu_init</code>-&gt;<code>net_init_clients</code>-&gt;â€¦â€¦-&gt;<code>net_init_tap</code>-&gt;â€¦â€¦-&gt;<code>vhost_net_init</code>ï¼Œåˆå§‹åŒ–tapå’Œvhost_devã€‚å…¶ä¸­vhost_devåˆå§‹åŒ–æ—¶ï¼Œè°ƒç”¨åç«¯å¯¹åº”çš„æ¥å£ï¼Œè·å–åç«¯æ”¯æŒçš„æ‰€æœ‰featuresï¼Œç”¨æ¥åˆå§‹åŒ–<code>vhost_dev::features</code>ï¼ŒåŒæ—¶ä¾æ®å¯¹ç«¯è®¾å¤‡ï¼ˆtapï¼‰æ”¯æŒçš„ç‰¹æ€§ï¼Œåˆå§‹åŒ–<code>vhost_dev::backend_features</code>ï¼Œä»¥åŠåˆå§‹åŒ–<code>vhost_dev::protocol_features</code>ä¸º0ï¼›</li>
<li>prelaunch: è°ƒç”¨<code>virtio_bus_device_plugged</code>ï¼Œé€šè¿‡å¯¹åº”è®¾å¤‡ç±»å‹çš„get_featuresï¼Œåˆå§‹åŒ–<code>VirtIODevice::host_features</code>ï¼›</li>
<li>running: <ul>
<li>GuestOSå¯åŠ¨ï¼Œå†…éƒ¨virtio_neté©±åŠ¨è¢«åŠ è½½ï¼Œè°ƒç”¨<code>virtio_dev_probe</code>-&gt;â€¦â€¦-&gt;<code>vp_get_features</code>è·å–è®¾å¤‡çš„featuresï¼Œå³QEMUä¾§çš„<code>VirtIODevice::host_features</code>ï¼Œå†ä¸è‡ªèº«é©±åŠ¨æ”¯æŒçš„featuresè¿›è¡Œåå•†ï¼Œåå•†å®Œæˆåè°ƒç”¨<code>virtio_finalize_features</code>-&gt;â€¦â€¦-&gt;<code>vp_set_features</code>å°†åå•†å¥½çš„featuresä¼ ç»™QEMUï¼›</li>
<li>æ­¤æ—¶å‘ç”ŸVM-EXITï¼ŒQEMUä¾§è°ƒç”¨<code>virtio_set_features</code>-&gt;â€¦â€¦-&gt;<code>virtio_net_set_features</code>-&gt;â€¦â€¦-&gt;<code>vhost_ack_features</code>ï¼ŒæŠŠå‰ç«¯é©±åŠ¨ä¼ é€’è¿‡æ¥çš„featureså’Œåç«¯å¯¹åº”feature_bitså…±åŒæ”¯æŒçš„bitç½®ä½ï¼Œå°†ç»“æœä¿å­˜åœ¨<code>vhost_dev::acked_features</code>ï¼›</li>
<li>GuestOSä¸­<code>virtio_finalize_features</code>-&gt;â€¦â€¦-&gt;<code>vp_set_features</code>æ‰§è¡Œå®Œæˆåï¼Œä¼šè®¾ç½®<code>VIRTIO_CONFIG_S_FEATURES_OK</code>ï¼Œè¿›è€Œè§¦å‘QEMUä¾§çš„å¯¹åº”è°ƒç”¨<code>virtio_set_status</code>-&gt;â€¦â€¦-&gt;<code>vhost_dev_start</code>ã€‚åœ¨<code>vhost_dev_start</code>ä¸­ï¼Œè°ƒç”¨<code>vhost_dev_set_features</code>ï¼Œå°†å‰ç«¯åå•†å¥½çš„<code>vhost_dev::acked_features</code>é€šè¿‡åç«¯å¯¹åº”çš„æ¥å£ä¼ é€’åˆ°åç«¯ã€‚</li>
</ul>
</li>
</ol>
<h2 id="QEMUçƒ­è¿ç§»æµç¨‹ä¸­çš„featuresåå•†"><a href="#QEMUçƒ­è¿ç§»æµç¨‹ä¸­çš„featuresåå•†" class="headerlink" title="QEMUçƒ­è¿ç§»æµç¨‹ä¸­çš„featuresåå•†"></a>QEMUçƒ­è¿ç§»æµç¨‹ä¸­çš„featuresåå•†</h2><p>QEMUçƒ­è¿ç§»æµç¨‹ä¸­ï¼Œæºè™šæ‹Ÿæœºä»å¼€å§‹è¿è¡Œåˆ°è¿ç§»ç»“æŸçš„RunStateå˜åŒ–ï¼š<code>running</code>-&gt;<code>finish_migrate</code>-&gt;<code>postmigrate</code>ï¼›ç›®çš„è™šæ‹Ÿæœºä»å¼€å§‹è¿è¡Œåˆ°GuestOSå¯åŠ¨çš„RunStateçš„å˜åŒ–ï¼š<code>preconfig</code>-&gt;<code>inmigrate</code>-&gt;<code>running</code>ã€‚</p>
<h3 id="æºç«¯virtio-featuresåœ¨çƒ­è¿ç§»æµç¨‹ä¸­çš„å˜åŒ–"><a href="#æºç«¯virtio-featuresåœ¨çƒ­è¿ç§»æµç¨‹ä¸­çš„å˜åŒ–" class="headerlink" title="æºç«¯virtio featuresåœ¨çƒ­è¿ç§»æµç¨‹ä¸­çš„å˜åŒ–"></a>æºç«¯virtio featuresåœ¨çƒ­è¿ç§»æµç¨‹ä¸­çš„å˜åŒ–</h3><ol>
<li>running: æ­£å¸¸è¿è¡ŒçŠ¶æ€ï¼Œæ— ç›¸å…³æ“ä½œï¼›</li>
<li>finish_migrate: <code>virtio_save</code>ä¸­ä¿å­˜<code>VirtIODevice::guest_features</code>çš„ä½32bitï¼Œè¿ç§»åˆ°ç›®çš„ç«¯ã€‚</li>
</ol>
<h3 id="ç›®çš„ç«¯virtio-featuresåœ¨çƒ­è¿ç§»æµç¨‹ä¸­çš„å˜åŒ–"><a href="#ç›®çš„ç«¯virtio-featuresåœ¨çƒ­è¿ç§»æµç¨‹ä¸­çš„å˜åŒ–" class="headerlink" title="ç›®çš„ç«¯virtio featuresåœ¨çƒ­è¿ç§»æµç¨‹ä¸­çš„å˜åŒ–"></a>ç›®çš„ç«¯virtio featuresåœ¨çƒ­è¿ç§»æµç¨‹ä¸­çš„å˜åŒ–</h3><ol>
<li>preconfig: å’Œæ­£å¸¸å¯åŠ¨æµç¨‹ä¸€è‡´ï¼›</li>
<li>inmigrate: <ul>
<li>è°ƒç”¨<code>virtio_bus_device_plugged</code>ï¼Œé€šè¿‡å¯¹åº”è®¾å¤‡ç±»å‹çš„get_featuresï¼Œåˆå§‹åŒ–<code>VirtIODevice::host_features</code>ï¼›</li>
<li><code>virtio_load</code>-&gt;â€¦â€¦-&gt;<code>virtio_net_set_features</code>-&gt;â€¦â€¦-&gt;<code>vhost_ack_features</code>ï¼Œåœ¨<code>virtio_load</code>ä¸­æ¥æ”¶æºç«¯åå•†å®Œæˆçš„<code>VirtIODevice::guest_features</code>ï¼Œåœ¨<code>vhost_ack_features</code>ä¸­å°†æ¥æ”¶åˆ°çš„<code>VirtIODevice::guest_features</code>å’Œåç«¯å¯¹åº”feature_bitså…±åŒæ”¯æŒçš„bitç½®ä½ï¼Œå°†ç»“æœä¿å­˜åœ¨<code>vhost_dev::acked_features</code>ï¼›</li>
</ul>
</li>
<li>running: <code>qemu_main_loop</code>-&gt;<code>main_loop_wait</code>-&gt;â€¦â€¦-&gt;<code>vm_start</code>-&gt;â€¦â€¦-&gt;<code>virtio_set_features</code>ï¼Œä½¿ç”¨inmigrateè¿‡ç¨‹ä¸­è®¾ç½®å¥½çš„<code>vhost_net::acked_features</code>é€šè¿‡åç«¯å¯¹åº”çš„æ¥å£ä¼ é€’åˆ°åç«¯ã€‚</li>
</ol>
<h2 id="æ­£å¸¸å¯åŠ¨æµç¨‹å’Œçƒ­è¿ç§»æµç¨‹å¯¹æ¯”"><a href="#æ­£å¸¸å¯åŠ¨æµç¨‹å’Œçƒ­è¿ç§»æµç¨‹å¯¹æ¯”" class="headerlink" title="æ­£å¸¸å¯åŠ¨æµç¨‹å’Œçƒ­è¿ç§»æµç¨‹å¯¹æ¯”"></a>æ­£å¸¸å¯åŠ¨æµç¨‹å’Œçƒ­è¿ç§»æµç¨‹å¯¹æ¯”</h2><p>ç¡¬ä»¶è®¾å¤‡çš„åˆå§‹åŒ–æµç¨‹éƒ½ä¸€è‡´ï¼Œé™¤äº†PCIè®¾å¤‡çš„ä¸€äº›çŠ¶æ€ä¹Ÿæ˜¯é€šè¿‡è¿ç§»åˆå§‹åŒ–ä¹‹å¤–ï¼Œæœ€ä¸»è¦çš„åŒºåˆ«åœ¨äºçƒ­è¿ç§»æµç¨‹ä¸­çš„featuresåå•†è¿‡ç¨‹ï¼šåå•†å¿…é¡»çš„<code>VirtIODevice::guest_features</code>é€šè¿‡çƒ­è¿ç§»ä»æºç«¯è·å–ï¼Œåç«¯ç›´æ¥å’ŒQEMUè¿›è¡Œåå•†æµç¨‹ï¼›åå•†æµç¨‹æ§åˆ¶ä¸å†éœ€è¦å‰ç«¯é©±åŠ¨ä¿®æ”¹è®¾å¤‡statusï¼Œè€Œæ˜¯åœ¨QEMUçƒ­è¿ç§»æµç¨‹ä¸­è§¦å‘ã€‚å‰ç«¯é©±åŠ¨ä¸å‚ä¸ã€ä¸æ„ŸçŸ¥ï¼Œé¿å…äº†é‡æ–°åˆå§‹åŒ–ã€‚</p>
]]></content>
      <categories>
        <category>Technology</category>
      </categories>
      <tags>
        <tag>Virtualization</tag>
        <tag>Virtio/Vhost</tag>
      </tags>
  </entry>
  <entry>
    <title>Some attempts to connect to VDI</title>
    <url>/2022/02/06/Some-attempts-to-connect-to-VDI/</url>
    <content><![CDATA[<h1 id="Why-do-I-need-to-do-this"><a href="#Why-do-I-need-to-do-this" class="headerlink" title="Why do I need to do this"></a>Why do I need to do this</h1><p>å…¬å¸æä¾›VDIä½œä¸ºåŠå…¬ç¯å¢ƒï¼Œè¿œç¨‹åŠå…¬æ—¶ï¼Œéœ€è¦é€šè¿‡VPNå…ˆè¿æ¥åˆ°å…¬å¸å†…ç½‘ï¼Œå†ä»å†…ç½‘è¿æ¥åˆ°åŠå…¬VDIã€‚<br>å…¬å¸æä¾›äº†Macå’ŒWindowsçš„VPNå®¢æˆ·ç«¯ç”¨äºè¿æ¥åˆ°å†…ç½‘ï¼ŒæŒ‰ç†è¯´å®‰è£…å¹¶ä½¿ç”¨å…¬å¸æä¾›çš„å®¢æˆ·ç«¯è¿æ¥å†…ç½‘å³å¯ï¼Œä½†æ˜¯ä¹‹æ‰€ä»¥æ²¡æœ‰è¿™ä¹ˆåšæœ‰ä¸¤ä¸ªä¸»è¦åŸå› ï¼š    </p>
<ul>
<li>å…¬å¸æä¾›çš„VPNé…å¥—çš„è½¯ä»¶å¤ªè¿‡è‡ƒè‚¿ï¼›</li>
<li>å…¬å¸æä¾›çš„VDIå†…ç½®äº†è®¿é—®æ§åˆ¶è½¯ä»¶ï¼Œä¼šè®°å½•IMçš„èŠå¤©è®°å½•ç­‰ä¿¡æ¯ã€‚æ‹…å¿ƒVPNâ€œé™„èµ â€çš„è½¯ä»¶æˆ–è€…VPNæœ¬èº«ä¼šåšç±»ä¼¼çš„æ“ä½œğŸ™„ã€‚</li>
</ul>
<p>è¿™ç¯‡åšæ–‡ä¸»è¦è®°å½•ä¸‹æŠ˜è…¾è™šæ‹Ÿæ¡Œé¢ç¯å¢ƒçš„ä¸€äº›ç»å†ã€‚</p>
<span id="more"></span>

<h1 id="What-attempts-did-I-try"><a href="#What-attempts-did-I-try" class="headerlink" title="What attempts did I try"></a>What attempts did I try</h1><p>ç”±äºä¸Šé¢è¯´çš„åŸå› ï¼Œéœ€è¦åœ¨ä¸ªäººPCç¯å¢ƒä¹‹å¤–ï¼Œæä¾›ä¸€ä¸ªæ¡Œé¢ç¯å¢ƒç”¨äºè¿œç¨‹è¿æ¥åˆ°VDIã€‚<br>å†å»é…ç½®ä¸€å¥—ç‰©ç†æ¡Œé¢ç¯å¢ƒæ˜¾ç„¶æ˜¯ä¸ç°å®çš„ï¼Œæ‰€ä»¥ä¸»è¦å‘è™šæ‹Ÿæ¡Œé¢ç¯å¢ƒè€ƒè™‘ï¼š</p>
<ul>
<li>Windows Sandbox</li>
<li>Cloud Virtual Mechine</li>
<li>Reverse Proxy (frp)</li>
<li>MacOS Container</li>
</ul>
<h2 id="Windows-Sandbox"><a href="#Windows-Sandbox" class="headerlink" title="Windows Sandbox"></a>Windows Sandbox</h2><p><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-sandbox/windows-sandbox-overview">Windows Sandbox</a>æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é€‰æ‹©ï¼Œå®ƒæ˜¯Windowså†…ç½®çš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œåœ¨Windows 10çš„ä¸“ä¸š/ä¼ä¸šç‰ˆä¸­æ‰“å¼€é€‰é¡¹åå¯ä»¥ç›´æ¥å¯åŠ¨ã€‚<br>è¯¥æŠ€æœ¯å’Œé€šç”¨çš„è™šæ‹ŸåŒ–æŠ€æœ¯ä¸€æ ·ï¼Œå¯¹CPUçš„è™šæ‹ŸåŒ–ç‰¹æ€§ä¹Ÿæœ‰ä¸€å®šè¦æ±‚ï¼Œä¸è¿‡ä¸æ˜¯å¤ªè€çš„CPUåº”è¯¥éƒ½èƒ½å¤Ÿæ»¡è¶³è¦æ±‚ã€‚åœ¨æˆ‘ä¸ªäººçš„ç§»åŠ¨ç«¯4ä»£i7ã€8Gå†…å­˜çš„PCä¸Šï¼ŒWindows 10å’ŒWindows 11ä¸­ï¼ŒWindows Sandboxéƒ½æœ‰è¶³å¤Ÿå¥½çš„è¡¨ç°ã€‚å› ä¸ºå®ƒåªæ˜¯è™šæ‹Ÿäº†ä¸€å¥—è¿è¡Œç¯å¢ƒï¼ˆruntime environmentï¼‰ï¼Œåº”è¯¥æ˜¯WIndowsè‡ªå·±çš„å®¹å™¨åŒ–æŠ€æœ¯ã€‚ç›¸æ¯”äºç›´æ¥è¿è¡Œä¸€ä¸ªè™šæ‹Ÿæœºè€Œè¨€ï¼Œè½»é‡çš„å¤šï¼ŒåŒæ—¶å®ƒè¿˜æ”¯æŒGPUè™šæ‹ŸåŒ–ï¼Œä»å®é™…ä½¿ç”¨ä½“éªŒä¸Šæ¥çœ‹ï¼ŒSandboxçš„å¯åœéƒ½è¶³å¤Ÿå¿«ï¼ŒåŒæ—¶å›¾å½¢æ€§èƒ½å¯¹äºåŸºæœ¬åŠå…¬è¶³å¤Ÿä½¿ç”¨äº†ã€‚<br>ä½†å®ƒæœ‰ä¸ªæ˜æ˜¾çš„å¼Šç«¯ï¼šæ‰€æœ‰åœ¨Sandboxä¸­æ‰€åšä¿®æ”¹éƒ½ä¸ä¼šè¢«ä¿å­˜ï¼Œå°†ä¼šéšSandboxè¿›ç¨‹çš„é€€å‡ºä¸€å¹¶è¢«é”€æ¯ï¼ˆç±»ä¼¼äºåŠ äº†<code>--rm</code>å‚æ•°çš„dockerå®¹å™¨ğŸ¤¨ï¼‰ã€‚è¿™ä¸ªç‰¹æ€§æä¾›äº†ç»å¯¹çš„Sandboxç¯å¢ƒï¼Œä½†å’Œæˆ‘ä¸ªäººçš„ä½¿ç”¨åœºæ™¯ä¸Šå¹¶ä¸æ˜¯å®Œå…¨å¥‘åˆï¼Œæ¯æ¬¡éœ€è¦è¿æ¥VDIæ—¶éƒ½è¦å…¨æ–°å®‰è£…ä¸€æ•´å¥—çš„VPNè½¯ä»¶ï¼Œä¸è¿‡æ€»ä½“æ¥è¯´ä»ä½¿ç”¨éš¾åº¦å’Œä½¿ç”¨ä½“éªŒä¸Šæ¥è¯´ï¼Œè¿˜æ˜¯ç›¸å¯¹ä¸é”™çš„ã€‚<br>æ²¡æœ‰æœ€ç»ˆä½¿ç”¨è¿™ä¸ªæ–¹æ¡ˆçš„åŸå› ä¸»è¦æ˜¯å› ä¸ºæˆ‘çš„Windows PCåäº†ğŸ˜…ã€‚</p>
<h2 id="Cloud-Virtual-Mechine"><a href="#Cloud-Virtual-Mechine" class="headerlink" title="Cloud Virtual Mechine"></a>Cloud Virtual Mechine</h2><p>Windows PCåäº†ä»¥åï¼Œå¼€å§‹è½¬æˆ˜MacOSã€‚è™šæ‹Ÿæœºæ˜¯ä¸€ä¸ªå¸¸è§çš„èƒ½å¤Ÿæä¾›è™šæ‹Ÿæ¡Œé¢ç¯å¢ƒçš„æ–¹å¼ï¼Œç”±äºMacOSçš„è½¯ä»¶ç”Ÿæ€ï¼ˆä¸»è¦æ˜¯ğŸ’°çš„é—®é¢˜ï¼‰ï¼Œæ²¡æœ‰é€‰æ‹©ç›´æ¥åœ¨MacOSä¸Šè¿è¡Œè™šæ‹Ÿæœºï¼Œè½¬è€Œè€ƒè™‘å…¬æœ‰äº‘æä¾›çš„è™šæ‹ŸæœºæœåŠ¡ï¼Œæ­£å¥½çœ‹åˆ°è…¾è®¯äº‘æœ‰è½»é‡åº”ç”¨æœåŠ¡å™¨çš„ä¼˜æƒ ï¼Œä¸”æ”¯æŒWindowsç³»ç»Ÿï¼Œé‚é©¬ä¸Šä¸‹å•ã€‚<br>ä½†å½“çœŸæ­£ä½¿ç”¨è¿™ä¸ªè™šæ‹Ÿæœºæ—¶å‘ç°ï¼Œå…¬å¸æä¾›çš„VPNå®¢æˆ·ç«¯ä¸æ”¯æŒåœ¨Windows Serverå®‰è£…ï¼ˆåƒåœ¾ğŸ™ƒï¼‰ï¼ŒåŒæ—¶è¿™ä¸ªè½»é‡åº”ç”¨æœåŠ¡å™¨ä¸æ”¯æŒè‡ªè¡Œä¸Šä¼ é•œåƒå®‰è£…ç³»ç»Ÿï¼Œæ‰€ä»¥æ²¡æ³•ç›´æ¥é‡è£…æˆä¸ªäººç‰ˆçš„Windowsã€‚<br>ä½†ï¼Œä¹°éƒ½ä¹°äº†ï¼Œè¿˜æ˜¯æŠ˜è…¾ä¸‹å§ã€‚</p>
<h3 id="Nested-Virtualization"><a href="#Nested-Virtualization" class="headerlink" title="Nested Virtualization"></a>Nested Virtualization</h3><p>ç¬¬ä¸€ä¸ªå°è¯•æ˜¯è™šæ‹Ÿæœºï¼Œæ²¡é”™ï¼Œæ˜¯åœ¨1æ ¸2Gçš„è™šæ‹Ÿæœºä¸Šå†è·‘ä¸€ä¸ªWindowsè™šæ‹Ÿæœºã€‚<br>åŸºäºå¦‚æ­¤æ‹‰èƒ¯çš„ç¡¬ä»¶é…ç½®ï¼ŒHostå¿…ä¸å¯èƒ½é€‰Windowsäº†ï¼Œæ‰€ä»¥é‡è£…æˆäº†CentOSã€‚ç„¶åå°±æ˜¯supervisorçš„é€‰æ‹©ï¼Œå·¥ä½œä¸­ç”¨çš„æ¯”è¾ƒå¤šçš„æ˜¯QEMU-KVMï¼Œç›¸å¯¹æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œæ‰€ä»¥å°è¯•æ¢ç”¨Virutal Boxã€‚<br>è™½ç„¶<a href="https://www.virtualbox.org/">Virutal Box</a>æ˜¯Oracleä¸»å¯¼çš„å¼€æºé¡¹ç›®ï¼Œä½†å®˜ç½‘å°±ç»™äººä¸€ç§è´«ç©·çš„æ„Ÿè§‰ã€‚å®ƒä¸»è¦è¿è¡Œåœ¨æ¡Œé¢ç¯å¢ƒä¸Šï¼Œè™½ç„¶æä¾›äº†å‘½ä»¤è¡Œå·¥å…·VBoxManageï¼Œä½†åœ¨å‘½ä»¤è¡Œç¯å¢ƒä¸‹ä»ç„¶éœ€è¦å®‰è£…ä¸€äº›å¦‚QTç›¸å…³çš„ä¾èµ–åº“ã€‚ä¸å¹¸çš„æ˜¯åœ¨è§£å†³äº†ä¾èµ–é—®é¢˜ï¼Œé…ç½®å¥½è™šæ‹Ÿæœºåï¼Œä»ç„¶æ— æ³•å¯åŠ¨ï¼ŒæŠ¥é”™æ˜¯æ— æ³•å¯ç”¨ç¡¬ä»¶åŠ é€Ÿç‰¹æ€§ï¼ˆè…¾è®¯äº‘çš„è¿™ä¸ªè™šæ‹Ÿæœºä¸æ”¯æŒåµŒå¥—è™šæ‹ŸåŒ–ï¼‰ï¼Œåœ¨é…ç½®é‡Œå–æ¶ˆäº†æ‰€æœ‰ç¡¬ä»¶åŠ é€Ÿçš„é€‰é¡¹åï¼Œè¿˜æ˜¯æ— æ³•è§£å†³è¯¥é—®é¢˜ï¼ˆMacOSä¸Šçš„Virtual Boxä¹Ÿæ˜¯ä¸€å †BUGï¼‰ï¼Œæ— å¥ˆåªèƒ½æ”¾å¼ƒVirtual Boxã€‚<br>äºæ˜¯æ¢ç”¨QEMUï¼Œç›´æ¥ä½¿ç”¨yumå®‰è£…ï¼Œä½¿ç”¨libvirtè¿›è¡Œè™šæ‹Ÿæœºé…ç½®ï¼Œç”±äºä¸æ”¯æŒåµŒå¥—è™šæ‹ŸåŒ–ï¼ŒåŒæ ·æ²¡æ³•ä½¿ç”¨QEMU-KVMï¼Œåªèƒ½é€šè¿‡çº¯æ¨¡æ‹Ÿçš„CPUè¿è¡ŒGuestOSï¼Œè™½ç„¶èƒ½å¤Ÿè¿è¡Œï¼Œä½†æ˜¯å‡ ä¹å®Œå…¨æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œå¼€æœºéœ€è¦15minï¼Œå¼€æœºä¹‹åæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åˆ†é’Ÿçº§åˆ«çš„ï¼Œå°±æ˜¯æŠ˜è…¾æ¥ç©ç©ç½¢äº†ã€‚</p>
<h3 id="Dual-Operation-System"><a href="#Dual-Operation-System" class="headerlink" title="Dual Operation System"></a>Dual Operation System</h3><p>è¿™ä¸ªé…ç½®ä¸‹çš„åµŒå¥—è™šæ‹ŸåŒ–ä¹Ÿå°±å›¾ä¸€ä¹ï¼Œæ—¢ç„¶å®˜æ–¹ç»™çš„é•œåƒä¸åŒ…å«ä¸ªäººç‰ˆçš„Windowsï¼ŒåŒæ—¶ä¹Ÿä¸æ”¯æŒè‡ªå®šä¹‰ä¸Šä¼ é•œåƒï¼Œé‚£å°±é‡‡ç”¨å®‰è£…åŒç³»ç»Ÿçš„æ›²çº¿æ•‘å›½çš„æ–¹å¼ã€‚<br>å…ˆä½¿ç”¨åŸæœ‰åˆ†åŒºçš„ç©ºé—²ç©ºé—´åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†åŒºï¼Œå†å°†æ“ä½œç³»ç»Ÿé•œåƒä¸‹è½½åˆ°ç¡¬ç›˜ä¸Šï¼Œç›´æ¥ä»ç¡¬ç›˜è¿è¡Œå®‰è£…ç¨‹åºï¼Œå°†æ“ä½œç³»ç»Ÿå®‰è£…åˆ°æ–°çš„åˆ†åŒºä¸Šã€‚<br>ä¸ºäº†åœ¨1æ ¸2Gçš„æ‹‰èƒ¯é…ç½®ä¸Šå°½å¯èƒ½æµç•…åœ°è¿è¡ŒWindowsï¼Œä½¿ç”¨<a href="https://archive.org/details/Tiny7">Tiny7</a>ï¼ˆç²¾ç®€ç‰ˆçš„Windows 7ï¼‰ä½œä¸ºä½¿ç”¨çš„æ“ä½œç³»ç»Ÿï¼Œä½†é•œåƒå†…ä¸åŒ…å«Virtioé©±åŠ¨ï¼Œæ— æ³•ç»§ç»­å®‰è£…ã€‚ä¸‹è½½äº†å‡ ä¹æ‰€æœ‰ç‰ˆæœ¬çš„Virtioé©±åŠ¨åœ¨å®‰è£…æ—¶ä½¿ç”¨ï¼Œä½†å…¨éƒ½æ— æ³•å¥æ•ˆï¼Œæœ€åæ— å¥ˆæ¢ç”¨äº†<a href="https://archive.org/details/tiny-10_202105">Tiny10</a>ï¼ˆç²¾ç®€ç‰ˆçš„Windows 10ï¼‰ã€‚ä½¿ç”¨Tiny10åï¼Œåœ¨å®‰è£…æ—¶é€‰æ‹©ç¡¬ç›˜ä¸Šå·²æœ‰çš„Virtioé©±åŠ¨ï¼Œå³å¯å®Œæˆæ­£å¸¸å®‰è£…ã€‚<br>æµç•…åº¦ä¸Šæ¥è¯´å’Œè‡ªå¸¦çš„Windows Serverç›¸æ¯”æ²¡æœ‰æ˜æ˜¾å·®è·ï¼Œåœ¨è¿œç¨‹è¿æ¥ä¸ŠVDIåï¼Œç”±äºè‡ªèº«é…ç½®æ‹‰èƒ¯ï¼Œæµç•…åº¦ä¸€èˆ¬ã€‚ä¸”ç”±äºæ²¡æœ‰æ˜¾å¡ï¼Œåœ¨éœ€è¦å›¾å½¢æ¸²æŸ“çš„åœºæ™¯ä¸‹ï¼ˆå¦‚çª—å£åˆ‡æ¢ï¼‰ï¼Œå¡é¡¿æ˜æ˜¾ã€‚æ€»çš„æ¥è¯´å±äºå‹‰å¼ºå¯ç”¨çš„ç¨‹åº¦ï¼Œä½†å¥½å¤„æ˜¯æ— éœ€åœ¨è‡ªå·±çš„PCä¸Šè¿è¡Œè™šæ‹Ÿæœºã€‚  </p>
<h3 id="Windows-Container"><a href="#Windows-Container" class="headerlink" title="Windows Container"></a>Windows Container</h3><p><a href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/">Windows Container</a>æ˜¯è€ƒè™‘è¿‡çš„å¦ä¸€ä¸ªæŠ˜è…¾æ–¹å‘ï¼ŒWindowså®˜æ–¹æä¾›äº†<a href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/manage-containers/container-base-images">é•œåƒ</a>ï¼Œä½†åœ¨Windows Serverå®‰è£…Dockeræ—¶ï¼Œå§‹ç»ˆæœ‰é—®é¢˜æ— æ³•è§£å†³ï¼ŒåŒæ—¶Windowså®¹å™¨åªèƒ½ä½¿ç”¨å’ŒHostç›¸åŒçš„kernelï¼Œå¹¶ä¸”æ— æ³•æä¾›ä¸€ä¸ªåŸºäºå®¹å™¨çš„æ¡Œé¢ç¯å¢ƒï¼Œé‚æ”¾å¼ƒã€‚</p>
<h2 id="Reverse-Proxy-frp"><a href="#Reverse-Proxy-frp" class="headerlink" title="Reverse Proxy (frp)"></a>Reverse Proxy (frp)</h2><p>ä½¿ç”¨åå‘ä»£ç†ï¼ˆå¦‚<a href="https://github.com/fatedier/frp">frp</a>ï¼‰å°†Windowsè¿œç¨‹æ§åˆ¶æœåŠ¡æš´éœ²åˆ°å…¬ç½‘ä¹Ÿæ˜¯ä¸€ä¸ªå¯è¡Œæ–¹æ¡ˆï¼Œä½†ç»†èŠ‚ä¸Šæ²¡æœ‰é‚£ä¹ˆç®€å•ã€‚<br>ç”±äºåŠå…¬VDIæ˜¯å’Œå…¬ç½‘éš”ç¦»çš„ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥ä½¿ç”¨åå‘ä»£ç†ç›´æ¥è¿æ¥åˆ°åŠå…¬VDIã€‚ä½†å…¬å¸æä¾›äº†å¤–ç½‘VDIç”¨äºåœ¨åŠå…¬æ—¶è®¿é—®å…¬ç½‘ï¼Œå¯ä»¥ä½¿ç”¨åå‘ä»£ç†è¿æ¥åˆ°å¤–ç½‘VDIï¼Œå†åœ¨å¤–ç½‘VDIä¸­å®‰è£…è¿è¡ŒVPNå®¢æˆ·ç«¯ååå‘è¿æ¥åˆ°åŠå…¬VDIå†…ã€‚<br>è¿™ç§æ–¹æ¡ˆä¸‹çš„å¤–ç½‘VDIä»£æ›¿äº†è‡ªè´­çš„å…¬æœ‰äº‘è™šæ‹Ÿæœºï¼Œæ‹¥æœ‰æ›´é«˜çš„é…ç½®ï¼Œä½†åŒæ ·ä¸æ”¯æŒè™šæ‹Ÿæ˜¾å¡ï¼Œå›¾å½¢æ€§èƒ½ä»ç„¶æ‹‰èƒ¯ã€‚æŒ‰ç†è¯´å¯ä»¥æ›¿ä»£è‡ªè´­çš„å…¬æœ‰äº‘è™šæ‹Ÿæœºäº†ï¼Œä½†ç”±äºå®‰å…¨éƒ¨é—¨å®¡è®¡åˆ°frpæµé‡ï¼Œå‘ŠçŸ¥ä¸å…è®¸ä½¿ç”¨æ­¤ç±»åå‘ä»£ç†ï¼Œé‚æ”¾å¼ƒã€‚  </p>
<h2 id="MacOS-Container"><a href="#MacOS-Container" class="headerlink" title="MacOS Container"></a>MacOS Container</h2><p>åœ¨è€ƒè™‘è™šæ‹ŸåŒ–æ–¹æ¡ˆæ—¶ï¼Œè§‰å¾—è™šæ‹Ÿæœºæ¶ˆè€—è¿‡å¤§åï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°çš„å°±æ˜¯å®¹å™¨æŠ€æœ¯ã€‚å¦‚æœä½¿ç”¨å®¹å™¨æŠ€æœ¯èƒ½å¤Ÿæ»¡è¶³éœ€æ±‚ï¼Œé‚£å°±èƒ½å¤Ÿä½¿ç”¨ä¸€ä¸ªè½»é‡åŒ–çš„éš”ç¦»ç¯å¢ƒã€‚åœ¨æˆ‘åªæœ‰MacOSçš„å‰æä¸‹ï¼Œå¼€å§‹æŸ¥æ‰¾æ˜¯å¦æœ‰MacOSçš„å®¹å™¨åŒ–æ–¹æ¡ˆã€‚<br>å¹¸è¿çš„æ˜¯ï¼Œè¿˜çœŸæœ‰ä¸ªé¡¹ç›®<a href="https://github.com/sickcodes/Docker-OSX">Docker-OSX</a>ï¼Œä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¸ªé¡¹ç›®åŸºäºQEMU-KVMï¼Œè¯´ç™½äº†è¿˜æ˜¯è™šæ‹Ÿæœºé‚£ä¸€å¥—ï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯çœ‹äº†çœ‹è€Œå·²ã€‚</p>
<h1 id="What-did-I-chose-finally"><a href="#What-did-I-chose-finally" class="headerlink" title="What did I chose finally"></a>What did I chose finally</h1><p>ç”±äºä¸Šè¿°ç§ç§åŸå› ï¼Œæœ€ç»ˆçš„ä½¿ç”¨æ–¹æ¡ˆæ˜¯åœ¨å…¬æœ‰äº‘è‡ªè´­çš„è™šæ‹Ÿæœºä¸Šå®‰è£…çš„åŒç³»ç»Ÿä¸­ï¼Œè¿æ¥åˆ°è¿œç¨‹VDIã€‚<br>å¦‚æœæœ‰Windowsç¯å¢ƒçš„è¯ï¼Œè¿˜æ˜¯æ¨èä½¿ç”¨WIndows Sandboxï¼›MacOSç¯å¢ƒä¸‹ï¼Œå¦‚æœèƒ½å¤Ÿå®¹å¿è™šæ‹Ÿæœºçš„æ€§èƒ½æ¶ˆè€—çš„è¯ï¼Œè™šæ‹Ÿæœºåº”è¯¥æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„é€‰æ‹©ã€‚<br>ç›¸æ¯”ä¹‹ä¸‹ï¼Œåœ¨å…¬æœ‰äº‘ä¸Šçš„æ‹‰èƒ¯è™šæ‹Ÿæœºä¸­è¿æ¥åˆ°è¿œç¨‹VDIçš„æ–¹æ¡ˆå¹¶ä¸æ˜¯ä»€ä¹ˆç†æƒ³æ–¹æ¡ˆäº†ã€‚</p>
]]></content>
      <categories>
        <category>Technology</category>
      </categories>
      <tags>
        <tag>Virtualization</tag>
      </tags>
  </entry>
  <entry>
    <title>About Me</title>
    <url>/2022/01/09/About-Me/</url>
    <content><![CDATA[<blockquote>
<p>God, tell us the reason youth is wasted on the young.</p>
</blockquote>
<p>A coder mainly work on network virtualization dataplane development.<br>Email: <a href="mailto:&#109;&#x61;&#x72;&#115;&#49;&#52;&#56;&#53;&#48;&#64;&#103;&#x6d;&#97;&#105;&#x6c;&#x2e;&#99;&#111;&#x6d;">&#109;&#x61;&#x72;&#115;&#49;&#52;&#56;&#53;&#48;&#64;&#103;&#x6d;&#97;&#105;&#x6c;&#x2e;&#99;&#111;&#x6d;</a></p>
<img src="/images/avatar.JPG" width="40%" height="40%">]]></content>
      <categories>
        <category>Other</category>
      </categories>
      <tags>
        <tag>Other</tag>
      </tags>
  </entry>
</search>
